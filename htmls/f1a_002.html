<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BMK FlexiTimer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Leaflet.js for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --base-font: 3.8vw;
            --small-font: 3.4vw;
            --title-font: 5vw;
            --base-padding: 2vw;
            --base-margin: 2vw;
        }

        @media screen and (min-width: 768px) {
            :root {
                --base-font: 16px;
                --small-font: 14px;
                --title-font: 24px;
                --base-padding: 10px;
                --base-margin: 10px;
            }
        }

        body {
            background-color: #004;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0 var(--base-padding) var(--base-padding) var(--base-padding);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-size: var(--base-font);
        }

        h1 {
            color: #FFD700;
            text-align: center;
            font-size: var(--title-font);
            margin-bottom: var(--base-margin);
            margin-top: 0;
        }

        .section {
            margin-bottom: var(--base-margin);
            padding: var(--base-padding);
            border: 2px solid #fff;
            border-radius: calc(var(--base-padding) * 0.8);
        }

        .section-before-toggle {
            margin-bottom: 0;
        }

        .section h2 {
            color: #FFD700;
            margin: 0 0 var(--base-margin) 0;
            font-size: calc(var(--base-font) * 1.2);
            text-align: center;
        }

        label {
            display: block;
            font-size: var(--base-font);
            margin-bottom: calc(var(--base-margin) * 0.5);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: calc(var(--base-padding) * 0.8);
            font-size: var(--base-font);
            margin-bottom: var(--base-margin);
            border: none;
            border-radius: calc(var(--base-padding) * 0.5);
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .preset-buttons {
            display: flex;
            justify-content: space-between;
        }

        .preset-buttons button {
            width: 23%;
            padding: 10px;
            font-size: 16px;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        .timer-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .timer-row > div {
            flex: 0 0 48%;
        }

        .timer-row > div label {
            margin-bottom: 5px;
        }

        .timer-row > div input {
            width: 100%;
        }

        input[type="submit"] {
            background-color: #FFD700;
            color: #000;
            font-size: 18px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
        }

        /* Strobe pattern styling */
        .strobe-pattern {
            margin: 5px 0;
        }

        .strobe-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            gap: 0;
            justify-content: center;
            align-items: center;
        }

        .checkbox-group input[type="checkbox"] {
            width: calc(var(--base-font) * 1.8);
            height: calc(var(--base-font) * 1.8);
            margin: 0;
            padding: 0;
        }

        .strobe-led {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #300;
            display: inline-block;
            position: relative;
            box-shadow:
                inset 0 -3px 8px rgba(0,0,0,0.5),
                inset 0 3px 8px rgba(255,255,255,0.1),
                0 2px 4px rgba(0,0,0,0.3);
            border: 2px solid #555;
            transition: all 0.05s ease;
        }

        .strobe-led::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 20%;
            width: 35%;
            height: 25%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent);
            opacity: 0.6;
        }

        .strobe-led.active {
            background-color: #ff0000;
            box-shadow:
                inset 0 -3px 8px rgba(0,0,0,0.3),
                inset 0 3px 8px rgba(255,100,100,0.3),
                0 0 15px rgba(255,0,0,0.8),
                0 0 30px rgba(255,0,0,0.5),
                0 0 45px rgba(255,0,0,0.3);
            border-color: #ff4444;
        }

        /* Timer grid i√ßin CSS g√ºncellemesi */
        .timer-grid {
            display: grid;
            grid-template-columns: 60px 80px repeat(4, 1fr);
            gap: 1px;
            background-color: #555; /* Grid √ßizgileri i√ßin arka plan rengi */
            border: 1px solid #555;
            margin-top: 10px;
        }

        /* Servo kolonlarƒ±nƒ± gizlemek i√ßin (Not Used se√ßildiƒüinde) */
        /* display: none ile gizle, grid otomatik ayarlansƒ±n */
        .timer-grid.hide-ru .ru-column {
            display: none;
        }

        .timer-grid.hide-tl .tl-column {
            display: none;
        }

        .timer-grid.hide-ww .ww-column {
            display: none;
        }

        .timer-grid.hide-ww2 .ww2-column {
            display: none;
        }

        /* Grid s√ºtun sayƒ±sƒ±nƒ± dinamik ayarla */
        .timer-grid {
            grid-template-columns: 60px 80px repeat(4, 1fr);
        }

        .timer-grid.hide-ww2 {
            grid-template-columns: 60px 80px repeat(3, 1fr);
        }

        .timer-grid.hide-ww {
            grid-template-columns: 60px 80px repeat(3, 1fr);
        }

        .timer-grid.hide-tl {
            grid-template-columns: 60px 80px repeat(3, 1fr);
        }

        .timer-grid.hide-ru {
            grid-template-columns: 60px 80px repeat(3, 1fr);
        }

        /* 2 kolon gizli */
        .timer-grid.hide-ru.hide-tl,
        .timer-grid.hide-ru.hide-ww,
        .timer-grid.hide-ru.hide-ww2,
        .timer-grid.hide-tl.hide-ww,
        .timer-grid.hide-tl.hide-ww2,
        .timer-grid.hide-ww.hide-ww2 {
            grid-template-columns: 60px 80px repeat(2, 1fr);
        }

        /* 3 kolon gizli */
        .timer-grid.hide-ru.hide-tl.hide-ww,
        .timer-grid.hide-ru.hide-tl.hide-ww2,
        .timer-grid.hide-ru.hide-ww.hide-ww2,
        .timer-grid.hide-tl.hide-ww.hide-ww2 {
            grid-template-columns: 60px 80px 1fr;
        }

        /* 4 kolon gizli */
        .timer-grid.hide-ru.hide-tl.hide-ww.hide-ww2 {
            grid-template-columns: 60px 80px;
        }

        .timer-header {
            background-color: #FFD700;
            color: #000;
            padding: 4px 0;
            text-align: center;
            font-weight: bold;
            font-size: var(--small-font);
            border: none;
        }

        .timer-cell {
            background-color: #333;
            padding: 0;
            margin: 0;
            text-align: center;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .timer-cell input {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 4px;
            background-color: #222;
            color: #fff;
            border: none;
            border-radius: 0;
            text-align: center;
            -moz-appearance: textfield;
            appearance: textfield;
            font-size: var(--small-font);
            box-sizing: border-box;
        }

        .timer-cell.function-name {
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: #333;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }

        .timer-cell.function-name:hover {
            background-color: rgba(255, 215, 0, 0.3);
        }

        /* Info Label - Clickable labels with hover effect */
        .info-label {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .info-label:hover {
            color: #FFD700;
            text-decoration: underline;
        }

        /* Time inputlarƒ± i√ßin saƒüa yasla */
        .timer-cell input[id$="-time"] {
            text-align: right;
            padding-right: 4px;
        }

        /* T√ºm number input'larƒ± i√ßin spinbutton'larƒ± kaldƒ±r */
        .timer-cell input[type="number"]::-webkit-inner-spin-button,
        .timer-cell input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        .timer-cell input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .dt-input-row {
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dt-input-row label {
            margin: 0;
            flex: 1;
        }

        .dt-input-row input {
            width: 120px;
            margin: 0 0 0 10px;
        }

        .auto-dt-container {
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid #ccc;
        }

        /* Geofencing Styles */
        #geofencing-map-container {
            margin-top: 15px;
            margin-left: -35px; /* Auto DT container'ƒ±n margin+padding'ini geri al (20+15=35px) */
            padding: 15px;
            background-color: rgba(30, 30, 60, 0.5);
            border-radius: 8px;
            border: 1px solid #FFD700;
        }

        .geofence-instructions {
            color: #FFD700;
            font-size: var(--small-font);
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #geofence-map {
            width: 100%;
            height: 0;
            padding-bottom: 100%; /* 1:1 aspect ratio trick */
            position: relative;
            border: 2px solid #FFD700;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 10px;
        }

        #geofence-map .leaflet-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .geofence-coords-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
            font-size: var(--small-font);
        }

        .coord-item {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            color: #FFD700;
            font-family: monospace;
        }

        .clear-geofence-btn {
            width: 100%;
            padding: 10px;
            margin-top: 12px;
            background-color: #d32f2f;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: var(--base-font);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .clear-geofence-btn:hover {
            background-color: #b71c1c;
        }

        .clear-geofence-btn:active {
            background-color: #7f0000;
        }

        .advanced-settings-container {
            background-color: rgba(70, 130, 180, 0.15);
            padding: 2px;
            border-radius: 12px;
            border: 2px solid rgba(70, 130, 180, 0.3);
            margin-bottom: 20px;
        }

        .advanced-settings-container .section {
            padding: 2px;
        }

        /* Pin diagram label styling for better fit */
        #s1-label, #s2-label, #s3-label, #s4-label, #s5-label, #s6-label {
            font-size: 10px !important;
        }

        #side-func-label-4, #side-func-label-5, #side-func-label-6 {
            font-size: 8px !important;
        }

        .checkbox-label {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }

        .option-row {
            margin-top: 15px;
        }
        
        .option-row label {
            display: block;
            margin-bottom: 5px;
        }
        
        .option-row select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        .hook-options-container {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #222;
        }
        
        .hook-options-container h3 {
            color: #FFD700;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-row label {
            flex: 1;
            margin: 0;
            padding-right: 10px;
        }
        
        .option-row select,
        .option-row input {
            flex: 1;
            width: auto;
            margin: 0;
        }

        .pin-diagram-svg {
            width: 100%;
            height: auto;
            max-width: 100%;
            display: block;
            margin: 0;
        }

        .section:has(.pin-diagram-svg) {
            padding: var(--base-padding) calc(var(--base-padding) * 0.3) calc(var(--base-padding) * 0.3) calc(var(--base-padding) * 0.3);
        }

        .toggle-button {
            background-color: #FFD700;
            color: #000;
            font-size: calc(var(--base-font) * 1.1);
            padding: var(--base-padding);
            border: none;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .toggle-button:hover {
            background-color: #FFC000;
        }

        /* Preset name container i√ßin √∂zel stil */
        .preset-name-container {
            margin-bottom: 15px;
        }

        .preset-name-container label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
            font-size: var(--base-font);
        }

        /* Preset controls - selector ve butonlar i√ßin flex container */
        .preset-controls {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .preset-controls select {
            flex: 1;
            min-width: 0; /* Flex shrink i√ßin gerekli */
            padding: calc(var(--base-padding) * 0.8);
            font-size: var(--base-font);
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: calc(var(--base-padding) * 0.5);
        }

        /* Preset butonlarƒ± - + ve - */
        .preset-btn {
            width: 40px;
            min-width: 40px;
            height: calc(1.6 * var(--base-padding) + var(--base-font) * 1.2);
            padding: 0;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: calc(var(--base-padding) * 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-sizing: border-box;
            line-height: 1;
        }

        .add-btn {
            background-color: #4CAF50;
            color: white;
        }

        .add-btn:hover {
            background-color: #45a049;
        }

        .add-btn:active {
            background-color: #3d8b40;
            transform: scale(0.95);
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background-color: #da190b;
        }

        .delete-btn:active {
            background-color: #c41409;
            transform: scale(0.95);
        }

        .delete-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Model name container i√ßin √∂zel stil */
        .model-name-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .model-name-container label {
            margin: 0;
        }

        .model-name-container input {
            border: none;
            background: #333;
            color: #fff;
            font-size: var(--base-font);
            padding: calc(var(--base-padding) * 0.5);
            margin: 0;
            border-radius: 3px;
            width: 50vw;
            max-width: 200px;
        }

        .model-name-container input:focus {
            outline: 1px solid #FFD700;
        }

        input, select, button {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Modal Dialog Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.2s ease-in;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-dialog {
            background-color: #1E1E1E;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .modal-icon {
            font-size: 32px;
        }

        .modal-title {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .modal-body {
            color: #ccc;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-preset-name {
            color: #f44336;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background-color: #555;
            color: #fff;
        }

        .modal-btn-cancel:hover {
            background-color: #666;
        }

        .modal-btn-delete {
            background-color: #f44336;
            color: #fff;
        }

        .modal-btn-delete:hover {
            background-color: #d32f2f;
        }

        .modal-btn-delete:active {
            transform: scale(0.95);
        }

        /* Info Modal - Mavi tema */
        .modal-dialog-info {
            background-color: #1E1E1E;
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 15px;
            max-width: 400px;
            width: calc(100% - 40px);
            max-height: 75vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
            margin: auto;
        }

        .modal-header-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .modal-icon-info {
            font-size: 32px;
        }

        .modal-title-info {
            color: #2196F3;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .modal-body-info {
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 5px;
            flex-shrink: 1;
            white-space: pre-line;
        }

        .modal-body-info strong {
            color: #FFD700;
            font-weight: bold;
        }

        .modal-btn-ok {
            background-color: #2196F3;
            color: #fff;
            width: 100%;
        }

        .modal-btn-ok:hover {
            background-color: #1976D2;
        }

        /* Add Preset Modal - Ye≈üil tema */
        .modal-dialog-add {
            background-color: #1E1E1E;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        .modal-header-add {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .modal-icon-add {
            font-size: 32px;
        }

        .modal-title-add {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .modal-body-add {
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-label {
            display: block;
            color: #4CAF50;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #2D2D2D;
            color: #fff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: #66BB6A;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        .modal-input-hint {
            display: block;
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .modal-btn-add {
            background-color: #4CAF50;
            color: #fff;
        }

        .modal-btn-add:hover {
            background-color: #45a049;
        }

        .modal-btn-add:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Pin Conflict Warning Modal - Kƒ±rmƒ±zƒ±/Sarƒ± tema */
        .modal-dialog-conflict {
            background-color: #1E1E1E;
            border: 3px solid #FF9800;
            border-radius: 12px;
            padding: 20px;
            max-width: 420px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(255, 152, 0, 0.3);
            animation: shake 0.5s ease-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .modal-header-conflict {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 12px;
        }

        .modal-icon-conflict {
            font-size: 36px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .modal-title-conflict {
            color: #FF9800;
            font-size: 22px;
            font-weight: bold;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .modal-body-conflict {
            color: #fff;
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .conflict-detail {
            background-color: #2D2D2D;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .conflict-pin {
            color: #FF9800;
            font-weight: bold;
            font-size: 18px;
        }

        .conflict-component {
            color: #f44336;
            font-weight: bold;
        }

        .conflict-attempted {
            color: #2196F3;
            font-weight: bold;
        }

        .conflict-reverted {
            color: #4CAF50;
            font-weight: bold;
        }

        .modal-btn-conflict {
            background: linear-gradient(135deg, #FF9800, #FF5722);
            color: #fff;
            width: 100%;
            padding: 14px;
            font-size: 18px;
            font-weight: bold;
        }

        .modal-btn-conflict:hover {
            background: linear-gradient(135deg, #FB8C00, #F4511E);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4);
        }

        /* Custom Number Input Modal */
        .modal-dialog-number {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid #FFD700;
        }

        .modal-header-number {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 15px;
            border-radius: 18px 18px 0 0;
            text-align: center;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-number h3 {
            margin: 0;
            flex: 1;
            text-align: center;
            font-size: var(--base-font);
        }

        .modal-close-btn {
            background: rgba(0, 0, 0, 0.2);
            border: none;
            color: #000;
            font-size: 24px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .modal-body-number {
            padding: 20px;
        }

        .number-display-area {
            background-color: #222;
            border: 2px solid #FFD700;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
        }

        .previous-value-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }

        .previous-value-label {
            color: #888;
            font-size: 12px;
        }

        .previous-value-display {
            color: #888;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 3px 10px;
            border-radius: 5px;
        }

        .number-display-value-container {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 5px;
        }

        .number-display-value {
            color: #fff;
            font-size: 36px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .number-display-unit {
            color: #FFD700;
            font-size: 18px;
            font-weight: bold;
        }

        .number-controls {
            display: grid;
            gap: 10px;
        }

        .increment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .number-btn-increment {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-color: #4CAF50;
            font-size: 32px;
        }

        .number-btn-increment:active {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
        }

        .number-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .number-btn {
            background: linear-gradient(135deg, #333 0%, #444 100%);
            border: 2px solid #666;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            min-height: 50px;
        }

        .number-btn:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #222 0%, #333 100%);
        }

        .number-btn-special {
            background: linear-gradient(135deg, #555 0%, #666 100%);
            font-size: 20px;
        }

        .number-btn-special:active {
            background: linear-gradient(135deg, #444 0%, #555 100%);
        }

        .number-btn-action {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border-color: #FFD700;
            font-size: 22px;
        }

        .number-btn-action:active {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
        }

        .number-btn-clear {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            border-color: #f44336;
            font-size: 20px;
        }

        .number-btn-clear:active {
            background: linear-gradient(135deg, #b71c1c 0%, #7f0000 100%);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .number-error-message {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            color: #fff;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 11px;
            text-align: center;
            border: 2px solid #f44336;
            display: none;
            animation: shake 0.5s;
            line-height: 1.3;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-icon">‚ö†Ô∏è</span>
                <h3 class="modal-title">Delete Preset?</h3>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <span id="modalPresetName" class="modal-preset-name"></span>?
                <br><br>
                This action cannot be undone.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="modal-btn modal-btn-delete" onclick="closeConfirmModal(true)">Delete</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-dialog-info">
            <div class="modal-header-info">
                <span class="modal-icon-info">‚ÑπÔ∏è</span>
                <h3 class="modal-title-info">Preset Deleted</h3>
            </div>
            <div class="modal-body-info">
                The preset has been removed from the local configuration.
                <br><br>
                To make this change permanent, please <strong>click the SAVE button</strong> below to update the device.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-ok" onclick="closeInfoModal()">OK, Got it!</button>
            </div>
        </div>
    </div>

    <!-- Add Preset Modal -->
    <div id="addModal" class="modal-overlay">
        <div class="modal-dialog-add">
            <div class="modal-header-add">
                <span class="modal-icon-add">‚ûï</span>
                <h3 class="modal-title-add">Add New Preset</h3>
            </div>
            <div class="modal-body-add">
                Create a new preset based on the current configuration.
            </div>
            <div class="modal-input-group">
                <label class="modal-input-label" for="addPresetInput">Preset Name</label>
                <input
                    type="text"
                    id="addPresetInput"
                    class="modal-input"
                    placeholder="Enter preset name"
                    maxlength="20"
                    onkeyup="validateAddPresetInput()"
                    onkeypress="if(event.key==='Enter'){confirmAddPreset();}"
                >
                <span class="modal-input-hint">Maximum 20 characters</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddModal()">Cancel</button>
                <button id="addPresetConfirmBtn" class="modal-btn modal-btn-add" onclick="confirmAddPreset()" disabled>Add Preset</button>
            </div>
        </div>
    </div>

    <!-- Preset Changed Info Modal -->
    <div id="presetChangedModal" class="modal-overlay">
        <div class="modal-dialog-info">
            <div class="modal-header-info">
                <span class="modal-icon-info">üîÑ</span>
                <h3 class="modal-title-info">Preset Changed</h3>
            </div>
            <div class="modal-body-info">
                You have switched to <strong id="changedPresetName"></strong> preset.
                <br><br>
                To upload this change to the device, please <strong>click the SAVE button</strong> below.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-ok" onclick="closePresetChangedModal()">OK, Got it!</button>
            </div>
        </div>
    </div>

    <!-- Servo Value Out of Range Modal -->
    <div id="servoRangeModal" class="modal-overlay">
        <div class="modal-dialog-conflict">
            <div class="modal-header-conflict">
                <span class="modal-icon-conflict">‚ö†Ô∏è</span>
                <h3 class="modal-title-conflict">Value Out of Range!</h3>
            </div>
            <div class="modal-body-conflict">
                <div style="color: #fff; font-size: 16px; line-height: 1.8;">
                    The value you entered is outside the valid range.
                </div>

                <div class="conflict-detail" style="margin: 15px 0;">
                    <strong>Entered:</strong> <span class="conflict-pin" id="servoEnteredValue"></span>
                    <br>
                    <strong>Valid Range:</strong> <span class="conflict-component" id="servoValidRange"></span>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                    ‚úì Reverted to: <span class="conflict-reverted" id="servoRevertedValue"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-conflict" onclick="closeServoRangeModal()">OK, Got it</button>
            </div>
        </div>
    </div>

    <!-- Time Sequence Error Modal -->
    <div id="timeSequenceModal" class="modal-overlay">
        <div class="modal-dialog-conflict">
            <div class="modal-header-conflict">
                <span class="modal-icon-conflict">‚ö†Ô∏è</span>
                <h3 class="modal-title-conflict">Invalid Time Sequence!</h3>
            </div>
            <div class="modal-body-conflict">
                <div style="color: #fff; font-size: 16px; line-height: 1.8;">
                    In Absolute mode, each time value must be greater than or equal to the previous one.
                </div>

                <div class="conflict-detail" style="margin: 15px 0;">
                    <strong>Previous:</strong> <span class="conflict-component" id="timePreviousValue"></span>
                    <br>
                    <strong>Entered:</strong> <span class="conflict-pin" id="timeEnteredValue"></span>
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                    ‚úì Reverted to: <span class="conflict-reverted" id="timeRevertedValue"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-conflict" onclick="closeTimeSequenceModal()">OK, Got it</button>
            </div>
        </div>
    </div>

    <!-- Pin Conflict Warning Modal -->
    <div id="pinConflictModal" class="modal-overlay">
        <div class="modal-dialog-conflict">
            <div class="modal-header-conflict">
                <span class="modal-icon-conflict">‚ö†Ô∏è</span>
                <h3 class="modal-title-conflict">PIN CONFLICT!</h3>
            </div>
            <div class="modal-body-conflict">
                <div class="conflict-detail">
                    Pin <span class="conflict-pin" id="conflictPinNumber"></span> is already in use by:
                    <br>
                    <span class="conflict-component" id="conflictExistingComponent"></span>
                </div>

                <div style="margin: 15px 0;">
                    <span class="conflict-attempted" id="conflictAttemptedComponent"></span> cannot use this pin.
                </div>

                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                    ‚úì Reverted to: <span class="conflict-reverted" id="conflictRevertedValue"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-conflict" onclick="closePinConflictModal()">OK, I Understand</button>
            </div>
        </div>
    </div>

    <!-- Function Info Modal -->
    <div id="functionInfoModal" class="modal-overlay">
        <div class="modal-dialog-info">
            <div class="modal-header-info">
                <span class="modal-icon-info" id="functionInfoIcon">‚ÑπÔ∏è</span>
                <h3 class="modal-title-info" id="functionInfoTitle">Function Info</h3>
            </div>
            <div class="modal-body-info" id="functionInfoBody">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-ok" onclick="closeFunctionInfoModal()">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Number Input Modal -->
    <div id="numberInputModal" class="modal-overlay">
        <div class="modal-dialog-number">
            <div class="modal-header-number">
                <h3 id="numberInputTitle">Enter Time Value</h3>
                <button class="modal-close-btn" onclick="closeNumberInputModal()">&times;</button>
            </div>
            <div class="modal-body-number">
                <div class="number-display-area">
                    <div class="previous-value-row">
                        <span class="previous-value-label">Current:</span>
                        <span class="previous-value-display" id="previousValueDisplay">0.00</span>
                    </div>
                    <div class="number-display-value-container">
                        <span class="number-display-value" id="numberDisplayValue">_</span>
                        <span class="number-display-unit" id="numberDisplayUnit">s</span>
                    </div>
                </div>
                <div class="number-controls">
                    <!-- Increment/Decrement buttons -->
                    <div class="increment-buttons">
                        <button class="number-btn number-btn-increment" onclick="decrementValue()">‚àí</button>
                        <button class="number-btn number-btn-increment" onclick="incrementValue()">+</button>
                    </div>

                    <!-- Number keypad (1-9, 0, .) -->
                    <div class="number-keypad">
                        <button class="number-btn" onclick="inputDigit('7')">7</button>
                        <button class="number-btn" onclick="inputDigit('8')">8</button>
                        <button class="number-btn" onclick="inputDigit('9')">9</button>

                        <button class="number-btn" onclick="inputDigit('4')">4</button>
                        <button class="number-btn" onclick="inputDigit('5')">5</button>
                        <button class="number-btn" onclick="inputDigit('6')">6</button>

                        <button class="number-btn" onclick="inputDigit('1')">1</button>
                        <button class="number-btn" onclick="inputDigit('2')">2</button>
                        <button class="number-btn" onclick="inputDigit('3')">3</button>

                        <button class="number-btn number-btn-special" onclick="inputDigit('.')">.</button>
                        <button class="number-btn" onclick="inputDigit('0')">0</button>
                        <button class="number-btn number-btn-clear" onclick="deleteDigit()">‚å´</button>
                    </div>

                    <!-- Error message -->
                    <div id="numberErrorMessage" class="number-error-message"></div>

                    <!-- Action buttons -->
                    <div class="action-buttons">
                        <button class="number-btn number-btn-clear" onclick="closeNumberInputModal()">Cancel</button>
                        <button class="number-btn number-btn-action" onclick="confirmNumberValue()">‚úì OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h1>F1A Model Configuration</h1>

    <form onsubmit="submitForm(event)">

        <!-- Model Identification -->
        <div class="section section-before-toggle">
            <h2>Model Identification</h2>
            
            <div class="model-name-container">
                <label for="model-name">Model Name:</label>
                <input type="text" id="model-name" name="model-name" placeholder="e.g., MyModel">
            </div>
            
            <div class="preset-name-container">
                <label for="preset-selector">Select Preset:</label>
                <div class="preset-controls">
                    <select id="preset-selector" name="preset-selector" onchange="onPresetChanged()">
                        <option value="">Loading presets...</option>
                    </select>
                    <button type="button" class="preset-btn add-btn" onclick="addNewPreset()" title="Add New Preset">+</button>
                    <button type="button" class="preset-btn delete-btn" onclick="deleteCurrentPreset()" title="Delete Preset">‚àí</button>
                </div>
                <input type="hidden" id="preset-name" name="preset-name">
                <input type="hidden" id="preset-index" name="preset-index" value="1">
            </div>

            <label for="strobe-pattern">Strobe Pattern:</label>
            <div class="strobe-pattern">
                <div class="strobe-container">
                    <div class="checkbox-group">
                        <input type="checkbox" id="bit7" name="strobe-bit" value="128">
                        <input type="checkbox" id="bit6" name="strobe-bit" value="64" checked>
                        <input type="checkbox" id="bit5" name="strobe-bit" value="32">
                        <input type="checkbox" id="bit4" name="strobe-bit" value="16" checked>
                        <input type="checkbox" id="bit3" name="strobe-bit" value="8">
                        <input type="checkbox" id="bit2" name="strobe-bit" value="4">
                        <input type="checkbox" id="bit1" name="strobe-bit" value="2">
                        <input type="checkbox" id="bit0" name="strobe-bit" value="1" checked>
                    </div>
                    <div id="strobeLed" class="strobe-led"></div>
                </div>
                <input type="hidden" id="strobe-value" name="strobe-value" value="81">
            </div>
        </div>

        <!-- Servo Configuration'dan Auto DT Features'a kadar olan b√∂l√ºmleri gizleyecek buton -->
        <button id="toggleSettingsBtn" class="toggle-button">Show Settings</button>

        <!-- Gizlenecek b√∂l√ºmler -->
        <div id="advancedSettings" class="advanced-settings-container" style="display: none;">
            <!-- Servo Configuration b√∂l√ºm√º -->
            <div class="section">
                <h2>Servo Configuration</h2>
                <div class="option-row">
                    <label for="ru-servo-pin" class="info-label" onclick="showFunctionInfo('ru-servo')">RU Servo Pin:</label>
                    <select id="ru-servo-pin" name="ru-servo-pin">
                        <option value="0">Not Used</option>
                        <option value="1" selected>S1</option>
                        <option value="2">S2</option>
                        <option value="3">S3</option>
                        <option value="4">S4</option>
                        <option value="5">S5</option>
                        <option value="6">S6</option>
                        <option value="7">S7</option>
                        <option value="8">S8</option>
                        <option value="9">S9</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="tl-servo-pin" class="info-label" onclick="showFunctionInfo('tl-servo')">TL Servo Pin:</label>
                    <select id="tl-servo-pin" name="tl-servo-pin">
                        <option value="0">Not Used</option>
                        <option value="1">S1</option>
                        <option value="2">S2</option>
                        <option value="3" selected>S3</option>
                        <option value="4">S4</option>
                        <option value="5">S5</option>
                        <option value="6">S6</option>
                        <option value="7">S7</option>
                        <option value="8">S8</option>
                        <option value="9">S9</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="ww-servo-pin" class="info-label" onclick="showFunctionInfo('ww-servo')">WW Servo Pin:</label>
                    <select id="ww-servo-pin" name="ww-servo-pin">
                        <option value="0">Not Used</option>
                        <option value="1">S1</option>
                        <option value="2">S2</option>
                        <option value="3">S3</option>
                        <option value="4">S4</option>
                        <option value="5" selected>S5</option>
                        <option value="6">S6</option>
                        <option value="7">S7</option>
                        <option value="8">S8</option>
                        <option value="9">S9</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="ww2-servo-pin" class="info-label" onclick="showFunctionInfo('ww2-servo')">WW2 Servo Pin:</label>
                    <select id="ww2-servo-pin" name="ww2-servo-pin">
                        <option value="0" selected>Not Used</option>
                        <option value="1">S1</option>
                        <option value="2">S2</option>
                        <option value="3">S3</option>
                        <option value="4">S4</option>
                        <option value="5">S5</option>
                        <option value="6">S6</option>
                        <option value="7">S7</option>
                        <option value="8">S8</option>
                        <option value="9">S9</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="servo-range-mode" class="info-label" onclick="showFunctionInfo('range-mode')">Range Mode:</label>
                    <select id="servo-range-mode" name="servo-range-mode" onchange="updateRangeModeLabels()">
                        <option value="0-100">0-100 (%)</option>
                        <option value="0-255">0-255</option>
                        <option value="1000-2000" selected>1000-2000 ¬µs</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="time-mode" class="info-label" onclick="showFunctionInfo('time-mode')">Time Mode:</label>
                    <select id="time-mode" name="time-mode" onchange="updateTimeMode()">
                        <option value="interval" selected>Interval</option>
                        <option value="absolute">Absolute</option>
                    </select>
                </div>
            </div>

            <!-- Hook Configuration b√∂l√ºm√º -->
            <div class="section">
                <h2>Hook Configuration</h2>

                <label for="hook-type" class="info-label" onclick="showFunctionInfo('hook-type')">Hook Type:</label>
                <select id="hook-type" name="hook-type" onchange="updateHookOptions()">
                    <option value="2switch">2 Switch</option>
                    <option value="2switch_servo">2 Switch + Servo</option>
                    <option value="rotary_servo">Rotary Enc. + Servo</option>
                </select>
                
                <div id="hook-options">
                    <!-- Bu alan dinamik olarak doldurulacak -->
                </div>
            </div>

            <!-- Pin Header Layout b√∂l√ºm√º -->
            <div class="section">
                <h2>Pin Header Layout</h2>
                <svg class="pin-diagram-svg" viewBox="15 15 270 120" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                        <!-- Header Outline -->
                        <rect x="20" y="20" width="260" height="110" rx="5" ry="5" fill="#333" stroke="#555" stroke-width="2"/>

                        <!-- Top Row Pins: S6, S4, S2 (left to right) -->
                        <g class="pin-row">
                            <!-- S6 Socket: - + S -->
                            <!-- - -->
                            <rect x="30" y="30" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="40" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- + -->
                            <rect x="55" y="30" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="65" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- S6 -->
                            <rect x="80" y="30" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="90" y="44" font-size="12" text-anchor="middle" fill="#000">S6</text>
                            <!-- Label under S6 -->
                            <text x="55" y="60" font-size="10" text-anchor="middle" fill="#FFD700" id="s6-label">Hook Servo</text>

                            <!-- S4 Socket: - + S -->
                            <!-- - -->
                            <rect x="110" y="30" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="120" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- + -->
                            <rect x="135" y="30" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="145" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- S4 -->
                            <rect x="160" y="30" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="170" y="44" font-size="12" text-anchor="middle" fill="#000">S4</text>
                            <!-- Label under S4 -->
                            <text x="135" y="60" font-size="10" text-anchor="middle" fill="#FFD700" id="s4-label">Hook SW1</text>

                            <!-- S2 Socket: - + S -->
                            <!-- - -->
                            <rect x="190" y="30" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="200" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- + -->
                            <rect x="215" y="30" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="225" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- S2 -->
                            <rect x="240" y="30" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="250" y="44" font-size="12" text-anchor="middle" fill="#000">S2</text>
                            <!-- Label under S2 -->
                            <text x="215" y="60" font-size="10" text-anchor="middle" fill="#FFD700" id="s2-label">TL Servo</text>
                        </g>

                        <!-- Bottom Row Pins: S5, S3, S1 (left to right) -->
                        <g class="pin-row">
                            <!-- S5 Socket: - + S -->
                            <!-- - -->
                            <rect x="30" y="80" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="40" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- + -->
                            <rect x="55" y="80" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="65" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- S5 -->
                            <rect x="80" y="80" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="90" y="94" font-size="12" text-anchor="middle" fill="#000">S5</text>
                            <!-- Label under S5 -->
                            <text x="55" y="110" font-size="10" text-anchor="middle" fill="#FFD700" id="s5-label">Hook SW2</text>

                            <!-- S3 Socket: - + S -->
                            <!-- - -->
                            <rect x="110" y="80" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="120" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- + -->
                            <rect x="135" y="80" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="145" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- S3 -->
                            <rect x="160" y="80" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="170" y="94" font-size="12" text-anchor="middle" fill="#000">S3</text>
                            <!-- Label under S3 -->
                            <text x="135" y="110" font-size="10" text-anchor="middle" fill="#FFD700" id="s3-label">RU Servo</text>

                            <!-- S1 Socket: - + S -->
                            <!-- - -->
                            <rect x="190" y="80" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="200" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- + -->
                            <rect x="215" y="80" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="225" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- S1 -->
                            <rect x="240" y="80" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="250" y="94" font-size="12" text-anchor="middle" fill="#000">S1</text>
                            <!-- Label under S1 -->
                            <text x="215" y="110" font-size="10" text-anchor="middle" fill="#FFD700" id="s1-label">WW Servo</text>
                        </g>
                </svg>
            </div>

            <!-- Side Socket Layout b√∂l√ºm√º -->
            <div class="section">
                <h2>Side Socket Layout</h2>
                <svg class="pin-diagram-svg" viewBox="0 0 280 180" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                    <!-- Socket container (beyaz dikd√∂rtgen) -->
                    <rect x="120" y="10" width="80" height="160" rx="3" ry="3" fill="#FFFFFF" stroke="#999" stroke-width="2"/>

                    <!-- Pin row (saƒü tarafta - orijinal isimler) -->
                    <g id="socket-pins-right">
                        <!-- Pin 1 - GND (Siyah) -->
                        <rect x="200" y="20" width="15" height="12" fill="#000000" stroke="#FFD700" stroke-width="1"/>
                        <text x="218" y="28" font-size="9" text-anchor="start" fill="#FFD700">GND</text>

                        <!-- Pin 2 - V_BAT (Kƒ±rmƒ±zƒ±) -->
                        <rect x="200" y="38" width="15" height="12" fill="#FF0000" stroke="#000" stroke-width="1"/>
                        <text x="218" y="46" font-size="9" text-anchor="start" fill="#FFD700">V_BAT</text>

                        <!-- Pin 3 - GND (Kahverengi) -->
                        <rect x="200" y="56" width="15" height="12" fill="#8B4513" stroke="#000" stroke-width="1"/>
                        <text x="218" y="64" font-size="9" text-anchor="start" fill="#FFD700">GND</text>

                        <!-- Pin 4 - S9 (Mavi) -->
                        <rect x="200" y="74" width="15" height="12" fill="#2196F3" stroke="#000" stroke-width="1"/>
                        <text x="218" y="82" font-size="9" text-anchor="start" fill="#FFD700">S9</text>

                        <!-- Pin 5 - S8 (Ye≈üil) -->
                        <rect x="200" y="92" width="15" height="12" fill="#00FF00" stroke="#000" stroke-width="1"/>
                        <text x="218" y="100" font-size="9" text-anchor="start" fill="#FFD700">S8</text>

                        <!-- Pin 6 - S7 (Sarƒ±) -->
                        <rect x="200" y="110" width="15" height="12" fill="#FFD700" stroke="#000" stroke-width="1"/>
                        <text x="218" y="118" font-size="9" text-anchor="start" fill="#FFD700">S7</text>

                        <!-- Pin 7 - TX (Turuncu) -->
                        <rect x="200" y="128" width="15" height="12" fill="#FF8C00" stroke="#000" stroke-width="1"/>
                        <text x="218" y="136" font-size="9" text-anchor="start" fill="#FFD700">TX</text>

                        <!-- Pin 8 - RX (Beyaz) -->
                        <rect x="200" y="146" width="15" height="12" fill="#FFFFFF" stroke="#000" stroke-width="1"/>
                        <text x="218" y="154" font-size="9" text-anchor="start" fill="#FFD700">RX</text>
                    </g>

                    <!-- Sol taraf - Pin numaralarƒ± ve fonksiyon labels -->
                    <g id="socket-functions-left">
                        <!-- Pin 1 numarasƒ± -->
                        <text x="110" y="28" font-size="9" text-anchor="end" fill="#FFF">1</text>
                        <!-- Fonksiyon label (sarƒ± kutu + text) - Pin 1 i√ßin bo≈ü -->

                        <!-- Pin 2 numarasƒ± -->
                        <text x="110" y="46" font-size="9" text-anchor="end" fill="#FFF">2</text>
                        <!-- Fonksiyon label - Pin 2 i√ßin bo≈ü -->

                        <!-- Pin 3 numarasƒ± -->
                        <text x="110" y="64" font-size="9" text-anchor="end" fill="#FFF">3</text>
                        <!-- Fonksiyon label - Pin 3 i√ßin bo≈ü -->

                        <!-- Pin 4 numarasƒ± -->
                        <text x="110" y="82" font-size="9" text-anchor="end" fill="#FFF">4</text>
                        <!-- Fonksiyon label (dinamik) -->
                        <rect x="40" y="75" width="8" height="10" fill="#FFD700" stroke="#000" stroke-width="0.5" id="side-func-box-4"/>
                        <text x="50" y="83" font-size="8" text-anchor="start" fill="#FFD700" font-weight="bold" id="side-func-label-4"></text>

                        <!-- Pin 5 numarasƒ± -->
                        <text x="110" y="100" font-size="9" text-anchor="end" fill="#FFF">5</text>
                        <!-- Fonksiyon label (dinamik) -->
                        <rect x="40" y="93" width="8" height="10" fill="#FFD700" stroke="#000" stroke-width="0.5" id="side-func-box-5"/>
                        <text x="50" y="101" font-size="8" text-anchor="start" fill="#FFD700" font-weight="bold" id="side-func-label-5"></text>

                        <!-- Pin 6 numarasƒ± -->
                        <text x="110" y="118" font-size="9" text-anchor="end" fill="#FFF">6</text>
                        <!-- Fonksiyon label (dinamik) -->
                        <rect x="40" y="111" width="8" height="10" fill="#FFD700" stroke="#000" stroke-width="0.5" id="side-func-box-6"/>
                        <text x="50" y="119" font-size="8" text-anchor="start" fill="#FFD700" font-weight="bold" id="side-func-label-6"></text>

                        <!-- Pin 7 numarasƒ± -->
                        <text x="110" y="136" font-size="9" text-anchor="end" fill="#FFF">7</text>
                        <!-- Fonksiyon label - TX i√ßin bo≈ü -->

                        <!-- Pin 8 numarasƒ± -->
                        <text x="110" y="154" font-size="9" text-anchor="end" fill="#FFF">8</text>
                        <!-- Fonksiyon label - RX i√ßin bo≈ü -->
                    </g>
                </svg>
            </div>

            <!-- DT Features b√∂l√ºm√º -->
            <div class="section">
                <h2>DT Features</h2>
                <div class="option-row">
                    <label for="rdt-rx-pin" class="info-label" onclick="showFunctionInfo('rdt-rx')">RDT Rx Pin:</label>
                    <select id="rdt-rx-pin" name="rdt-rx-pin">
                        <option value="0" selected>Not Used</option>
                        <option value="1">S1</option>
                        <option value="2">S2</option>
                        <option value="3">S3</option>
                        <option value="4">S4</option>
                        <option value="5">S5</option>
                        <option value="6">S6</option>
                        <option value="7">S7</option>
                        <option value="8">S8</option>
                        <option value="9">S9</option>
                    </select>
                </div>

                <h3>Auto DT</h3>
                <div class="auto-dt-container">
                    <div class="dt-input-row">
                        <label for="max-sink" class="info-label" onclick="showFunctionInfo('max-sink')">Max Sink (m/s):</label>
                        <input type="number" id="max-sink-value" name="max-sink-value" min="0" max="10" step="0.1" value="2">
                    </div>
                    <div class="dt-input-row">
                        <label for="max-altitude" class="info-label" onclick="showFunctionInfo('max-altitude')">Max Altitude (m):</label>
                        <input type="number" id="max-altitude-value" name="max-altitude-value" min="0" max="1000" value="500">
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="flip-loop-detection" name="flip-loop-detection">
                        <label for="flip-loop-detection" class="info-label" onclick="showFunctionInfo('flip-loop-detection')">Flip & Loop Detection</label>
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="geofencing-enabled" name="geofencing-enabled" onchange="toggleGeofencingMap()">
                        <label for="geofencing-enabled" class="info-label" onclick="showFunctionInfo('geofencing')">Geofencing DT</label>
                    </div>

                    <!-- Geofencing Map Container (hidden by default) -->
                    <div id="geofencing-map-container" style="display: none;">
                        <div class="geofence-instructions">
                            Tap 4 corners on the map to define the boundary. Exit this area triggers DT.
                        </div>
                        <div id="geofence-map"></div>
                        <div class="geofence-coords-display">
                            <div class="coord-item">P1: <span id="coord-p1">---, ---</span></div>
                            <div class="coord-item">P2: <span id="coord-p2">---, ---</span></div>
                            <div class="coord-item">P3: <span id="coord-p3">---, ---</span></div>
                            <div class="coord-item">P4: <span id="coord-p4">---, ---</span></div>
                        </div>
                        <button type="button" class="clear-geofence-btn" onclick="clearGeofencePoints()">Clear Points</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timer Settings -->
        <div class="section">
            <h2>Time Settings</h2>
            <div class="timer-grid">
                <div class="timer-header">Func.</div>
                <div class="timer-header">Time</div>
                <div class="timer-header ru-column" id="header-ru">RU</div>
                <div class="timer-header tl-column" id="header-tl">TL</div>
                <div class="timer-header ww-column" id="header-ww">WW</div>
                <div class="timer-header ww2-column" id="header-ww2">WW2</div>

                <div class="timer-cell function-name" title="Power ON" onclick="showFunctionInfo('on')">On</div>
                <div class="timer-cell"></div>
                <div class="timer-cell ru-column">
                    <input type="number" id="on-ru" name="on-ru" min="1000" max="2000" value="1176">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="on-tl" name="on-tl" min="1000" max="2000" value="1137">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="on-ww" name="on-ww" min="1000" max="2000" value="1000">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="on-ww2" name="on-ww2" min="1000" max="2000" value="1000">
                </div>

                <div class="timer-cell function-name" title="Straight Tow" onclick="showFunctionInfo('str')">Str</div>
                <div class="timer-cell"></div>
                <div class="timer-cell ru-column">
                    <input type="number" id="str-ru" name="str-ru" min="1000" max="2000" value="1020">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="str-tl" name="str-tl" min="1000" max="2000" value="1098">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="str-ww" name="str-ww" min="1000" max="2000" value="1196">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="str-ww2" name="str-ww2" min="1000" max="2000" value="1196">
                </div>

                <div class="timer-cell function-name" title="Circle Tow" onclick="showFunctionInfo('cir')">Cir</div>
                <div class="timer-cell"></div>
                <div class="timer-cell ru-column">
                    <input type="number" id="cir-ru" name="cir-ru" min="1000" max="2000" value="1412">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="cir-tl" name="cir-tl" min="1000" max="2000" value="1059">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="cir-ww" name="cir-ww" min="1000" max="2000" value="1588">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="cir-ww2" name="cir-ww2" min="1000" max="2000" value="1588">
                </div>

                <div class="timer-cell function-name" title="On Line Acceleration" onclick="showFunctionInfo('ola')">OLA</div>
                <div class="timer-cell"></div>
                <div class="timer-cell ru-column">
                    <input type="number" id="ola-ru" name="ola-ru" min="1000" max="2000" value="1137">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="ola-tl" name="ola-tl" min="1000" max="2000" value="1020">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="ola-ww" name="ola-ww" min="1000" max="2000" value="1294">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="ola-ww2" name="ola-ww2" min="1000" max="2000" value="1294">
                </div>

                <div class="timer-cell function-name" title="Pitch Up 1" onclick="showFunctionInfo('pu1')">Pu1</div>
                <div class="timer-cell">
                    <input type="number" id="pu1-time" name="pu1-time" min="0" max="10" step="0.01" value="0.03">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="pu1-ru" name="pu1-ru" min="1000" max="2000" value="1137">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="pu1-tl" name="pu1-tl" min="1000" max="2000" value="1000">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="pu1-ww" name="pu1-ww" min="1000" max="2000" value="1294">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="pu1-ww2" name="pu1-ww2" min="1000" max="2000" value="1294">
                </div>

                <div class="timer-cell function-name" title="Pitch Up 2" onclick="showFunctionInfo('pu2')">Pu2</div>
                <div class="timer-cell">
                    <input type="number" id="pu2-time" name="pu2-time" min="0" max="10" step="0.01" value="0.1">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="pu2-ru" name="pu2-ru" min="1000" max="2000" value="1118">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="pu2-tl" name="pu2-tl" min="1000" max="2000" value="1008">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="pu2-ww" name="pu2-ww" min="1000" max="2000" value="1275">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="pu2-ww2" name="pu2-ww2" min="1000" max="2000" value="1275">
                </div>

                <div class="timer-cell function-name" title="Cruise 1" onclick="showFunctionInfo('cr1')">Cr1</div>
                <div class="timer-cell">
                    <input type="number" id="cr1-time" name="cr1-time" min="0" max="10" step="0.01" value="0.4">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="cr1-ru" name="cr1-ru" min="1000" max="2000" value="1098">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="cr1-tl" name="cr1-tl" min="1000" max="2000" value="1235">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="cr1-ww" name="cr1-ww" min="1000" max="2000" value="1235">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="cr1-ww2" name="cr1-ww2" min="1000" max="2000" value="1235">
                </div>

                <div class="timer-cell function-name" title="Cruise 2" onclick="showFunctionInfo('cr2')">Cr2</div>
                <div class="timer-cell">
                    <input type="number" id="cr2-time" name="cr2-time" min="0" max="10" step="0.01" value="0.7">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="cr2-ru" name="cr2-ru" min="1000" max="2000" value="1098">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="cr2-tl" name="cr2-tl" min="1000" max="2000" value="1255">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="cr2-ww" name="cr2-ww" min="1000" max="2000" value="1235">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="cr2-ww2" name="cr2-ww2" min="1000" max="2000" value="1235">
                </div>

                <div class="timer-cell function-name" title="Cruise 3" onclick="showFunctionInfo('cr3')">Cr3</div>
                <div class="timer-cell">
                    <input type="number" id="cr3-time" name="cr3-time" min="0" max="10" step="0.01" value="0.7">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="cr3-ru" name="cr3-ru" min="1000" max="2000" value="1098">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="cr3-tl" name="cr3-tl" min="1000" max="2000" value="1294">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="cr3-ww" name="cr3-ww" min="1000" max="2000" value="1235">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="cr3-ww2" name="cr3-ww2" min="1000" max="2000" value="1235">
                </div>

                <div class="timer-cell function-name" title="Bunt 1" onclick="showFunctionInfo('bu1')">Bu1</div>
                <div class="timer-cell">
                    <input type="number" id="bu1-time" name="bu1-time" min="0" max="10" step="0.01" value="0.5">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="bu1-ru" name="bu1-ru" min="1000" max="2000" value="1098">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="bu1-tl" name="bu1-tl" min="1000" max="2000" value="1784">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="bu1-ww" name="bu1-ww" min="1000" max="2000" value="1235">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="bu1-ww2" name="bu1-ww2" min="1000" max="2000" value="1235">
                </div>

                <div class="timer-cell function-name" title="Bunt 2" onclick="showFunctionInfo('bu2')">Bu2</div>
                <div class="timer-cell">
                    <input type="number" id="bu2-time" name="bu2-time" min="0" max="10" step="0.01" value="1.1">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="bu2-ru" name="bu2-ru" min="1000" max="2000" value="1098">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="bu2-tl" name="bu2-tl" min="1000" max="2000" value="1863">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="bu2-ww" name="bu2-ww" min="1000" max="2000" value="1294">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="bu2-ww2" name="bu2-ww2" min="1000" max="2000" value="1294">
                </div>

                <div class="timer-cell function-name" title="Bunt 3" onclick="showFunctionInfo('bu3')">Bu3</div>
                <div class="timer-cell">
                    <input type="number" id="bu3-time" name="bu3-time" min="0" max="10" step="0.01" value="1.7">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="bu3-ru" name="bu3-ru" min="1000" max="2000" value="1216">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="bu3-tl" name="bu3-tl" min="1000" max="2000" value="1941">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="bu3-ww" name="bu3-ww" min="1000" max="2000" value="1333">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="bu3-ww2" name="bu3-ww2" min="1000" max="2000" value="1333">
                </div>

                <div class="timer-cell function-name" title="Fast Glide" onclick="showFunctionInfo('fg')">Fg</div>
                <div class="timer-cell">
                    <input type="number" id="fg-time" name="fg-time" min="0" max="999" step="0.1" value="7.1">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="fg-ru" name="fg-ru" min="1000" max="2000" value="1224">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="fg-tl" name="fg-tl" min="1000" max="2000" value="1137">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="fg-ww" name="fg-ww" min="1000" max="2000" value="1059">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="fg-ww2" name="fg-ww2" min="1000" max="2000" value="1059">
                </div>

                <div class="timer-cell function-name" title="Glide" onclick="showFunctionInfo('gl')">GL</div>
                <div class="timer-cell">
                    <input type="number" id="gl-time" name="gl-time" min="0" max="999" step="0.1" value="180">
                </div>
                <div class="timer-cell ru-column">
                    <input type="number" id="gl-ru" name="gl-ru" min="1000" max="2000" value="1204">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="gl-tl" name="gl-tl" min="1000" max="2000" value="1125">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="gl-ww" name="gl-ww" min="1000" max="2000" value="1020">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="gl-ww2" name="gl-ww2" min="1000" max="2000" value="1020">
                </div>

                <div class="timer-cell function-name" title="De-Thermalised" onclick="showFunctionInfo('dt')">DT</div>
                <div class="timer-cell"></div>
                <div class="timer-cell ru-column">
                    <input type="number" id="dt-ru" name="dt-ru" min="1000" max="2000" value="1392">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="dt-tl" name="dt-tl" min="1000" max="2000" value="2000">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="dt-ww" name="dt-ww" min="1000" max="2000" value="1000">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="dt-ww2" name="dt-ww2" min="1000" max="2000" value="1000">
                </div>

                <div class="timer-cell function-name" title="Park mode 10s after DT" onclick="showFunctionInfo('pk')">Pk</div>
                <div class="timer-cell"></div>
                <div class="timer-cell ru-column">
                    <input type="number" id="pk-ru" name="pk-ru" min="1000" max="2000" value="1392">
                </div>
                <div class="timer-cell tl-column">
                    <input type="number" id="pk-tl" name="pk-tl" min="1000" max="2000" value="1000">
                </div>
                <div class="timer-cell ww-column">
                    <input type="number" id="pk-ww" name="pk-ww" min="1000" max="2000" value="1000">
                </div>
                <div class="timer-cell ww2-column">
                    <input type="number" id="pk-ww2" name="pk-ww2" min="1000" max="2000" value="1000">
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <input type="submit" value="SAVE">
    </form>

   <script>
  // Global deƒüi≈üken - cihazdan gelen t√ºm JSON
  var fullDeviceJson = null;

  // Eski pin deƒüerlerini sakla (√ßakƒ±≈üma durumunda geri d√∂nmek i√ßin)
  const previousPinValues = {};

  // Time mode global deƒüi≈ükeni
  window.currentTimeMode = 'interval'; // 'interval' veya 'absolute'

  // Time input'larƒ± i√ßin √∂nceki deƒüerleri sakla (validasyon i√ßin)
  const previousTimeValues = {};

  // Pin Conflict Validation with Revert
  // changedElementId: Hangi select deƒüi≈üti
  function validatePinAssignments(changedElementId) {
    const usedPins = new Map(); // pin -> {name, elementId}

    try {
      // T√ºm pin tanƒ±mlarƒ±
      const pinDefinitions = [
        { id: 'ru-servo-pin', name: 'RU Servo' },
        { id: 'tl-servo-pin', name: 'TL Servo' },
        { id: 'ww-servo-pin', name: 'WW Servo' },
        { id: 'ww2-servo-pin', name: 'WW2 Servo' },
        { id: 'rdt-rx-pin', name: 'RDT Rx' }
      ];

      // Hook pinlerini ekle
      const hookType = document.getElementById('hook-type')?.value;
      if (hookType === '2switch' || hookType === '2switch_servo') {
        pinDefinitions.push({ id: 'hook-sw1-pin', name: 'Hook SW1' });
        pinDefinitions.push({ id: 'hook-sw2-pin', name: 'Hook SW2' });
      }
      if (hookType === '2switch_servo' || hookType === 'rotary_servo') {
        pinDefinitions.push({ id: 'hook-servo-pin', name: 'Hook Servo' });
      }
      if (hookType === 'rotary_servo') {
        pinDefinitions.push({ id: 'encoder-pin', name: 'Encoder' });
      }

      // 1. √ñnce deƒüi≈ümeyen pinleri topla
      for (const def of pinDefinitions) {
        if (def.id === changedElementId) continue; // Deƒüi≈üeni atla

        const element = document.getElementById(def.id);
        if (!element) continue;

        const pin = parseInt(element.value);
        if (pin === 0 || isNaN(pin)) continue; // Not Used pinleri atla

        usedPins.set(pin, { name: def.name, elementId: def.id });
      }

      // 2. ≈ûimdi deƒüi≈üen pin'i kontrol et
      if (changedElementId) {
        const changedElement = document.getElementById(changedElementId);
        if (changedElement) {
          const changedPin = parseInt(changedElement.value);

          if (changedPin !== 0 && !isNaN(changedPin)) {
            // √áakƒ±≈üma var mƒ±?
            if (usedPins.has(changedPin)) {
              const existingPin = usedPins.get(changedPin);
              const changedPinName = pinDefinitions.find(d => d.id === changedElementId)?.name || 'Unknown';

              // ESKƒ∞ DEƒûERE GERƒ∞ D√ñN
              const oldValue = previousPinValues[changedElementId] || '0';
              changedElement.value = oldValue;

              // G√ºzel modal ile kullanƒ±cƒ±ya bildir
              showPinConflictModal(changedPin, existingPin.name, changedPinName, oldValue);

              console.warn(`‚ö†Ô∏è Pin conflict: ${changedPinName} tried Pin ${changedPin}, already used by ${existingPin.name}. Reverted to ${oldValue}`);

              // Diyagramƒ± g√ºncelle (eski deƒüerle)
              updatePinDiagram();
              return;
            }
          }

          // √áakƒ±≈üma yok, yeni deƒüeri kaydet
          previousPinValues[changedElementId] = changedElement.value;
        }
      }

    } catch (error) {
      console.error('‚ùå Error validating pins:', error);
    }

    return [];
  }

  // JSON Schema Validation
  function validateDeviceJson(json) {
    try {
      // Temel yapƒ± kontrol√º
      if (!json || typeof json !== 'object') {
        console.error('‚ùå Invalid JSON: not an object');
        return false;
      }

      // Zorunlu alanlar
      if (!json['model-class'] || typeof json['model-class'] !== 'string') {
        console.error('‚ùå Invalid JSON: missing or invalid model-class');
        return false;
      }

      if (typeof json['selected-preset-index'] !== 'number') {
        console.error('‚ùå Invalid JSON: missing or invalid selected-preset-index');
        return false;
      }

      // Presets array kontrol√º
      if (!Array.isArray(json.presets) || json.presets.length === 0) {
        console.error('‚ùå Invalid JSON: presets must be a non-empty array');
        return false;
      }

      // Her preset'i doƒürula
      for (let i = 0; i < json.presets.length; i++) {
        const preset = json.presets[i];

        if (!preset['preset-name'] || typeof preset['preset-name'] !== 'string') {
          console.error(`‚ùå Invalid preset ${i}: missing or invalid preset-name`);
          return false;
        }

        if (typeof preset['preset-index'] !== 'number') {
          console.error(`‚ùå Invalid preset ${i}: missing or invalid preset-index`);
          return false;
        }

        // Timers objesi kontrol√º
        if (!preset.timers || typeof preset.timers !== 'object') {
          console.error(`‚ùå Invalid preset ${i}: missing or invalid timers object`);
          return false;
        }

        // Pin deƒüerleri kontrol√º (0-9 arasƒ± olmalƒ±, 0 = Not Used)
        const pinFields = ['ru-servo-pin', 'tl-servo-pin', 'ww-servo-pin'];
        for (const field of pinFields) {
          if (preset[field] !== undefined) {
            const val = preset[field];
            if (typeof val !== 'number' || val < 0 || val > 9) {
              console.error(`‚ùå Invalid preset ${i}: ${field} must be between 0-9 (0 = Not Used)`);
              return false;
            }
          }
        }
      }

      console.log('‚úÖ JSON validation passed');
      return true;
    } catch (error) {
      console.error('‚ùå JSON validation error:', error);
      return false;
    }
  }

  // SAVE butonunu yeniden aktif et (Flutter'dan √ßaƒürƒ±lacak)
  function onSaveComplete(success) {
    var saveButton = document.querySelector('input[type="submit"]');
    saveButton.disabled = false;

    if (success) {
      saveButton.value = 'SAVED ‚úì';
      saveButton.style.backgroundColor = '#4CAF50'; // Ye≈üil
      console.log('‚úÖ Settings saved successfully');

      // 2 saniye sonra butonu normal haline getir
      setTimeout(function() {
        saveButton.value = 'SAVE';
        saveButton.style.backgroundColor = '#FFD700'; // Sarƒ±
      }, 2000);
    } else {
      saveButton.value = 'SAVE FAILED ‚úó';
      saveButton.style.backgroundColor = '#f44336'; // Kƒ±rmƒ±zƒ±
      console.log('‚ùå Save failed');

      // 3 saniye sonra butonu normal haline getir
      setTimeout(function() {
        saveButton.value = 'SAVE';
        saveButton.style.backgroundColor = '#FFD700'; // Sarƒ±
      }, 3000);
    }
  }

  // Flutter'dan t√ºm JSON'u al ve preset selector'ƒ± doldur
  function initializeWithFullJson(jsonString) {
    try {
      const parsedJson = JSON.parse(jsonString);

      // JSON ≈üemasƒ±nƒ± doƒürula
      if (!validateDeviceJson(parsedJson)) {
        alert('Invalid device configuration received. Please reconnect to device.');
        console.error('‚ùå JSON validation failed');
        return;
      }

      fullDeviceJson = parsedJson;
      console.log('‚úÖ Full JSON received and validated:', fullDeviceJson);

      // Preset selector'ƒ± doldur
      var selector = document.getElementById('preset-selector');
      selector.innerHTML = ''; // Mevcut options'larƒ± temizle

      if (fullDeviceJson.presets && fullDeviceJson.presets.length > 0) {
        fullDeviceJson.presets.forEach(function(preset, index) {
          var option = document.createElement('option');
          option.value = preset['preset-index']; // preset-index kullan
          option.text = preset['preset-name'] || ('Preset ' + preset['preset-index']);
          selector.appendChild(option);
        });

        // selected-preset-index deƒüerine g√∂re se√ß
        var selectedIndex = fullDeviceJson['selected-preset-index'] || 1;
        selector.value = selectedIndex;

        console.log('üìã Preset selector dolduruldu, selected-preset-index:', selectedIndex);

        // ƒ∞lk preset'i y√ºkle
        onPresetChanged();

        // Delete butonunu g√ºncelle
        updateDeleteButton();
      } else {
        console.error('‚ùå No presets found in JSON');
      }

    } catch (e) {
      console.error('‚ùå Error parsing full JSON:', e);
    }
  }

  // Global deƒüi≈üken - ilk y√ºklemede modal g√∂sterme
  var isInitialLoad = true;

  // Preset deƒüi≈ütiƒüinde √ßaƒürƒ±lƒ±r
  function onPresetChanged() {
    var selector = document.getElementById('preset-selector');
    var selectedPresetIndex = parseInt(selector.value);

    console.log('üîÑ Preset changed to index:', selectedPresetIndex);

    if (!fullDeviceJson || !fullDeviceJson.presets) {
      console.error('‚ùå Full JSON not loaded yet');
      return;
    }

    // Se√ßilen preset'i bul
    var selectedPreset = fullDeviceJson.presets.find(function(preset) {
      return preset['preset-index'] === selectedPresetIndex;
    });

    if (selectedPreset) {
      // model-name'i JSON root seviyesinden ekle
      var presetWithModel = {
        'model-name': fullDeviceJson['model-name'] || 'Unknown',
        ...selectedPreset
      };

      console.log('‚úÖ Loading preset:', presetWithModel['preset-name']);

      // Mevcut loadPresetDataFromJSON fonksiyonunu kullan
      var jsonString = JSON.stringify(presetWithModel);
      loadPresetDataFromJSON(jsonString);

      // ƒ∞lk y√ºklemeden sonra preset deƒüi≈üikliklerinde info modal g√∂ster
      if (!isInitialLoad) {
        showPresetChangedModal(selectedPreset['preset-name']);
      }
    } else {
      console.error('‚ùå Preset not found with index:', selectedPresetIndex);
    }

    // Delete butonunu g√ºncelle (default preset korumalƒ±)
    updateDeleteButton();

    // ƒ∞lk y√ºkleme flag'ini kaldƒ±r
    if (isInitialLoad) {
      isInitialLoad = false;
    }
  }

  // Preset changed modal g√∂ster
  function showPresetChangedModal(presetName) {
    document.getElementById('changedPresetName').textContent = '"' + presetName + '"';
    document.getElementById('presetChangedModal').classList.add('show');
  }

  // Preset changed modal kapat
  function closePresetChangedModal() {
    document.getElementById('presetChangedModal').classList.remove('show');
  }

  // Delete butonunu g√ºncelle
  function updateDeleteButton() {
    var selector = document.getElementById('preset-selector');
    var deleteBtn = document.querySelector('.delete-btn');
    var selectedIndex = parseInt(selector.value);

    // Index 1 (default) veya tek preset varsa delete disable
    if (selectedIndex === 1 || fullDeviceJson.presets.length <= 1) {
      deleteBtn.disabled = true;
    } else {
      deleteBtn.disabled = false;
    }
  }

  // Add preset modal g√∂ster
  function addNewPreset() {
    if (!fullDeviceJson) {
      alert('Device JSON not loaded yet');
      return;
    }

    // Input'u temizle ve modal'ƒ± g√∂ster
    var input = document.getElementById('addPresetInput');
    input.value = '';
    validateAddPresetInput(); // Butonu disable et
    document.getElementById('addModal').classList.add('show');

    // Input'a focus ver (k√º√ß√ºk gecikme ile)
    setTimeout(function() {
      input.focus();
    }, 300);
  }

  // Add preset input validasyonu
  function validateAddPresetInput() {
    var input = document.getElementById('addPresetInput');
    var confirmBtn = document.getElementById('addPresetConfirmBtn');
    var presetName = input.value.trim();

    // Bo≈ü deƒüilse butonu aktif et
    if (presetName.length > 0) {
      confirmBtn.disabled = false;
    } else {
      confirmBtn.disabled = true;
    }
  }

  // Add preset modal kapat
  function closeAddModal() {
    document.getElementById('addModal').classList.remove('show');
  }

  // Add preset onayla
  function confirmAddPreset() {
    var input = document.getElementById('addPresetInput');
    var presetName = input.value.trim();

    if (presetName.length === 0) {
      return;
    }

    // ƒ∞smi 20 karaktere kƒ±sƒ±tla
    presetName = presetName.substring(0, 20);

    console.log('‚ûï Adding new preset:', presetName);

    // Yeni preset index'i bul (en y√ºksek index + 1)
    var maxIndex = Math.max(...fullDeviceJson.presets.map(p => p['preset-index']));
    var newIndex = maxIndex + 1;

    // Mevcut se√ßili preset'in verilerini kopyala
    var selector = document.getElementById('preset-selector');
    var currentIndex = parseInt(selector.value);
    var currentPreset = fullDeviceJson.presets.find(p => p['preset-index'] === currentIndex);

    // Yeni preset objesi olu≈ütur (mevcut preset'in kopyasƒ±)
    var newPreset = JSON.parse(JSON.stringify(currentPreset)); // Deep copy
    newPreset['preset-name'] = presetName;
    newPreset['preset-index'] = newIndex;

    // fullDeviceJson'a ekle
    fullDeviceJson.presets.push(newPreset);

    // Selector'ƒ± g√ºncelle
    var option = document.createElement('option');
    option.value = newIndex;
    option.text = presetName;
    selector.appendChild(option);

    // Yeni preset'i se√ß
    selector.value = newIndex;
    onPresetChanged();

    console.log('‚úÖ Preset added locally, click SAVE to apply changes');

    // Delete butonunu g√ºncelle
    updateDeleteButton();

    // Modal'ƒ± kapat
    closeAddModal();
  }

  // Global deƒüi≈üken - modal onay i√ßin
  var pendingDeleteIndex = null;

  // Modal confirmation dialog g√∂ster
  function showConfirmModal(presetName, presetIndex) {
    document.getElementById('modalPresetName').textContent = '"' + presetName + '"';
    pendingDeleteIndex = presetIndex;
    document.getElementById('confirmModal').classList.add('show');
  }

  // Modal'ƒ± kapat ve sonucu i≈üle
  function closeConfirmModal(confirmed) {
    document.getElementById('confirmModal').classList.remove('show');

    if (confirmed && pendingDeleteIndex !== null) {
      performDelete(pendingDeleteIndex);

      // Silme i≈üleminden sonra info modal g√∂ster
      setTimeout(function() {
        showInfoModal();
      }, 300); // Confirm modal kapanma animasyonu i√ßin bekle
    }

    pendingDeleteIndex = null;
  }

  // Info modal g√∂ster
  function showInfoModal() {
    document.getElementById('infoModal').classList.add('show');
  }

  // Info modal kapat
  function closeInfoModal() {
    document.getElementById('infoModal').classList.remove('show');
  }

  // Servo Range Modal fonksiyonlarƒ±
  function showServoRangeModal(enteredValue, validRange, revertedValue) {
    document.getElementById('servoEnteredValue').textContent = enteredValue;
    document.getElementById('servoValidRange').textContent = validRange;
    document.getElementById('servoRevertedValue').textContent = revertedValue;
    document.getElementById('servoRangeModal').classList.add('show');
  }

  function closeServoRangeModal() {
    document.getElementById('servoRangeModal').classList.remove('show');
  }

  // Time Sequence Modal fonksiyonlarƒ±
  function showTimeSequenceModal(previousValue, enteredValue, revertedValue) {
    // Modal i√ßeriƒüini g√ºncelle
    document.getElementById('timePreviousValue').textContent = previousValue + ' s';
    document.getElementById('timeEnteredValue').textContent = enteredValue + ' s';
    document.getElementById('timeRevertedValue').textContent = revertedValue + ' s';

    // Modal'ƒ± g√∂ster
    document.getElementById('timeSequenceModal').classList.add('show');
  }

  function closeTimeSequenceModal() {
    document.getElementById('timeSequenceModal').classList.remove('show');
  }

  // Pin Conflict Modal fonksiyonlarƒ±
  function showPinConflictModal(pinNumber, existingComponent, attemptedComponent, revertedValue) {
    // Modal i√ßeriƒüini g√ºncelle
    document.getElementById('conflictPinNumber').textContent = `S${pinNumber}`;
    document.getElementById('conflictExistingComponent').textContent = existingComponent;
    document.getElementById('conflictAttemptedComponent').textContent = attemptedComponent;

    const revertedLabel = revertedValue === '0' ? 'Not Used' : `S${revertedValue}`;
    document.getElementById('conflictRevertedValue').textContent = revertedLabel;

    // Modal'ƒ± g√∂ster
    document.getElementById('pinConflictModal').classList.add('show');
  }

  function closePinConflictModal() {
    document.getElementById('pinConflictModal').classList.remove('show');
  }

  // Ger√ßek silme i≈ülemi
  function performDelete(selectedIndex) {
    var selector = document.getElementById('preset-selector');

    console.log('üóëÔ∏è Deleting preset index:', selectedIndex);

    // fullDeviceJson'dan sil
    fullDeviceJson.presets = fullDeviceJson.presets.filter(p => p['preset-index'] !== selectedIndex);

    // Selector'dan sil
    selector.remove(selector.selectedIndex);

    // ƒ∞lk preset'i se√ß
    if (fullDeviceJson.presets.length > 0) {
      selector.value = fullDeviceJson.presets[0]['preset-index'];
      onPresetChanged();
    }

    console.log('‚úÖ Preset deleted locally, click SAVE to apply changes');

    // Delete butonunu g√ºncelle
    updateDeleteButton();
  }

  // Mevcut preset'i sil (HTML i√ßinde, SAVE'e kadar lokal)
  function deleteCurrentPreset() {
    var selector = document.getElementById('preset-selector');
    var selectedIndex = parseInt(selector.value);

    if (!fullDeviceJson) {
      alert('Device JSON not loaded yet');
      return;
    }

    // Index 1 (default) korumalƒ±
    if (selectedIndex === 1) {
      alert('Cannot delete default preset');
      return;
    }

    // Tek preset kaldƒ±ysa silme
    if (fullDeviceJson.presets.length <= 1) {
      alert('Cannot delete the last preset');
      return;
    }

    // Preset ismini bul ve modal g√∂ster
    var presetName = fullDeviceJson.presets.find(p => p['preset-index'] === selectedIndex)['preset-name'];
    showConfirmModal(presetName, selectedIndex);
  }

  // Form g√∂nderildiƒüinde bu fonksiyon √ßalƒ±≈üacaktƒ±r
  // Mevcut form deƒüerlerini alƒ±p selected preset'e kaydet, sonra t√ºm JSON'u g√∂nder
  function submitForm(event) {
    event.preventDefault(); // Formun normal submit i≈ülemini durdur

    try {
      if (!fullDeviceJson) {
        alert('Device JSON not loaded yet');
        return false;
      }

      // Eƒüer absolute mode'daysa, √∂nce interval'e d√∂n√º≈üt√ºr (JSON'a kaydetmek i√ßin)
      const currentTimeMode = window.currentTimeMode || 'interval';
      if (currentTimeMode === 'absolute') {
        convertAllTimeInputs('interval');
      }

      // SAVE butonunu disable et ve "SAVING..." yap
      var saveButton = document.querySelector('input[type="submit"]');
      saveButton.disabled = true;
      saveButton.value = 'SAVING...';
      saveButton.style.backgroundColor = '#CCA000'; // Koyu sarƒ±

      console.log('üíæ SAVE button clicked, updating current preset with form values...');

    // Mevcut se√ßili preset'i bul
    var selector = document.getElementById('preset-selector');
    var selectedIndex = parseInt(selector.value);
    var currentPreset = fullDeviceJson.presets.find(p => p['preset-index'] === selectedIndex);

    if (!currentPreset) {
      alert('Current preset not found');
      return false;
    }

    // Form deƒüerlerini currentPreset'e kaydet
    // Strobe value
    currentPreset['strobe-value'] = parseInt(document.getElementById('strobe-value').value);

    // Servo pins
    currentPreset['ru-servo-pin'] = parseInt(document.getElementById('ru-servo-pin').value);
    currentPreset['tl-servo-pin'] = parseInt(document.getElementById('tl-servo-pin').value);
    currentPreset['ww-servo-pin'] = parseInt(document.getElementById('ww-servo-pin').value);
    currentPreset['ww2-servo-pin'] = parseInt(document.getElementById('ww2-servo-pin').value);

    // RDT Rx pin
    currentPreset['rdt-rx-pin'] = parseInt(document.getElementById('rdt-rx-pin').value);

    // Hook settings
    currentPreset['hook-type'] = document.getElementById('hook-type').value;

    // Hook sw1 ve sw2 (2switch ve 2switch_servo i√ßin)
    var hookSw1Elem = document.getElementById('hook-sw1-pin');
    if (hookSw1Elem) {
      currentPreset['hook-sw1-pin'] = parseInt(hookSw1Elem.value);
    } else {
      currentPreset['hook-sw1-pin'] = -1; // Kullanƒ±lmƒ±yor
    }

    var hookSw2Elem = document.getElementById('hook-sw2-pin');
    if (hookSw2Elem) {
      currentPreset['hook-sw2-pin'] = parseInt(hookSw2Elem.value);
    } else {
      currentPreset['hook-sw2-pin'] = -1; // Kullanƒ±lmƒ±yor
    }

    // Hook servo (2switch_servo ve rotary_servo i√ßin)
    var hookServoElem = document.getElementById('hook-servo-pin');
    if (hookServoElem) {
      currentPreset['hook-servo-pin'] = parseInt(hookServoElem.value);
    } else {
      currentPreset['hook-servo-pin'] = -1; // Kullanƒ±lmƒ±yor
    }

    // Encoder pin (rotary_servo i√ßin)
    var encoderPinElem = document.getElementById('encoder-pin');
    if (encoderPinElem) {
      currentPreset['encoder-pin'] = parseInt(encoderPinElem.value);
    } else {
      currentPreset['encoder-pin'] = -1; // Kullanƒ±lmƒ±yor
    }

    // Auto DT settings
    currentPreset['max-sink-value'] = parseFloat(document.getElementById('max-sink-value').value);
    currentPreset['max-altitude-value'] = parseFloat(document.getElementById('max-altitude-value').value);
    currentPreset['flip-loop-detection'] = document.getElementById('flip-loop-detection').checked ? 1 : 0;

    // Geofencing DT settings
    const geofenceData = getGeofenceData();
    currentPreset['geofencing'] = geofenceData;

    // UI Preferences - Range Mode and Time Mode
    currentPreset['range-mode'] = window.currentServoRangeMode || '1000-2000';
    currentPreset['time-mode'] = window.currentTimeMode || 'interval';

    // Timers - nested structure
    if (!currentPreset.timers) {
      currentPreset.timers = {};
    }

    // Helper function to update timer
    function updateTimer(key) {
      if (!currentPreset.timers[key]) {
        currentPreset.timers[key] = {};
      }
      var timer = currentPreset.timers[key];

      // Time field (if exists)
      var timeElem = document.getElementById(key + '-time');
      if (timeElem) {
        timer.time = parseFloat(timeElem.value);
      }

      // Servo positions - UI formatƒ±ndan PWM'e d√∂n√º≈üt√ºr
      const currentMode = window.currentServoRangeMode || '1000-2000';

      const ruUiValue = parseInt(document.getElementById(key + '-ru').value);
      const tlUiValue = parseInt(document.getElementById(key + '-tl').value);
      const wwUiValue = parseInt(document.getElementById(key + '-ww').value);
      const ww2UiValue = parseInt(document.getElementById(key + '-ww2').value);

      // UI deƒüerlerini PWM'e d√∂n√º≈üt√ºr (JSON'da her zaman PWM olarak saklanƒ±r)
      timer.ru = uiValueToPwm(ruUiValue, currentMode);
      timer.tl = uiValueToPwm(tlUiValue, currentMode);
      timer.ww = uiValueToPwm(wwUiValue, currentMode);
      timer.ww2 = uiValueToPwm(ww2UiValue, currentMode);
    }

    // Update all timers
    updateTimer('on');
    updateTimer('str');
    updateTimer('cir');
    updateTimer('ola');
    updateTimer('pu1');
    updateTimer('pu2');
    updateTimer('cr1');
    updateTimer('cr2');
    updateTimer('cr3');
    updateTimer('bu1');
    updateTimer('bu2');
    updateTimer('bu3');
    updateTimer('fg');
    updateTimer('gl');
    updateTimer('dt');
    updateTimer('pk');

    console.log('‚úÖ Current preset updated with form values');

    // Model name'i g√ºncelle (JSON root seviyesinde)
    var modelNameElem = document.getElementById('model-name');
    if (modelNameElem && modelNameElem.value) {
      fullDeviceJson['model-name'] = modelNameElem.value;
    }

    // selected-preset-index'i g√ºncelle
    fullDeviceJson['selected-preset-index'] = selectedIndex;

      // T√ºm JSON'u string'e √ßevir ve FormChannel'a g√∂nder
      var jsonString = JSON.stringify(fullDeviceJson);

      // FormChannel kontrol√º
      if (typeof FormChannel === 'undefined' || !FormChannel.postMessage) {
        throw new Error('FormChannel not available. Not running in WebView?');
      }

      console.log('üì§ Sending full JSON to Flutter (' + jsonString.length + ' chars)');
      FormChannel.postMessage(jsonString);

      return false; // Formun normal submit i≈ülemini engelle

    } catch (error) {
      console.error('‚ùå Error in submitForm:', error);
      alert('Failed to save configuration: ' + error.message);
      onSaveComplete(false);
      return false;
    }
  }

    document.querySelectorAll('input[name="strobe-bit"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            let value = 0;
            document.querySelectorAll('input[name="strobe-bit"]').forEach(cb => {
                if (cb.checked) {
                    value += parseInt(cb.value);
                }
            });
            document.getElementById('strobe-value').value = value;
            updateStrobeAnimation(); // LED animasyonunu g√ºncelle
        });
    });

    // Strobe LED animasyonu i√ßin deƒüi≈ükenler
    let strobeInterval;
    let strobeStep = 0;
    const STROBE_PERIOD = 125; // 1 saniye / 8 adƒ±m = 125ms

    function updateStrobeAnimation() {
        if (strobeInterval) {
            clearInterval(strobeInterval);
        }

        const strobeValue = parseInt(document.getElementById('strobe-value').value);
        const led = document.getElementById('strobeLed');
        let isBreak = false;
        let breakCounter = 0;

        strobeInterval = setInterval(() => {
            if (isBreak) {
                led.classList.remove('active'); // Kapalƒ±
                breakCounter++;
                if (breakCounter >= 8) { // 1 saniye bekleme (8 * 125ms)
                    isBreak = false;
                    breakCounter = 0;
                }
            } else {
                const bitMask = 1 << (7 - strobeStep);
                if (strobeValue & bitMask) {
                    led.classList.add('active'); // A√ßƒ±k - glow efekti
                } else {
                    led.classList.remove('active'); // Kapalƒ±
                }
                strobeStep = (strobeStep + 1) % 8;
                if (strobeStep === 0) {
                    isBreak = true;
                }
            }
        }, STROBE_PERIOD);
    }

    // Sayfa y√ºklendiƒüinde animasyonu ba≈ülat
    document.addEventListener('DOMContentLoaded', function() {
        updateStrobeAnimation();

        // Range mode header'larƒ±nƒ± ba≈ülangƒ±√ß mode'una g√∂re g√ºncelle
        const initialMode = document.getElementById('servo-range-mode')?.value || '1000-2000';
        let suffix = '';
        switch(initialMode) {
            case '0-100':
                suffix = ' (%)';
                break;
            case '0-255':
                suffix = '';
                break;
            case '1000-2000':
                suffix = ' (¬µs)';
                break;
        }
        document.getElementById('header-ru').textContent = 'RU' + suffix;
        document.getElementById('header-tl').textContent = 'TL' + suffix;
        document.getElementById('header-ww').textContent = 'WW' + suffix;
        document.getElementById('header-ww2').textContent = 'WW2' + suffix;
    });

    // Sayfa kapanmadan √∂nce interval'i temizle (memory leak √∂nleme)
    window.addEventListener('beforeunload', function() {
        if (strobeInterval) {
            clearInterval(strobeInterval);
            console.log('üßπ Strobe interval cleared on page unload');
        }
    });

    // WebView kapandƒ±ƒüƒ±nda veya sayfa gizlendiƒüinde temizle
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && strobeInterval) {
            clearInterval(strobeInterval);
            console.log('üßπ Strobe interval cleared (page hidden)');
        } else if (!document.hidden) {
            // Sayfa tekrar g√∂r√ºn√ºr olduƒüunda yeniden ba≈ülat
            updateStrobeAnimation();
        }
    });

    // ========== NUMBER INPUT MODAL FUNCTIONS ==========
    let currentEditingInput = null;
    let currentInputString = '';
    let previousValue = '0.00';
    let isServoInput = false;

    // Servo deƒüerleri i√ßin √∂nceki deƒüerleri sakla
    const previousServoValues = {};

    // Time input'larƒ±na tƒ±klandƒ±ƒüƒ±nda √∂zel modal a√ß
    document.querySelectorAll('input[id$="-time"]').forEach(input => {
        // Mobil klavyeyi engelle - read-only yap
        input.setAttribute('readonly', 'readonly');
        input.style.cursor = 'pointer';

        // Click event - modal a√ß
        input.addEventListener('click', function(e) {
            e.preventDefault();
            openNumberInputModal(this, 'time');
        });

        // Ba≈ülangƒ±√ß deƒüerini kaydet
        previousTimeValues[input.id] = input.value;
    });

    // Servo input'larƒ±na tƒ±klandƒ±ƒüƒ±nda √∂zel modal a√ß (RU, TL, WW, WW2)
    document.querySelectorAll('input[id$="-ru"], input[id$="-tl"], input[id$="-ww"], input[id$="-ww2"]').forEach(input => {
        // Mobil klavyeyi engelle - read-only yap
        input.setAttribute('readonly', 'readonly');
        input.style.cursor = 'pointer';

        // Click event - modal a√ß
        input.addEventListener('click', function(e) {
            e.preventDefault();
            openNumberInputModal(this, 'servo');
        });

        // Ba≈ülangƒ±√ß deƒüerini kaydet (eƒüer yoksa)
        if (!previousServoValues[input.id]) {
            previousServoValues[input.id] = input.value;
        }
    });

    // Number input modal a√ß
    function openNumberInputModal(inputElement, inputType) {
        currentEditingInput = inputElement;
        previousValue = inputElement.value;
        currentInputString = inputElement.value; // Mevcut deƒüeri ba≈ülat
        isServoInput = (inputType === 'servo');

        // Modal ba≈ülƒ±ƒüƒ±nƒ± ayarla
        if (inputType === 'time') {
            const phaseKey = inputElement.id.replace('-time', '').toUpperCase();
            document.getElementById('numberInputTitle').textContent = `${phaseKey} Time`;
            document.getElementById('numberDisplayUnit').textContent = 's';
            document.getElementById('previousValueDisplay').textContent = previousValue + 's';
        } else {
            // Servo input
            const parts = inputElement.id.split('-');
            const phaseKey = parts[0].toUpperCase();
            const servoKey = parts[1].toUpperCase();
            document.getElementById('numberInputTitle').textContent = `${phaseKey} ${servoKey}`;

            // Birim - range mode'a g√∂re
            const currentMode = window.currentServoRangeMode || '1000-2000';
            let unit = '';
            switch(currentMode) {
                case '0-100':
                    unit = '%';
                    break;
                case '0-255':
                    unit = '';
                    break;
                case '1000-2000':
                    unit = '¬µs';
                    break;
            }
            document.getElementById('numberDisplayUnit').textContent = unit;
            document.getElementById('previousValueDisplay').textContent = previousValue + unit;
        }

        // Mevcut deƒüeri g√∂ster (ba≈ülangƒ±√ßta bo≈ü)
        updateNumberDisplay();

        // Error mesajƒ±nƒ± gizle
        hideNumberError();

        // Modal'ƒ± g√∂ster
        document.getElementById('numberInputModal').classList.add('show');
    }

    // Number input modal kapat
    function closeNumberInputModal() {
        document.getElementById('numberInputModal').classList.remove('show');
        currentEditingInput = null;
        currentInputString = '';
        hideNumberError();
    }

    // Error message g√∂ster
    function showNumberError(message) {
        const errorDiv = document.getElementById('numberErrorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        // Shake animasyonunu yeniden tetikle
        errorDiv.style.animation = 'none';
        setTimeout(() => {
            errorDiv.style.animation = 'shake 0.5s';
        }, 10);
    }

    // Error message gizle
    function hideNumberError() {
        document.getElementById('numberErrorMessage').style.display = 'none';
    }

    // Rakam gir
    function inputDigit(digit) {
        // Error mesajƒ±nƒ± gizle (kullanƒ±cƒ± tekrar giri≈ü yapƒ±yor)
        hideNumberError();

        // Nokta kontrol√º - sadece bir tane olabilir
        if (digit === '.' && currentInputString.includes('.')) {
            return;
        }

        // ƒ∞lk karakter nokta ise ba≈üa 0 ekle
        if (digit === '.' && currentInputString === '') {
            currentInputString = '0.';
        } else {
            currentInputString += digit;
        }

        updateNumberDisplay();
    }

    // Son rakamƒ± sil (backspace)
    function deleteDigit() {
        // Error mesajƒ±nƒ± gizle (kullanƒ±cƒ± tekrar giri≈ü yapƒ±yor)
        hideNumberError();

        if (currentInputString.length > 0) {
            currentInputString = currentInputString.slice(0, -1);
            updateNumberDisplay();
        }
    }

    // Display g√ºncelle
    function updateNumberDisplay() {
        if (currentInputString === '') {
            document.getElementById('numberDisplayValue').textContent = '_';
        } else {
            document.getElementById('numberDisplayValue').textContent = currentInputString;
        }
    }

    // Gereksiz sƒ±fƒ±rlarƒ± kaldƒ±r
    function formatNumber(value) {
        // 2 ondalƒ±k basamaƒüa yuvarla, sonra gereksiz sƒ±fƒ±rlarƒ± kaldƒ±r
        const rounded = Math.round(value * 100) / 100;
        return rounded.toString();
    }

    // Son basamaƒüa g√∂re step hesapla (maksimum 2 ondalƒ±k basamak)
    function getSmartStep() {
        if (currentInputString === '' || currentInputString === '_') {
            return 1;
        }

        const str = currentInputString;

        // Nokta var mƒ±?
        if (str.includes('.')) {
            const parts = str.split('.');
            const decimalPart = parts[1] || '';
            const decimalPlaces = decimalPart.length;

            if (decimalPlaces === 0) {
                return 1; // "5." ‚Üí +1
            } else if (decimalPlaces === 1) {
                return 0.1; // "5.2" ‚Üí +0.1
            } else {
                // 2 veya daha fazla basamak ‚Üí maksimum 2 basamak
                return 0.01; // "5.25" ‚Üí +0.01
            }
        } else {
            // Tam sayƒ±
            return 1; // "1234" ‚Üí +1
        }
    }

    // Deƒüer artƒ±r
    function incrementValue() {
        hideNumberError();

        const step = getSmartStep();
        const hadDecimal = currentInputString.includes('.');
        let currentValue = parseFloat(currentInputString) || 0;
        currentValue += step;

        // Floating point hatasƒ± d√ºzelt - maksimum 2 ondalƒ±k basamak
        currentValue = Math.round(currentValue * 100) / 100;

        // Format: eƒüer √∂nceden nokta varsa, basamak sayƒ±sƒ±nƒ± koru
        if (hadDecimal) {
            const parts = currentInputString.split('.');
            const decimalPlaces = parts[1] ? parts[1].length : 1;

            if (decimalPlaces === 1) {
                currentInputString = currentValue.toFixed(1);
            } else {
                currentInputString = currentValue.toFixed(2);
            }
        } else {
            // Nokta yoksa normal string
            currentInputString = currentValue.toString();
        }

        updateNumberDisplay();
    }

    // Deƒüer azalt
    function decrementValue() {
        hideNumberError();

        const step = getSmartStep();
        const hadDecimal = currentInputString.includes('.');
        let currentValue = parseFloat(currentInputString) || 0;
        currentValue -= step;

        // Negatif olmasƒ±nƒ± engelle
        if (currentValue < 0) {
            currentValue = 0;
        }

        // Floating point hatasƒ± d√ºzelt - maksimum 2 ondalƒ±k basamak
        currentValue = Math.round(currentValue * 100) / 100;

        // Format: eƒüer √∂nceden nokta varsa, basamak sayƒ±sƒ±nƒ± koru
        if (hadDecimal) {
            const parts = currentInputString.split('.');
            const decimalPlaces = parts[1] ? parts[1].length : 1;

            if (decimalPlaces === 1) {
                currentInputString = currentValue.toFixed(1);
            } else {
                currentInputString = currentValue.toFixed(2);
            }
        } else {
            // Nokta yoksa normal string
            currentInputString = currentValue.toString();
        }

        updateNumberDisplay();
    }

    // Deƒüeri onayla ve input'a kaydet
    function confirmNumberValue() {
        if (!currentEditingInput) return;

        // Bo≈ü ise √∂nceki deƒüeri koru
        if (currentInputString === '') {
            closeNumberInputModal();
            return;
        }

        // Sayƒ±ya d√∂n√º≈üt√ºr
        let numValue = parseFloat(currentInputString);

        // Ge√ßersiz sayƒ± kontrol√º
        if (isNaN(numValue)) {
            showNumberError('‚ö†Ô∏è Invalid number!');
            return;
        }

        // Negatif deƒüerleri kontrol et
        if (numValue < 0) {
            showNumberError('‚ö†Ô∏è Negative values not allowed!');
            return;
        }

        if (isServoInput) {
            // SERVO INPUT - Range kontrol√º ve blur validation
            const oldValue = currentEditingInput.value;
            previousServoValues[currentEditingInput.id] = oldValue;

            // Tam sayƒ± formatƒ± (servo i√ßin ondalƒ±k yok)
            currentEditingInput.value = Math.round(numValue).toString();

            // Servo validation
            const isValid = validateServoRange(currentEditingInput);

            if (!isValid) {
                // Validation ba≈üarƒ±sƒ±z - modal a√ßƒ±k kalsƒ±n, uyarƒ± g√∂ster
                const currentMode = window.currentServoRangeMode || '1000-2000';
                const limits = getRangeLimits();
                let rangeText = '';
                switch(currentMode) {
                    case '0-100':
                        rangeText = `${limits.min}% - ${limits.max}%`;
                        break;
                    case '0-255':
                        rangeText = `${limits.min} - ${limits.max}`;
                        break;
                    case '1000-2000':
                        rangeText = `${limits.min}¬µs - ${limits.max}¬µs`;
                        break;
                }
                showNumberError(`‚ö†Ô∏è Out of range! Valid: ${rangeText}`);
                // Input deƒüerini √∂nceki haline d√∂nd√ºr
                currentEditingInput.value = oldValue;
                // Modal'ƒ± kapatma
                return;
            }

            // Ba≈üarƒ±lƒ±ysa √∂nceki deƒüeri g√ºncelle
            previousServoValues[currentEditingInput.id] = currentEditingInput.value;
        } else {
            // TIME INPUT - 2 ondalƒ±k basamak
            const oldValue = currentEditingInput.value;
            previousTimeValues[currentEditingInput.id] = oldValue;

            currentEditingInput.value = numValue.toFixed(2);

            // Absolute mode'da sƒ±ra kontrol√º
            const isValid = validateTimeSequence(currentEditingInput);

            if (!isValid) {
                // Validation ba≈üarƒ±sƒ±z - modal a√ßƒ±k kalsƒ±n, uyarƒ± g√∂ster
                showNumberError('‚ö†Ô∏è Time must be ‚â• previous phase (Absolute mode)');
                // Input deƒüerini √∂nceki haline d√∂nd√ºr
                currentEditingInput.value = oldValue;
                // Modal'ƒ± kapatma
                return;
            }

            // Ba≈üarƒ±lƒ±ysa √∂nceki deƒüeri g√ºncelle
            previousTimeValues[currentEditingInput.id] = currentEditingInput.value;
        }

        // Modal'ƒ± kapat (sadece validation ba≈üarƒ±lƒ±ysa buraya gelir)
        closeNumberInputModal();
    }

    // ========== END NUMBER INPUT MODAL FUNCTIONS ==========

    // ========== SERVO RANGE MODE FUNCTIONS ==========

    // Range mode'a g√∂re input limitlerini al
    function getRangeLimits() {
        const mode = document.getElementById('servo-range-mode')?.value || '1000-2000';
        switch(mode) {
            case '0-100':
                return { min: 0, max: 100 };
            case '0-255':
                return { min: 0, max: 255 };
            case '1000-2000':
                return { min: 1000, max: 2000 };
            default:
                return { min: 1000, max: 2000 };
        }
    }

    // UI deƒüerini PWM deƒüerine (1000-2000¬µs) d√∂n√º≈üt√ºr
    function uiValueToPwm(uiValue, mode) {
        const value = parseInt(uiValue);
        if (isNaN(value)) return 1500; // Default center

        switch(mode) {
            case '0-100':
                // 0-100 ‚Üí 1000-2000
                return Math.round(1000 + (value * 10));
            case '0-255':
                // 0-255 ‚Üí 1000-2000
                return Math.round(1000 + (value * (1000 / 255)));
            case '1000-2000':
                // Zaten PWM deƒüeri
                return value;
            default:
                return value;
        }
    }

    // PWM deƒüerini (1000-2000¬µs) UI deƒüerine d√∂n√º≈üt√ºr
    function pwmToUiValue(pwmValue, mode) {
        const value = parseInt(pwmValue);
        if (isNaN(value)) return mode === '0-100' ? 50 : mode === '0-255' ? 127 : 1500;

        switch(mode) {
            case '0-100':
                // 1000-2000 ‚Üí 0-100
                return Math.round((value - 1000) / 10);
            case '0-255':
                // 1000-2000 ‚Üí 0-255
                return Math.round((value - 1000) * (255 / 1000));
            case '1000-2000':
                // Zaten PWM deƒüeri
                return value;
            default:
                return value;
        }
    }

    // Range mode deƒüi≈ütiƒüinde header'larƒ± ve input deƒüerlerini g√ºncelle
    function updateRangeModeLabels() {
        const mode = document.getElementById('servo-range-mode').value;
        let suffix = '';

        switch(mode) {
            case '0-100':
                suffix = ' (%)';
                break;
            case '0-255':
                suffix = '';
                break;
            case '1000-2000':
                suffix = ' (¬µs)';
                break;
        }

        // Header'larƒ± g√ºncelle
        document.getElementById('header-ru').textContent = 'RU' + suffix;
        document.getElementById('header-tl').textContent = 'TL' + suffix;
        document.getElementById('header-ww').textContent = 'WW' + suffix;
        document.getElementById('header-ww2').textContent = 'WW2' + suffix;

        // T√ºm servo input deƒüerlerini yeni range'e d√∂n√º≈üt√ºr
        convertAllServoInputs(mode);
    }

    // T√ºm servo input'larƒ±nƒ± yeni range'e d√∂n√º≈üt√ºr
    function convertAllServoInputs(newMode) {
        const oldMode = window.currentServoRangeMode || '1000-2000';

        document.querySelectorAll('input[id$="-ru"], input[id$="-tl"], input[id$="-ww"], input[id$="-ww2"]').forEach(input => {
            const currentValue = parseInt(input.value);
            if (isNaN(currentValue)) return;

            // √ñnce PWM'e d√∂n√º≈üt√ºr (eski mode'dan)
            const pwmValue = uiValueToPwm(currentValue, oldMode);

            // Sonra yeni mode'a d√∂n√º≈üt√ºr
            const newValue = pwmToUiValue(pwmValue, newMode);

            input.value = newValue;
            previousServoValues[input.id] = newValue.toString();
        });

        // Mevcut mode'u kaydet
        window.currentServoRangeMode = newMode;
    }

    // ========== TIME MODE FUNCTIONS ==========

    // Timer phase sƒ±rasƒ± (PU1'den GL'ye kadar)
    const timerPhaseOrder = ['pu1', 'pu2', 'cr1', 'cr2', 'cr3', 'bu1', 'bu2', 'bu3', 'fg', 'gl'];

    // Interval deƒüerlerini Absolute'e d√∂n√º≈üt√ºr
    function intervalToAbsolute(intervalValue, phaseKey) {
        const phaseIndex = timerPhaseOrder.indexOf(phaseKey);
        if (phaseIndex === -1) return intervalValue; // Bilinmeyen phase

        let cumulativeTime = 0;

        // Bu phase'e kadar olan t√ºm interval'leri topla
        for (let i = 0; i <= phaseIndex; i++) {
            const phaseId = timerPhaseOrder[i];
            const timeInput = document.getElementById(phaseId + '-time');
            if (timeInput) {
                const value = parseFloat(timeInput.value) || 0;

                // Son phase ise (yani g√ºncellediƒüimiz), yeni deƒüeri kullan
                if (i === phaseIndex) {
                    cumulativeTime += intervalValue;
                } else {
                    cumulativeTime += value;
                }
            }
        }

        return cumulativeTime;
    }

    // Absolute deƒüeri Interval'e d√∂n√º≈üt√ºr
    function absoluteToInterval(absoluteValue, phaseKey) {
        const phaseIndex = timerPhaseOrder.indexOf(phaseKey);
        if (phaseIndex === -1) return absoluteValue; // Bilinmeyen phase

        // Bir √∂nceki phase'in absolute deƒüerini bul
        let previousAbsolute = 0;

        if (phaseIndex > 0) {
            // √ñnceki t√ºm interval'leri topla
            for (let i = 0; i < phaseIndex; i++) {
                const phaseId = timerPhaseOrder[i];
                const timeInput = document.getElementById(phaseId + '-time');
                if (timeInput) {
                    previousAbsolute += parseFloat(timeInput.value) || 0;
                }
            }
        }

        // Interval = Absolute - √ñnceki Absolute
        return absoluteValue - previousAbsolute;
    }

    // T√ºm time input'larƒ± yeni mode'a d√∂n√º≈üt√ºr
    function convertAllTimeInputs(newMode) {
        const oldMode = window.currentTimeMode || 'interval';

        if (oldMode === newMode) return; // Aynƒ± mode, hi√ßbir ≈üey yapma

        // √ñnce t√ºm mevcut deƒüerleri oku (d√∂n√º≈ü√ºm sƒ±rasƒ±nda deƒüi≈ümesinler diye)
        const currentValues = {};
        timerPhaseOrder.forEach(phaseKey => {
            const timeInput = document.getElementById(phaseKey + '-time');
            if (timeInput) {
                currentValues[phaseKey] = parseFloat(timeInput.value) || 0;
            }
        });

        // ≈ûimdi d√∂n√º≈ü√ºm√º yap
        if (newMode === 'absolute') {
            // Interval ‚Üí Absolute
            let cumulativeTime = 0;
            timerPhaseOrder.forEach(phaseKey => {
                const timeInput = document.getElementById(phaseKey + '-time');
                if (!timeInput) return;

                const intervalValue = currentValues[phaseKey] || 0;
                cumulativeTime += intervalValue;

                timeInput.value = cumulativeTime.toFixed(2);
                previousTimeValues[timeInput.id] = timeInput.value;
            });
        } else {
            // Absolute ‚Üí Interval
            let previousAbsolute = 0;
            timerPhaseOrder.forEach(phaseKey => {
                const timeInput = document.getElementById(phaseKey + '-time');
                if (!timeInput) return;

                const absoluteValue = currentValues[phaseKey] || 0;
                const intervalValue = absoluteValue - previousAbsolute;

                timeInput.value = intervalValue.toFixed(2);
                previousTimeValues[timeInput.id] = timeInput.value;

                previousAbsolute = absoluteValue;
            });
        }

        // Mevcut mode'u kaydet
        window.currentTimeMode = newMode;
    }

    // Time mode deƒüi≈ütiƒüinde
    function updateTimeMode() {
        const newMode = document.getElementById('time-mode').value;
        convertAllTimeInputs(newMode);
    }

    // Absolute mode'da time input validation
    function validateTimeSequence(inputElement) {
        const currentMode = window.currentTimeMode || 'interval';

        // Sadece absolute mode'da kontrol et
        if (currentMode !== 'absolute') return true;

        const phaseKey = inputElement.id.replace('-time', '');
        const phaseIndex = timerPhaseOrder.indexOf(phaseKey);

        if (phaseIndex === -1) return true; // Bilinmeyen phase
        if (phaseIndex === 0) return true; // ƒ∞lk phase, kontrol gereksiz

        const currentValue = parseFloat(inputElement.value) || 0;

        // Bir √∂nceki phase'in deƒüerini al
        const previousPhase = timerPhaseOrder[phaseIndex - 1];
        const previousInput = document.getElementById(previousPhase + '-time');

        if (!previousInput) return true;

        const previousValue = parseFloat(previousInput.value) || 0;

        // Absolute mode'da her deƒüer bir √∂ncekinden b√ºy√ºk veya e≈üit olmalƒ±
        if (currentValue < previousValue) {
            // Hata! Eski deƒüere geri d√∂n
            const oldValue = previousTimeValues[inputElement.id] || previousValue;
            inputElement.value = oldValue;

            // Modal g√∂ster
            showTimeSequenceModal(previousValue, currentValue, oldValue);

            return false;
        }

        return true;
    }

    // RU, TL, WW, WW2 inputlarƒ± i√ßin dinamik sƒ±nƒ±r kontrol√º
    // NOT: previousServoValues zaten NUMBER INPUT MODAL FUNCTIONS b√∂l√ºm√ºnde tanƒ±mlƒ± (line 2931)

    // Ba≈ülangƒ±√ß mode'unu kaydet
    window.currentServoRangeMode = document.getElementById('servo-range-mode')?.value || '1000-2000';

    // Servo range validation fonksiyonu (sadece number input modal i√ßin)
    function validateServoRange(input) {
        const limits = getRangeLimits();

        // Bo≈ü ise ge√ßerli kabul et
        if (input.value === '' || input.value === '-') {
            return true;
        }

        let value = parseInt(input.value);

        // Ge√ßersiz sayƒ± kontrol√º
        if (isNaN(value)) {
            return false;
        }

        // Range kontrol√º
        if (value < limits.min || value > limits.max) {
            return false;
        }

        // Ge√ßerli deƒüer
        return true;
    }

    // T√ºm servo input'larƒ±n ba≈ülangƒ±√ß deƒüerlerini kaydet
    document.querySelectorAll('input[id$="-ru"], input[id$="-tl"], input[id$="-ww"], input[id$="-ww2"]').forEach(input => {
        if (!previousServoValues[input.id]) {
            previousServoValues[input.id] = input.value;
        }
    });

    // Pin diyagramƒ±nƒ± g√ºncelleyen fonksiyon
    function updatePinDiagram() {
        // Servo pinlerini al
        const ruServoPin = parseInt(document.getElementById('ru-servo-pin').value);
        const tlServoPin = parseInt(document.getElementById('tl-servo-pin').value);
        const wwServoPin = parseInt(document.getElementById('ww-servo-pin').value);
        const ww2ServoPin = parseInt(document.getElementById('ww2-servo-pin').value);

        // RDT Rx pinini al
        const rdtRxPin = parseInt(document.getElementById('rdt-rx-pin').value);

        // Hook tipini al
        const hookType = document.getElementById('hook-type').value;

        // Pin Header Layout etiketlerini temizle (1-6)
        for (let i = 1; i <= 6; i++) {
            const label = document.getElementById(`s${i}-label`);
            if (label) label.textContent = "";
        }

        // Side Socket Layout - sol taraftaki fonksiyon etiketlerini temizle
        for (let socketPin = 4; socketPin <= 6; socketPin++) {
            const funcLabel = document.getElementById(`side-func-label-${socketPin}`);
            const funcBox = document.getElementById(`side-func-box-${socketPin}`);
            if (funcLabel) funcLabel.textContent = "";
            if (funcBox) funcBox.style.visibility = "hidden";
        }

        // Fonksiyon: Pin label'ƒ±nƒ± g√ºncelle (hem Pin Header hem Side Socket i√ßin)
        function setPinLabel(pinNumber, labelText) {
            // Pin 0 (Not Used) ise g√∂sterme
            if (pinNumber === 0 || isNaN(pinNumber)) return;

            if (pinNumber >= 1 && pinNumber <= 6) {
                // Pin Header Layout (1-6)
                const label = document.getElementById(`s${pinNumber}-label`);
                if (label) label.textContent = labelText;
            } else if (pinNumber >= 7 && pinNumber <= 9) {
                // Side Socket Layout (firmware pinleri 7-9 ‚Üí socket pinleri 6-4)
                // Firmware Pin 7 = Socket Pin 6 (IO1) ‚Üí Sarƒ±
                // Firmware Pin 8 = Socket Pin 5 (IO2) ‚Üí Ye≈üil
                // Firmware Pin 9 = Socket Pin 4 (IO3) ‚Üí Mavi
                let socketPin, boxColor, textColor;
                if (pinNumber === 7) {
                    socketPin = 6;
                    boxColor = "#FFD700";  // Sarƒ±
                    textColor = "#FFD700"; // Sarƒ±
                } else if (pinNumber === 8) {
                    socketPin = 5;
                    boxColor = "#00FF00";  // Ye≈üil
                    textColor = "#00FF00"; // Ye≈üil
                } else if (pinNumber === 9) {
                    socketPin = 4;
                    boxColor = "#2196F3";  // Mavi
                    textColor = "#2196F3"; // Mavi
                }

                // Sol taraftaki fonksiyon label'ƒ±nƒ± g√ºncelle
                const funcLabel = document.getElementById(`side-func-label-${socketPin}`);
                const funcBox = document.getElementById(`side-func-box-${socketPin}`);
                if (funcLabel) {
                    funcLabel.textContent = labelText;
                    funcLabel.setAttribute('fill', textColor);
                }
                if (funcBox) {
                    funcBox.setAttribute('fill', boxColor);
                    funcBox.style.visibility = "visible";
                }
            }
        }

        // Servo pinlerini etiketlere yerle≈ütir
        setPinLabel(wwServoPin, "WW Servo");
        setPinLabel(ww2ServoPin, "WW2 Servo");
        setPinLabel(tlServoPin, "TL Servo");
        setPinLabel(ruServoPin, "RU Servo");

        // RDT Rx pinini etiketlere yerle≈ütir
        setPinLabel(rdtRxPin, "RDT Rx");

        // Hook tipine g√∂re diƒüer pinleri yerle≈ütir
        if (hookType === "2switch") {
            // Hook switch pinlerini al
            const hookSw1 = document.getElementById('hook-sw1-pin') ?
                            parseInt(document.getElementById('hook-sw1-pin').value) : 2;
            const hookSw2 = document.getElementById('hook-sw2-pin') ?
                            parseInt(document.getElementById('hook-sw2-pin').value) : 4;

            setPinLabel(hookSw1, "Hook SW1");
            setPinLabel(hookSw2, "Hook SW2");
        }
        else if (hookType === "2switch_servo") {
            // Hook switch ve servo pinlerini al
            const hookSw1 = document.getElementById('hook-sw1-pin') ?
                            parseInt(document.getElementById('hook-sw1-pin').value) : 2;
            const hookSw2 = document.getElementById('hook-sw2-pin') ?
                            parseInt(document.getElementById('hook-sw2-pin').value) : 4;
            const hookServo = document.getElementById('hook-servo-pin') ?
                              parseInt(document.getElementById('hook-servo-pin').value) : 6;

            setPinLabel(hookSw1, "Hook SW1");
            setPinLabel(hookSw2, "Hook SW2");
            setPinLabel(hookServo, "Hook Servo");
        }
        else if (hookType === "rotary_servo") {
            // Encoder ve servo pinlerini al
            const encoderPin = document.getElementById('encoder-pin') ?
                               parseInt(document.getElementById('encoder-pin').value) : 2;
            const hookServo = document.getElementById('hook-servo-pin') ?
                              parseInt(document.getElementById('hook-servo-pin').value) : 4;

            setPinLabel(encoderPin, "Encoder");
            setPinLabel(hookServo, "Hook Servo");
        }
    }

    // Time Settings kolonlarƒ±nƒ±n g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle (Not Used pinler i√ßin)
    function updateColumnVisibility() {
        const timerGrid = document.querySelector('.timer-grid');
        if (!timerGrid) return;

        const ruPin = document.getElementById('ru-servo-pin').value;
        const tlPin = document.getElementById('tl-servo-pin').value;
        const wwPin = document.getElementById('ww-servo-pin').value;
        const ww2Pin = document.getElementById('ww2-servo-pin').value;

        // Not Used (value="0") ise kolonlarƒ± gizle
        timerGrid.classList.toggle('hide-ru', ruPin === '0');
        timerGrid.classList.toggle('hide-tl', tlPin === '0');
        timerGrid.classList.toggle('hide-ww', wwPin === '0');
        timerGrid.classList.toggle('hide-ww2', ww2Pin === '0');
    }

    // Sayfa y√ºklendiƒüinde √ßalƒ±≈üacak kod
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle butonu i√ßin olay dinleyicisi ekle
        const toggleBtn = document.getElementById('toggleSettingsBtn');
        const advancedSettings = document.getElementById('advancedSettings');
        
        toggleBtn.addEventListener('click', function() {
            // Ayarlarƒ± g√∂ster/gizle
            if (advancedSettings.style.display === 'none') {
                advancedSettings.style.display = 'block';
                toggleBtn.textContent = 'Hide Settings';
            } else {
                advancedSettings.style.display = 'none';
                toggleBtn.textContent = 'Show Settings';
            }
        });
        
        // Hook se√ßeneklerini ba≈ülangƒ±√ßta g√ºncelle
        updateHookOptions();
        
        // Servo pin se√ßimlerini dinle - √ßakƒ±≈üma kontrol√º + diyagram g√ºncelle + kolon gizleme
        document.getElementById('ru-servo-pin').addEventListener('change', function(e) {
            validatePinAssignments(e.target.id);
            updatePinDiagram();
            updateColumnVisibility();
        });
        document.getElementById('tl-servo-pin').addEventListener('change', function(e) {
            validatePinAssignments(e.target.id);
            updatePinDiagram();
            updateColumnVisibility();
        });
        document.getElementById('ww-servo-pin').addEventListener('change', function(e) {
            validatePinAssignments(e.target.id);
            updatePinDiagram();
            updateColumnVisibility();
        });
        document.getElementById('ww2-servo-pin').addEventListener('change', function(e) {
            validatePinAssignments(e.target.id);
            updatePinDiagram();
            updateColumnVisibility();
        });
        document.getElementById('rdt-rx-pin').addEventListener('change', function(e) {
            validatePinAssignments(e.target.id);
            updatePinDiagram();
        });

        // Hook tipi deƒüi≈ütiƒüinde diyagramƒ± g√ºncelle (√ßaki≈üma kontrol√º yok, sadece g√ºncelleme)
        document.getElementById('hook-type').addEventListener('change', function() {
            updateHookOptions();
            updatePinDiagram();
        });

        // Event delegation: Hook options container deƒüi≈üikliklerini dinle
        // innerHTML ile i√ßerik deƒüi≈üse bile tek listener yeterli (memory leak yok)
        const hookOptionsContainer = document.getElementById('hook-options');
        hookOptionsContainer.addEventListener('change', function(e) {
            if (e.target.matches('select, input')) {
                validatePinAssignments(e.target.id);
                updatePinDiagram();
            }
        });

        // Sayfa y√ºklendiƒüinde diyagramƒ± ve kolon g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
        updatePinDiagram();
        updateColumnVisibility();
    });
    
    // Hook se√ßeneklerini g√ºncelleyen fonksiyon
    function updateHookOptions() {
        const hookType = document.getElementById('hook-type').value;
        const hookOptionsContainer = document.getElementById('hook-options');
        
        // Mevcut i√ßeriƒüi temizle
        hookOptionsContainer.innerHTML = '';
        
        // Hook tipine g√∂re uygun se√ßenekleri ekle
        if (hookType === '2switch') {
            hookOptionsContainer.innerHTML = `
                <div class="hook-options-container">
                    <h3>2 Switch Hook Options</h3>
                    <div class="option-row">
                        <label for="hook-sw1-pin">Switch 1 Pin:</label>
                        <select id="hook-sw1-pin" name="hook-sw1-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2" selected>S2</option>
                            <option value="3">S3</option>
                            <option value="4">S4</option>
                            <option value="5">S5</option>
                            <option value="6">S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-sw2-pin">Switch 2 Pin:</label>
                        <select id="hook-sw2-pin" name="hook-sw2-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2">S2</option>
                            <option value="3">S3</option>
                            <option value="4" selected>S4</option>
                            <option value="5">S5</option>
                            <option value="6">S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (hookType === '2switch_servo') {
            hookOptionsContainer.innerHTML = `
                <div class="hook-options-container">
                    <h3>2 Switch + Servo Hook Options</h3>
                    <div class="option-row">
                        <label for="hook-sw1-pin">Switch 1 Pin:</label>
                        <select id="hook-sw1-pin" name="hook-sw1-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2" selected>S2</option>
                            <option value="3">S3</option>
                            <option value="4">S4</option>
                            <option value="5">S5</option>
                            <option value="6">S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-sw2-pin">Switch 2 Pin:</label>
                        <select id="hook-sw2-pin" name="hook-sw2-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2">S2</option>
                            <option value="3">S3</option>
                            <option value="4" selected>S4</option>
                            <option value="5">S5</option>
                            <option value="6">S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-servo-pin">Servo Pin:</label>
                        <select id="hook-servo-pin" name="hook-servo-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2">S2</option>
                            <option value="3">S3</option>
                            <option value="4">S4</option>
                            <option value="5">S5</option>
                            <option value="6" selected>S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (hookType === 'rotary_servo') {
            hookOptionsContainer.innerHTML = `
                <div class="hook-options-container">
                    <h3>Rotary Encoder + Servo Hook Options</h3>
                    <div class="option-row">
                        <label for="encoder-pin">Enc. Pin:</label>
                        <select id="encoder-pin" name="encoder-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2" selected>S2</option>
                            <option value="3">S3</option>
                            <option value="4">S4</option>
                            <option value="5">S5</option>
                            <option value="6">S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-servo-pin">Servo Pin:</label>
                        <select id="hook-servo-pin" name="hook-servo-pin">
                            <option value="0">Not Used</option>
                            <option value="1">S1</option>
                            <option value="2">S2</option>
                            <option value="3">S3</option>
                            <option value="4" selected>S4</option>
                            <option value="5">S5</option>
                            <option value="6">S6</option>
                            <option value="7">S7</option>
                            <option value="8">S8</option>
                            <option value="9">S9</option>
                        </select>
                    </div>
                </div>
            `;
        }

        // Pin diyagramƒ±nƒ± g√ºncelle (yeni hook options y√ºklendikten sonra)
        if (typeof updatePinDiagram === 'function') {
            updatePinDiagram();
        }
    }

    // Flutter'dan gelen JSON verilerini forma y√ºkle (F1A-specific)
    function loadPresetDataFromJSON(jsonString) {
        try {
            if (!jsonString || typeof jsonString !== 'string') {
                throw new Error('Invalid JSON string provided');
            }

            var presetData = JSON.parse(jsonString);
            console.log('Preset data loaded:', presetData);

            // D√ºz alanlarƒ± doldur (preset-name, preset-index, vb.)
            for (var key in presetData) {
                if (key === 'timers') continue; // timers'ƒ± ayrƒ± i≈üle

                var element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = presetData[key] === 1 || presetData[key] === '1';
                    } else {
                        element.value = presetData[key];
                    }
                }
            }

            // Strobe bits'i geni≈ület (8 bit)
            if (presetData['strobe-value'] !== undefined) {
                var strobeValue = parseInt(presetData['strobe-value']);
                console.log('Loading strobe-value:', strobeValue);

                // Her bir biti kontrol et ve checkbox'ƒ± i≈üaretle
                for (var i = 7; i >= 0; i--) {
                    var bit = (strobeValue >> i) & 1;
                    var checkbox = document.getElementById('bit' + i);
                    if (checkbox) {
                        checkbox.checked = (bit === 1);
                        console.log('Bit ' + i + ':', bit === 1 ? 'checked' : 'unchecked');
                    }
                }

                // Strobe LED animasyonunu g√ºncelle
                if (typeof updateStrobeAnimation === 'function') {
                    updateStrobeAnimation();
                }
            }

            // Timers nested yapƒ±sƒ±nƒ± i≈üle
            if (presetData.timers) {
                for (var timerKey in presetData.timers) {
                    var timer = presetData.timers[timerKey];

                    // time deƒüeri varsa
                    if (timer.time !== undefined) {
                        var timeElement = document.getElementById(timerKey + '-time');
                        if (timeElement) timeElement.value = timer.time;
                    }

                    // ru, tl, ww, ww2 pozisyonlarƒ± (PWM ‚Üí UI formatƒ±na d√∂n√º≈üt√ºr)
                    ['ru', 'tl', 'ww', 'ww2'].forEach(function(servo) {
                        if (timer[servo] !== undefined) {
                            var servoElement = document.getElementById(timerKey + '-' + servo);
                            if (servoElement) {
                                // JSON'daki deƒüer her zaman PWM (1000-2000¬µs)
                                const pwmValue = timer[servo];
                                const currentMode = window.currentServoRangeMode || '1000-2000';

                                // PWM'i UI formatƒ±na d√∂n√º≈üt√ºr
                                const uiValue = pwmToUiValue(pwmValue, currentMode);
                                servoElement.value = uiValue;

                                // √ñnceki deƒüer olarak kaydet
                                previousServoValues[servoElement.id] = uiValue.toString();
                            }
                        }
                    });
                }
            }

            // Hook tipini g√ºncelle ve se√ßenekleri g√∂ster
            var hookTypeElement = document.getElementById('hook-type');
            if (hookTypeElement && typeof updateHookOptions === 'function') {
                updateHookOptions();
            }

            // Pin deƒüerlerini ba≈ülangƒ±√ß deƒüeri olarak kaydet (√ßakƒ±≈üma kontrol√º i√ßin)
            previousPinValues['ru-servo-pin'] = document.getElementById('ru-servo-pin')?.value || '0';
            previousPinValues['tl-servo-pin'] = document.getElementById('tl-servo-pin')?.value || '0';
            previousPinValues['ww-servo-pin'] = document.getElementById('ww-servo-pin')?.value || '0';
            previousPinValues['ww2-servo-pin'] = document.getElementById('ww2-servo-pin')?.value || '0';
            previousPinValues['rdt-rx-pin'] = document.getElementById('rdt-rx-pin')?.value || '0';

            // Hook pinlerini de kaydet (varsa)
            if (document.getElementById('hook-sw1-pin')) {
                previousPinValues['hook-sw1-pin'] = document.getElementById('hook-sw1-pin').value;
            }
            if (document.getElementById('hook-sw2-pin')) {
                previousPinValues['hook-sw2-pin'] = document.getElementById('hook-sw2-pin').value;
            }
            if (document.getElementById('hook-servo-pin')) {
                previousPinValues['hook-servo-pin'] = document.getElementById('hook-servo-pin').value;
            }
            if (document.getElementById('encoder-pin')) {
                previousPinValues['encoder-pin'] = document.getElementById('encoder-pin').value;
            }

            // Pin diyagramƒ±nƒ± ve kolon g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
            if (typeof updatePinDiagram === 'function') {
                updatePinDiagram();
            }
            if (typeof updateColumnVisibility === 'function') {
                updateColumnVisibility();
            }

            // UI Preferences - Restore Range Mode and Time Mode
            if (presetData['range-mode']) {
                var rangeModeElement = document.getElementById('servo-range-mode');
                if (rangeModeElement) {
                    rangeModeElement.value = presetData['range-mode'];
                    window.currentServoRangeMode = presetData['range-mode'];
                    // Trigger range mode update to convert all servo values
                    if (typeof updateRangeModeLabels === 'function') {
                        updateRangeModeLabels();
                    }
                    console.log('‚úÖ Range Mode restored:', presetData['range-mode']);
                }
            }

            if (presetData['time-mode']) {
                var timeModeElement = document.getElementById('time-mode');
                if (timeModeElement) {
                    timeModeElement.value = presetData['time-mode'];
                    window.currentTimeMode = presetData['time-mode'];
                    // Trigger time mode update to convert all time values
                    if (typeof updateTimeMode === 'function') {
                        updateTimeMode();
                    }
                    console.log('‚úÖ Time Mode restored:', presetData['time-mode']);
                }
            }

            // Load Geofencing data
            if (presetData['geofencing']) {
                loadGeofenceData(presetData['geofencing']);
                console.log('‚úÖ Geofencing data loaded:', presetData['geofencing']);
            }

            console.log('‚úÖ Form successfully populated from JSON');
        } catch (e) {
            console.error('‚ùå Error loading preset data:', e);
            alert('Failed to load preset data: ' + e.message);
        }
    }

    // Function Info Modal System
    const functionInfoData = {
        'ru-servo': {
            icon: 'üéöÔ∏è',
            title: 'RU Servo (Rudder)',
            description: 'Rudder servo controls the vertical tail fin (rudder) for left/right directional control.\n\nThis servo is essential for yaw control during flight phases.\n\nPin assignment determines which hardware output channel controls this servo. Choose a pin that is not used by other servos or switches.'
        },
        'tl-servo': {
            icon: 'üéöÔ∏è',
            title: 'TL Servo (Tail/Elevator)',
            description: 'Tail servo controls the horizontal stabilizer (elevator) for pitch control (nose up/down).\n\nThis is the primary control surface for climb and descent angles.\n\nPin assignment determines which hardware output channel controls this servo. Ensure this pin does not conflict with other servos.'
        },
        'ww-servo': {
            icon: 'üéöÔ∏è',
            title: 'WW Servo (Wing)',
            description: 'Wing servo controls wing warping or wing flaps for additional lift/drag control.\n\nThis servo helps optimize the model\'s flight characteristics during different phases.\n\nPin assignment determines which hardware output channel controls this servo. Select a unique pin for this servo.'
        },
        'ww2-servo': {
            icon: 'üéöÔ∏è',
            title: 'WW2 Servo (Wing 2)',
            description: 'Second wing servo for F1A Flapper models with dual wing control.\n\nFlapper models use two wing servos to control independent wing surfaces for enhanced flight control and stability.\n\nThis servo typically mirrors or complements WW servo movements for coordinated wing control.\n\nPin assignment determines which hardware output channel controls this servo. Required for Flapper configurations.'
        },
        'rdt-rx': {
            icon: 'üì°',
            title: 'RDT Rx Pin (Radio DT Receiver)',
            description: 'Pin assignment for the Radio De-Thermalization receiver input.\n\nRDT allows remote triggering of the DT phase via radio command from the ground, providing manual override control.\n\nThis is useful when:\n‚Ä¢ The model needs to land immediately\n‚Ä¢ Auto DT features are not sufficient\n‚Ä¢ Competition rules require manual DT capability\n‚Ä¢ The model is flying out of bounds\n\nThe receiver connects to this pin and triggers DT when a signal is received from the transmitter.\n\nSelect "Not Used" if you don\'t have an RDT receiver installed. Choose a pin (S1-S9) that doesn\'t conflict with servo or switch assignments.'
        },
        'range-mode': {
            icon: 'üìä',
            title: 'Range Mode',
            description: 'Selects the input format for servo position values in the Time Settings table.\n\nOptions:\n\n‚Ä¢ 0-100 (%): Percentage format (0% = minimum, 100% = maximum)\n‚Ä¢ 0-255: 8-bit integer format (classic RC systems)\n‚Ä¢ 1000-2000 ¬µs: PWM microsecond format (standard for modern servos)\n\nAll values are internally stored as 1000-2000 ¬µs in the JSON configuration, regardless of the selected display format.\n\nChanging this mode will automatically convert all existing values to the new format.'
        },
        'time-mode': {
            icon: '‚è±Ô∏è',
            title: 'Time Mode',
            description: 'Controls how time values are displayed and entered in the Time Settings table.\n\n‚Ä¢ Interval: Each phase shows its duration (e.g., PU1: 0.03s, PU2: 0.10s)\n‚Ä¢ Absolute: Each phase shows cumulative time from start (e.g., PU1: 0.03s, PU2: 0.13s)\n\nAll values are internally stored as intervals in the JSON configuration.\n\nIn Absolute mode, validation ensures each time value is greater than or equal to the previous phase to maintain chronological order.\n\nUse Interval mode for setting individual phase durations, or Absolute mode for planning total flight timeline.'
        },
        'hook-type': {
            icon: 'ü™ù',
            title: 'Hook Type',
            description: 'Determines how the model is released from the tow line. Options:\n\n‚Ä¢ 2 Switch: Uses two mechanical switches to detect release\n‚Ä¢ 2 Switch + Servo: Adds a servo for active hook release control\n‚Ä¢ Rotary Enc. + Servo: Uses a rotary encoder with servo for precise release control\n\nThe hook type affects which pins are used and how the timer detects launch phases.'
        },
        'max-sink': {
            icon: 'üìâ',
            title: 'Max Sink Rate',
            description: 'Maximum descent rate (in meters per second) before automatic DT activation.\n\nIf the model descends faster than this rate, the timer will automatically trigger de-thermalization to prevent a dangerous dive or crash.\n\nTypical values: 2-5 m/s\n\nLower values provide more safety but may trigger false positives in turbulent air.'
        },
        'max-altitude': {
            icon: '‚õ∞Ô∏è',
            title: 'Max Altitude',
            description: 'Maximum altitude limit (in meters) before automatic DT activation.\n\nIf the model climbs above this altitude, the timer will automatically trigger de-thermalization to comply with competition rules or prevent fly-aways.\n\nThis is critical for F1A competitions where altitude limits are strictly enforced.\n\nTypical values: 200-500m depending on competition rules.'
        },
        'flip-loop-detection': {
            icon: 'üîÑ',
            title: 'Flip & Loop Detection',
            description: 'Enables automatic DT trigger when aerobatic maneuvers (flips or loops) are detected using gyroscope data.\n\nThis safety feature prevents the model from entering uncontrolled aerobatic flight that could lead to structural damage or loss of control.\n\nDetection thresholds:\n‚Ä¢ 2.5G for flips\n‚Ä¢ 45¬∞ for loops\n‚Ä¢ 180¬∞/s for spins\n\nUseful for preventing thermal-induced unusual attitudes.'
        },
        'geofencing': {
            icon: 'üó∫Ô∏è',
            title: 'Geofencing DT',
            description: 'Enables automatic DT trigger when the model exits a defined geographic boundary.\n\nWhen enabled, you can define a 4-point boundary on the map by tapping 4 corners. The system continuously monitors GPS position during flight.\n\nIf the model crosses outside this boundary, DT is automatically triggered to bring the model down within the allowed area.\n\nThis is especially useful for:\n‚Ä¢ Competition fly zones with strict boundaries\n‚Ä¢ Preventing fly-aways over restricted areas\n‚Ä¢ Keeping the model within visual range\n‚Ä¢ Complying with local aviation regulations\n\nRequires GPS lock before flight. The boundary is checked at 1Hz during flight.\n\nMarkers are draggable - adjust the boundary anytime before saving.'
        },
        'on': {
            icon: '‚ö°',
            title: 'Power ON',
            description: 'Initial position when the timer is powered on.\n\nAll servos move to their starting positions.\n\nThis is the safe storage and transportation configuration.'
        },
        'str': {
            icon: '‚Üë',
            title: 'Straight Tow',
            description: 'Launch phase with straight tow line.\n\nServos are set for optimal climb angle during the initial tow.\n\nThis phase begins when the timer is armed and the model is being towed upward.'
        },
        'cir': {
            icon: '‚Üª',
            title: 'Circle Tow',
            description: 'Circling tow phase.\n\nServos adjust to maintain a circular tow pattern, helping the model gain altitude while circling.\n\nThis phase typically follows the straight tow.'
        },
        'ola': {
            icon: 'üéØ',
            title: 'On Launch Adjust',
            description: 'Launch adjustment phase.\n\nFine-tuning servo positions immediately after line release to optimize the initial free flight trajectory and establish proper climb attitude.'
        },
        'pu1': {
            icon: '‚¨ÜÔ∏è',
            title: 'Pull-Up 1',
            description: 'First pull-up phase.\n\nThe model climbs to gain altitude.\n\nServo positions are optimized for maximum climb rate while maintaining efficient speed.'
        },
        'pu2': {
            icon: '‚¨ÜÔ∏è',
            title: 'Pull-Up 2',
            description: 'Second pull-up phase.\n\nContinued climbing with adjusted servo positions to maintain optimal climb performance as the model gains altitude.'
        },
        'cr1': {
            icon: 'üîÑ',
            title: 'Circle 1',
            description: 'First thermal circling phase.\n\nServos are set to maintain a tight, efficient circling pattern to climb in thermals.\n\nThis is the primary thermal soaring configuration.'
        },
        'cr2': {
            icon: 'üîÑ',
            title: 'Circle 2',
            description: 'Second thermal circling phase.\n\nServo positions may be slightly adjusted from CR1 to optimize thermal performance as altitude and conditions change.'
        },
        'cr3': {
            icon: 'üîÑ',
            title: 'Circle 3',
            description: 'Third thermal circling phase.\n\nFinal thermal soaring configuration before transitioning to descent phases.\n\nOptimized for maximum altitude gain.'
        },
        'bu1': {
            icon: '‚ÜòÔ∏è',
            title: 'Bunting 1',
            description: 'First bunting phase.\n\nThe model begins to transition from climb to level flight or gentle descent.\n\nServos adjust to prevent over-climbing and prepare for controlled descent.'
        },
        'bu2': {
            icon: '‚ÜòÔ∏è',
            title: 'Bunting 2',
            description: 'Second bunting phase.\n\nContinued transition with servo positions adjusted for stable, controlled flight as the model prepares for faster descent.'
        },
        'bu3': {
            icon: '‚ÜòÔ∏è',
            title: 'Bunting 3',
            description: 'Third bunting phase.\n\nFinal bunting configuration before transitioning to fast glide.\n\nServos are set for efficient, controlled descent.'
        },
        'fg': {
            icon: '‚û°Ô∏è',
            title: 'Fast Glide',
            description: 'Fast glide descent phase.\n\nServos are positioned for high-speed, efficient glide to cover distance quickly and bring the model down to landing altitude.'
        },
        'gl': {
            icon: '‚úàÔ∏è',
            title: 'Glide',
            description: 'Normal glide phase.\n\nSlower, more controlled glide with servos set for efficient, stable descent.\n\nThis phase prepares the model for final landing approach.'
        },
        'dt': {
            icon: 'ü™Ç',
            title: 'De-Thermalization (DT)',
            description: 'De-thermalization phase.\n\nServos move to positions that significantly increase drag and reduce lift, causing rapid descent.\n\nThis prevents the model from flying out of bounds or landing too far away.\n\nCritical for competition compliance.'
        },
        'pk': {
            icon: 'üÖøÔ∏è',
            title: 'Park',
            description: 'Final parking position.\n\nAll servos return to safe storage positions.\n\nThis is the configuration for after landing, during storage, and transport.\n\nPrevents servo and linkage damage.'
        },
        'range-mode': {
            icon: 'üìä',
            title: 'Range Mode',
            description: 'Selects the input format for RU/TL/WW servo values in the Time Settings table.\n\nOptions:\n\n‚Ä¢ 0-100 (%): Enter values as percentages (0% = 1000¬µs, 100% = 2000¬µs)\n  - Easy to understand\n  - Good for beginners\n\n‚Ä¢ 0-255: Traditional 8-bit range (0 = 1000¬µs, 255 = 2000¬µs)\n  - Compatible with legacy systems\n  - Fine control with 256 steps\n\n‚Ä¢ 1000-2000 ¬µs: Direct PWM microseconds (default)\n  - Precise servo positioning\n  - Standard RC servo control range\n  - 1500¬µs is center position\n\nIMPORTANT: Regardless of which mode you choose, the device always stores and uses the actual PWM values (1000-2000¬µs). The range mode only affects how YOU enter the values in this form.\n\nWhen you change the range mode, all existing values are automatically converted to the new format.'
        }
    };

    function showFunctionInfo(functionKey) {
        const info = functionInfoData[functionKey];
        if (!info) {
            console.error('No info found for function:', functionKey);
            return;
        }

        // Update modal content
        document.getElementById('functionInfoIcon').textContent = info.icon;
        document.getElementById('functionInfoTitle').textContent = info.title;
        document.getElementById('functionInfoBody').textContent = info.description;

        // Show modal
        document.getElementById('functionInfoModal').style.display = 'flex';
    }

    function closeFunctionInfoModal() {
        document.getElementById('functionInfoModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.getElementById('functionInfoModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeFunctionInfoModal();
        }
    });

    // Close number input modal when clicking outside
    document.getElementById('numberInputModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeNumberInputModal();
        }
    });

    // ==================== GEOFENCING FEATURE ====================
    let geofenceMap = null;
    let geofenceMarkers = [];
    let geofencePolygon = null;
    const maxGeofencePoints = 4;

    // Toggle geofencing map visibility
    function toggleGeofencingMap() {
        const enabled = document.getElementById('geofencing-enabled').checked;
        const container = document.getElementById('geofencing-map-container');

        if (enabled) {
            container.style.display = 'block';
            // Initialize map if not already initialized
            if (!geofenceMap) {
                initializeGeofenceMap();
            }
        } else {
            container.style.display = 'none';
        }
    }

    // Initialize Leaflet map
    function initializeGeofenceMap() {
        // Default center (fallback if geolocation fails)
        const defaultLat = 51.09853337025952;
        const defaultLng = 1.2059596354190565;

        // Create map with default location first (zoom 18 = ~100m view)
        geofenceMap = L.map('geofence-map').setView([defaultLat, defaultLng], 18);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            maxZoom: 19
        }).addTo(geofenceMap);

        // Try to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Success - center map on user's location
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    geofenceMap.setView([userLat, userLng], 13);
                    console.log('üìç Map centered on user location:', userLat, userLng);
                },
                function(error) {
                    // Error or denied - check if we have saved geofence points
                    console.log('‚ö†Ô∏è Geolocation failed:', error.message);

                    // If we have saved geofence markers, fit map to show them all
                    if (geofenceMarkers.length > 0) {
                        const bounds = L.latLngBounds(geofenceMarkers.map(m => m.getLatLng()));
                        geofenceMap.fitBounds(bounds, { padding: [50, 50] });
                        console.log('üìç Map centered on saved geofence points');
                    } else {
                        // No saved points, stay with default Istanbul location
                        console.log('üìç Using default Istanbul location');
                    }
                },
                {
                    enableHighAccuracy: false,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        } else {
            // Geolocation not supported - check for saved points
            console.log('‚ö†Ô∏è Geolocation not supported by browser');

            if (geofenceMarkers.length > 0) {
                const bounds = L.latLngBounds(geofenceMarkers.map(m => m.getLatLng()));
                geofenceMap.fitBounds(bounds, { padding: [50, 50] });
                console.log('üìç Map centered on saved geofence points');
            } else {
                console.log('üìç Using default Istanbul location');
            }
        }

        // Add click handler to place markers
        geofenceMap.on('click', function(e) {
            addGeofencePoint(e.latlng);
        });

        console.log('üìç Geofence map initialized');
    }

    // Add a geofence point
    function addGeofencePoint(latlng) {
        // Check if we already have 4 points
        if (geofenceMarkers.length >= maxGeofencePoints) {
            alert('Maximum 4 points allowed. Clear points to start over.');
            return;
        }

        // Create marker with custom numbering
        const markerNumber = geofenceMarkers.length + 1;
        const marker = L.marker(latlng, {
            draggable: true,
            icon: L.divIcon({
                className: 'geofence-marker',
                html: `<div style="background-color: #FFD700; color: #000; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #000; font-size: 16px;">${markerNumber}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(geofenceMap);

        // Store marker with its index
        marker.pointIndex = markerNumber - 1;

        // Add drag event to update polygon and coordinates
        marker.on('dragend', function() {
            updateGeofencePolygon();
            updateCoordinateDisplay();
        });

        // Add marker to array
        geofenceMarkers.push(marker);

        // Update polygon and display
        updateGeofencePolygon();
        updateCoordinateDisplay();

        console.log(`üìç Added geofence point ${markerNumber}: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`);
    }

    // Update the polygon connecting the points
    function updateGeofencePolygon() {
        // Remove existing polygon
        if (geofencePolygon) {
            geofenceMap.removeLayer(geofencePolygon);
        }

        // Only draw polygon if we have at least 3 points
        if (geofenceMarkers.length >= 3) {
            const points = geofenceMarkers.map(m => m.getLatLng());

            geofencePolygon = L.polygon(points, {
                color: '#FFD700',
                fillColor: '#FFD700',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(geofenceMap);

            console.log('üî∑ Geofence polygon updated');
        }
    }

    // Update coordinate display
    function updateCoordinateDisplay() {
        for (let i = 0; i < maxGeofencePoints; i++) {
            const coordSpan = document.getElementById(`coord-p${i + 1}`);
            if (i < geofenceMarkers.length) {
                const latlng = geofenceMarkers[i].getLatLng();
                coordSpan.textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
                coordSpan.style.color = '#00FF00';
            } else {
                coordSpan.textContent = '----, ----';
                coordSpan.style.color = '#FFD700';
            }
        }
    }

    // Clear all geofence points
    function clearGeofencePoints() {
        // Remove all markers
        geofenceMarkers.forEach(marker => {
            geofenceMap.removeLayer(marker);
        });
        geofenceMarkers = [];

        // Remove polygon
        if (geofencePolygon) {
            geofenceMap.removeLayer(geofencePolygon);
            geofencePolygon = null;
        }

        // Reset coordinate display
        updateCoordinateDisplay();

        console.log('üßπ Geofence points cleared');
    }

    // Get geofence data for JSON storage
    function getGeofenceData() {
        if (!document.getElementById('geofencing-enabled').checked) {
            return {
                enabled: 0,
                points: []
            };
        }

        const points = geofenceMarkers.map(marker => {
            const latlng = marker.getLatLng();
            return {
                lat: parseFloat(latlng.lat.toFixed(6)),
                lng: parseFloat(latlng.lng.toFixed(6))
            };
        });

        return {
            enabled: 1,
            points: points
        };
    }

    // Load geofence data from JSON
    function loadGeofenceData(data) {
        if (!data) return;

        // Set enabled state
        const enabled = data.enabled === 1 || data.enabled === true;
        document.getElementById('geofencing-enabled').checked = enabled;

        if (enabled) {
            // Show map container
            document.getElementById('geofencing-map-container').style.display = 'block';

            // Initialize map if needed
            if (!geofenceMap) {
                initializeGeofenceMap();
            }

            // Wait for map to be ready, then load points
            setTimeout(() => {
                // Clear existing points
                clearGeofencePoints();

                // Add points from data
                if (data.points && Array.isArray(data.points)) {
                    data.points.forEach(point => {
                        if (point.lat !== undefined && point.lng !== undefined) {
                            addGeofencePoint(L.latLng(point.lat, point.lng));
                        }
                    });

                    // If we have at least one point, center map on first point
                    if (data.points.length > 0) {
                        geofenceMap.setView([data.points[0].lat, data.points[0].lng], 15);
                    }
                }

                console.log('üìç Geofence data loaded:', data.points?.length || 0, 'points');
            }, 500);
        } else {
            document.getElementById('geofencing-map-container').style.display = 'none';
        }
    }

    // ==================== END GEOFENCING FEATURE ====================
</script>

</body>
</html>
