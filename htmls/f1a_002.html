<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <title>Model Airplane Timer Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --base-font: 3.8vw;
            --small-font: 3.4vw;
            --title-font: 5vw;
            --base-padding: 2vw;
            --base-margin: 2vw;
        }

        @media screen and (min-width: 768px) {
            :root {
                --base-font: 16px;
                --small-font: 14px;
                --title-font: 24px;
                --base-padding: 10px;
                --base-margin: 10px;
            }
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: var(--base-padding);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-size: var(--base-font);
        }

        h1 {
            color: #FFD700;
            text-align: center;
            font-size: var(--title-font);
            margin-bottom: var(--base-margin);
            margin-top: 0;
        }

        .section {
            margin-bottom: var(--base-margin);
            padding: var(--base-padding);
            border: 2px solid #fff;
            border-radius: calc(var(--base-padding) * 0.8);
        }

        .section h2 {
            color: #FFD700;
            margin: 0 0 var(--base-margin) 0;
            font-size: calc(var(--base-font) * 1.2);
            text-align: center;
        }

        label {
            display: block;
            font-size: var(--base-font);
            margin-bottom: calc(var(--base-margin) * 0.5);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: calc(var(--base-padding) * 0.8);
            font-size: var(--base-font);
            margin-bottom: var(--base-margin);
            border: none;
            border-radius: calc(var(--base-padding) * 0.5);
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .preset-buttons {
            display: flex;
            justify-content: space-between;
        }

        .preset-buttons button {
            width: 23%;
            padding: 10px;
            font-size: 16px;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        .timer-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .timer-row > div {
            flex: 0 0 48%;
        }

        .timer-row > div label {
            margin-bottom: 5px;
        }

        .timer-row > div input {
            width: 100%;
        }

        input[type="submit"] {
            background-color: #FFD700;
            color: #000;
            font-size: 18px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
        }

        /* Strobe pattern styling */
        .strobe-pattern {
            margin: 5px 0;
        }
        
        .checkbox-group {
            display: flex;
            gap: 0;
            justify-content: center;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: calc(var(--base-font) * 1.8);
            height: calc(var(--base-font) * 1.8);
            margin: 0;
            padding: 0;
        }

        .strobe-led {
            width: calc(var(--base-font) * 1.8);
            height: calc(var(--base-font) * 1.8);
            border-radius: 50%;
            background-color: #300;
            margin-left: var(--base-margin);
            display: inline-block;
        }

        /* Timer grid için CSS güncellemesi */
        .timer-grid {
            display: grid;
            grid-template-columns: 60px 80px 1fr 1fr 1fr;
            gap: 1px;
            background-color: #555; /* Grid çizgileri için arka plan rengi */
            border: 1px solid #555;
            margin-top: 10px;
        }

        .timer-header {
            background-color: #FFD700;
            color: #000;
            padding: 4px 0;
            text-align: center;
            font-weight: bold;
            font-size: var(--small-font);
            border: none;
        }

        .timer-cell {
            background-color: #333;
            padding: 0;
            margin: 0;
            text-align: center;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
        }

        .timer-cell input {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 4px;
            background-color: #222;
            color: #fff;
            border: none;
            border-radius: 0;
            text-align: center;
            -moz-appearance: textfield;
            appearance: textfield;
            font-size: var(--small-font);
            box-sizing: border-box;
        }

        .timer-cell.function-name {
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: #333;
        }

        /* Time inputları için sağa yasla */
        .timer-cell input[id$="-time"] {
            text-align: right;
            padding-right: 4px;
        }

        /* Tüm number input'ları için spinbutton'ları kaldır */
        .timer-cell input[type="number"]::-webkit-inner-spin-button,
        .timer-cell input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        .timer-cell input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .dt-input-row {
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dt-input-row label {
            margin: 0;
            flex: 1;
        }

        .dt-input-row input {
            width: 120px;
            margin: 0 0 0 10px;
        }

        .checkbox-label {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }

        .option-row {
            margin-top: 15px;
        }
        
        .option-row label {
            display: block;
            margin-bottom: 5px;
        }
        
        .option-row select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        .hook-options-container {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #222;
        }
        
        .hook-options-container h3 {
            color: #FFD700;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-row label {
            flex: 1;
            margin: 0;
            padding-right: 10px;
        }
        
        .option-row select,
        .option-row input {
            flex: 1;
            width: auto;
            margin: 0;
        }

        .pin-header-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background-color: #222;
            padding: 15px;
            border-radius: 5px;
        }

        .toggle-button {
            background-color: #FFD700;
            color: #000;
            font-size: calc(var(--base-font) * 1.1);
            padding: var(--base-padding);
            border: none;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .toggle-button:hover {
            background-color: #FFC000;
        }

        /* Preset name container için özel stil */
        .preset-name-container {
            margin-bottom: 15px;
        }

        .preset-name-container label {
            display: block;
            margin-bottom: 5px;
            color: #fff;
            font-size: var(--base-font);
        }

        /* Preset controls - selector ve butonlar için flex container */
        .preset-controls {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .preset-controls select {
            flex: 1;
            min-width: 0; /* Flex shrink için gerekli */
            padding: calc(var(--base-padding) * 0.8);
            font-size: var(--base-font);
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: calc(var(--base-padding) * 0.5);
        }

        /* Preset butonları - + ve - */
        .preset-btn {
            width: 40px;
            min-width: 40px;
            height: auto;
            padding: 0;
            font-size: 24px;
            font-weight: bold;
            border: none;
            border-radius: calc(var(--base-padding) * 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .add-btn {
            background-color: #4CAF50;
            color: white;
        }

        .add-btn:hover {
            background-color: #45a049;
        }

        .add-btn:active {
            background-color: #3d8b40;
            transform: scale(0.95);
        }

        .delete-btn {
            background-color: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background-color: #da190b;
        }

        .delete-btn:active {
            background-color: #c41409;
            transform: scale(0.95);
        }

        .delete-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Model name container için özel stil */
        .model-name-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .model-name-container label {
            margin: 0;
        }

        .model-name-container input {
            border: none;
            background: #333;
            color: #fff;
            font-size: var(--base-font);
            padding: calc(var(--base-padding) * 0.5);
            margin: 0;
            border-radius: 3px;
            width: 50vw;
            max-width: 200px;
        }

        .model-name-container input:focus {
            outline: 1px solid #FFD700;
        }

        input, select, button {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Modal Dialog Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.2s ease-in;
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-dialog {
            background-color: #1E1E1E;
            border: 2px solid #f44336;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .modal-icon {
            font-size: 32px;
        }

        .modal-title {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .modal-body {
            color: #ccc;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-preset-name {
            color: #f44336;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .modal-btn-cancel {
            background-color: #555;
            color: #fff;
        }

        .modal-btn-cancel:hover {
            background-color: #666;
        }

        .modal-btn-delete {
            background-color: #f44336;
            color: #fff;
        }

        .modal-btn-delete:hover {
            background-color: #d32f2f;
        }

        .modal-btn-delete:active {
            transform: scale(0.95);
        }

        /* Info Modal - Mavi tema */
        .modal-dialog-info {
            background-color: #1E1E1E;
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        .modal-header-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .modal-icon-info {
            font-size: 32px;
        }

        .modal-title-info {
            color: #2196F3;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .modal-body-info {
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-body-info strong {
            color: #FFD700;
            font-weight: bold;
        }

        .modal-btn-ok {
            background-color: #2196F3;
            color: #fff;
            width: 100%;
        }

        .modal-btn-ok:hover {
            background-color: #1976D2;
        }

        /* Add Preset Modal - Yeşil tema */
        .modal-dialog-add {
            background-color: #1E1E1E;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        .modal-header-add {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        .modal-icon-add {
            font-size: 32px;
        }

        .modal-title-add {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .modal-body-add {
            color: #ccc;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-label {
            display: block;
            color: #4CAF50;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background-color: #2D2D2D;
            color: #fff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: #66BB6A;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
        }

        .modal-input-hint {
            display: block;
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .modal-btn-add {
            background-color: #4CAF50;
            color: #fff;
        }

        .modal-btn-add:hover {
            background-color: #45a049;
        }

        .modal-btn-add:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-dialog">
            <div class="modal-header">
                <span class="modal-icon">⚠️</span>
                <h3 class="modal-title">Delete Preset?</h3>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <span id="modalPresetName" class="modal-preset-name"></span>?
                <br><br>
                This action cannot be undone.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="modal-btn modal-btn-delete" onclick="closeConfirmModal(true)">Delete</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-dialog-info">
            <div class="modal-header-info">
                <span class="modal-icon-info">ℹ️</span>
                <h3 class="modal-title-info">Preset Deleted</h3>
            </div>
            <div class="modal-body-info">
                The preset has been removed from the local configuration.
                <br><br>
                To make this change permanent, please <strong>click the SAVE button</strong> below to update the device.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-ok" onclick="closeInfoModal()">OK, Got it!</button>
            </div>
        </div>
    </div>

    <!-- Add Preset Modal -->
    <div id="addModal" class="modal-overlay">
        <div class="modal-dialog-add">
            <div class="modal-header-add">
                <span class="modal-icon-add">➕</span>
                <h3 class="modal-title-add">Add New Preset</h3>
            </div>
            <div class="modal-body-add">
                Create a new preset based on the current configuration.
            </div>
            <div class="modal-input-group">
                <label class="modal-input-label" for="addPresetInput">Preset Name</label>
                <input
                    type="text"
                    id="addPresetInput"
                    class="modal-input"
                    placeholder="Enter preset name"
                    maxlength="8"
                    onkeyup="validateAddPresetInput()"
                    onkeypress="if(event.key==='Enter'){confirmAddPreset();}"
                >
                <span class="modal-input-hint">Maximum 8 characters</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddModal()">Cancel</button>
                <button id="addPresetConfirmBtn" class="modal-btn modal-btn-add" onclick="confirmAddPreset()" disabled>Add Preset</button>
            </div>
        </div>
    </div>

    <h1>F1A Config</h1>

    <form onsubmit="submitForm(event)">

        <!-- Model Identification -->
        <div class="section">
            <h2>Model Identification</h2>
            
            <div class="model-name-container">
                <label for="model-name">Model Name:</label>
                <input type="text" id="model-name" name="model-name" placeholder="e.g., MyModel">
            </div>
            
            <div class="preset-name-container">
                <label for="preset-selector">Select Preset:</label>
                <div class="preset-controls">
                    <select id="preset-selector" name="preset-selector" onchange="onPresetChanged()">
                        <option value="">Loading presets...</option>
                    </select>
                    <button type="button" class="preset-btn add-btn" onclick="addNewPreset()" title="Add New Preset">+</button>
                    <button type="button" class="preset-btn delete-btn" onclick="deleteCurrentPreset()" title="Delete Preset">−</button>
                </div>
                <input type="hidden" id="preset-name" name="preset-name">
                <input type="hidden" id="preset-index" name="preset-index" value="1">
            </div>

            <label for="strobe-pattern">Strobe Pattern:</label>
            <div class="strobe-pattern">
                <div style="display: flex; align-items: center; height: 30px;">
                    <div class="checkbox-group">
                        <input type="checkbox" id="bit7" name="strobe-bit" value="128">
                        <input type="checkbox" id="bit6" name="strobe-bit" value="64">
                        <input type="checkbox" id="bit5" name="strobe-bit" value="32">
                        <input type="checkbox" id="bit4" name="strobe-bit" value="16">
                        <input type="checkbox" id="bit3" name="strobe-bit" value="8">
                        <input type="checkbox" id="bit2" name="strobe-bit" value="4">
                        <input type="checkbox" id="bit1" name="strobe-bit" value="2">
                        <input type="checkbox" id="bit0" name="strobe-bit" value="1">
                    </div>
                    <div id="strobeLed" class="strobe-led"></div>
                </div>
                <input type="hidden" id="strobe-value" name="strobe-value" value="0">
            </div>
        </div>

        <!-- Servo Configuration'dan Auto DT Features'a kadar olan bölümleri gizleyecek buton -->
        <button id="toggleSettingsBtn" class="toggle-button">Show Settings</button>

        <!-- Gizlenecek bölümler -->
        <div id="advancedSettings" style="display: none;">
            <!-- Servo Configuration bölümü -->
            <div class="section">
                <h2>Servo Configuration</h2>
                <div class="option-row">
                    <label for="ru-servo-pin">RU Servo Pin:</label>
                    <select id="ru-servo-pin" name="ru-servo-pin">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="tl-servo-pin">TL Servo Pin:</label>
                    <select id="tl-servo-pin" name="tl-servo-pin">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div class="option-row">
                    <label for="ww-servo-pin">WW Servo Pin:</label>
                    <select id="ww-servo-pin" name="ww-servo-pin">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
            </div>

            <!-- Hook Configuration bölümü -->
            <div class="section">
                <h2>Hook Configuration</h2>
                
                <label for="hook-type">Hook Type:</label>
                <select id="hook-type" name="hook-type" onchange="updateHookOptions()">
                    <option value="2switch">2 Switch</option>
                    <option value="2switch_servo">2 Switch + Servo</option>
                    <option value="rotary_servo">Rotary Enc. + Servo</option>
                </select>
                
                <div id="hook-options">
                    <!-- Bu alan dinamik olarak doldurulacak -->
                </div>
            </div>

            <!-- Pin Header Layout bölümü -->
            <div class="section">
                <h2>Pin Header Layout</h2>
                <div class="pin-header-container">
                    <svg width="300" height="150" viewBox="0 0 300 150" xmlns="http://www.w3.org/2000/svg">
                        <!-- Header Outline -->
                        <rect x="20" y="20" width="260" height="110" rx="5" ry="5" fill="#333" stroke="#555" stroke-width="2"/>
                        
                        <!-- Top Row Pins -->
                        <g class="pin-row">
                            <!-- S1 -->
                            <rect x="30" y="30" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="40" y="44" font-size="12" text-anchor="middle" fill="#000">S1</text>
                            <!-- + -->
                            <rect x="55" y="30" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="65" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- - -->
                            <rect x="80" y="30" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="90" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- Label under S1 -->
                            <text x="55" y="60" font-size="10" text-anchor="middle" fill="#FFD700" id="s1-label">WW Servo</text>
                            
                            <!-- S2 -->
                            <rect x="110" y="30" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="120" y="44" font-size="12" text-anchor="middle" fill="#000">S2</text>
                            <!-- + -->
                            <rect x="135" y="30" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="145" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- - -->
                            <rect x="160" y="30" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="170" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- Label under S2 -->
                            <text x="135" y="60" font-size="10" text-anchor="middle" fill="#FFD700" id="s2-label">TL Servo</text>
                            
                            <!-- S3 -->
                            <rect x="190" y="30" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="200" y="44" font-size="12" text-anchor="middle" fill="#000">S3</text>
                            <!-- + -->
                            <rect x="215" y="30" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="225" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- - -->
                            <rect x="240" y="30" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="250" y="44" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- Label under S3 -->
                            <text x="215" y="60" font-size="10" text-anchor="middle" fill="#FFD700" id="s3-label">RU Servo</text>
                        </g>
                        
                        <!-- Bottom Row Pins -->
                        <g class="pin-row">
                            <!-- S4 -->
                            <rect x="30" y="80" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="40" y="94" font-size="12" text-anchor="middle" fill="#000">S4</text>
                            <!-- + -->
                            <rect x="55" y="80" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="65" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- - -->
                            <rect x="80" y="80" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="90" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- Label under S4 -->
                            <text x="55" y="110" font-size="10" text-anchor="middle" fill="#FFD700" id="s4-label">Hook SW1</text>
                            
                            <!-- S5 -->
                            <rect x="110" y="80" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="120" y="94" font-size="12" text-anchor="middle" fill="#000">S5</text>
                            <!-- + -->
                            <rect x="135" y="80" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="145" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- - -->
                            <rect x="160" y="80" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="170" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- Label under S5 -->
                            <text x="135" y="110" font-size="10" text-anchor="middle" fill="#FFD700" id="s5-label">Hook SW2</text>
                            
                            <!-- S6 -->
                            <rect x="190" y="80" width="20" height="20" fill="#FFD700" stroke="#000" stroke-width="1"/>
                            <text x="200" y="94" font-size="12" text-anchor="middle" fill="#000">S6</text>
                            <!-- + -->
                            <rect x="215" y="80" width="20" height="20" fill="#FF0000" stroke="#000" stroke-width="1"/>
                            <text x="225" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">+</text>
                            <!-- - -->
                            <rect x="240" y="80" width="20" height="20" fill="#000" stroke="#555" stroke-width="1"/>
                            <text x="250" y="94" font-size="14" text-anchor="middle" font-weight="bold" fill="#FFF">-</text>
                            <!-- Label under S6 -->
                            <text x="215" y="110" font-size="10" text-anchor="middle" fill="#FFD700" id="s6-label">Hook Servo</text>
                        </g>
                    </svg>
                </div>
            </div>

            <!-- Auto DT Features bölümü -->
            <div class="section">
                <h2>Auto DT Features</h2>
                <div class="dt-input-row">
                    <label for="max-sink">Max Sink (m/s):</label>
                    <input type="number" id="max-sink-value" name="max-sink-value" min="0" max="10" step="0.1" value="2">
                </div>
                <div class="dt-input-row">
                    <label for="max-altitude">Max Altitude (m):</label>
                    <input type="number" id="max-altitude-value" name="max-altitude-value" min="0" max="1000" value="500">
                </div>
                <div class="checkbox-label">
                    <input type="checkbox" id="flip-loop-detection" name="flip-loop-detection">
                    <label for="flip-loop-detection">Flip & Loop Detection</label>
                </div>
            </div>
        </div>

        <!-- Timer Settings -->
        <div class="section">
            <h2>Timer Settings</h2>
            <div class="timer-grid">
                <div class="timer-header">Function</div>
                <div class="timer-header">Time</div>
                <div class="timer-header">RU</div>
                <div class="timer-header">TL</div>
                <div class="timer-header">WW</div>

                <div class="timer-cell function-name" title="Power ON">On</div>
                <div class="timer-cell"></div>
                <div class="timer-cell">
                    <input type="number" id="on-ru" name="on-ru" min="0" max="255" value="45">
                </div>
                <div class="timer-cell">
                    <input type="number" id="on-tl" name="on-tl" min="0" max="255" value="35">
                </div>
                <div class="timer-cell">
                    <input type="number" id="on-ww" name="on-ww" min="0" max="255" value="0">
                </div>

                <div class="timer-cell function-name" title="Straight Tow">Str</div>
                <div class="timer-cell"></div>
                <div class="timer-cell">
                    <input type="number" id="str-ru" name="str-ru" min="0" max="255" value="5">
                </div>
                <div class="timer-cell">
                    <input type="number" id="str-tl" name="str-tl" min="0" max="255" value="25">
                </div>
                <div class="timer-cell">
                    <input type="number" id="str-ww" name="str-ww" min="0" max="255" value="50">
                </div>

                <div class="timer-cell function-name" title="Circle Tow">Cir</div>
                <div class="timer-cell"></div>
                <div class="timer-cell">
                    <input type="number" id="cir-ru" name="cir-ru" min="0" max="255" value="105">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cir-tl" name="cir-tl" min="0" max="255" value="15">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cir-ww" name="cir-ww" min="0" max="255" value="150">
                </div>

                <div class="timer-cell function-name" title="On Line Acceleration">OLA</div>
                <div class="timer-cell"></div>
                <div class="timer-cell">
                    <input type="number" id="ola-ru" name="ola-ru" min="0" max="255" value="35">
                </div>
                <div class="timer-cell">
                    <input type="number" id="ola-tl" name="ola-tl" min="0" max="255" value="5">
                </div>
                <div class="timer-cell">
                    <input type="number" id="ola-ww" name="ola-ww" min="0" max="255" value="75">
                </div>

                <div class="timer-cell function-name" title="Pitch Up 1">Pu1</div>
                <div class="timer-cell">
                    <input type="number" id="pu1-time" name="pu1-time" min="0" max="10" step="0.01" value="0.03">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pu1-ru" name="pu1-ru" min="0" max="255" value="35">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pu1-tl" name="pu1-tl" min="0" max="255" value="0">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pu1-ww" name="pu1-ww" min="0" max="255" value="75">
                </div>

                <div class="timer-cell function-name" title="Pitch Up 2">Pu2</div>
                <div class="timer-cell">
                    <input type="number" id="pu2-time" name="pu2-time" min="0" max="10" step="0.01" value="0.1">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pu2-ru" name="pu2-ru" min="0" max="255" value="30">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pu2-tl" name="pu2-tl" min="0" max="255" value="2">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pu2-ww" name="pu2-ww" min="0" max="255" value="70">
                </div>

                <div class="timer-cell function-name" title="Cruise 1">Cr1</div>
                <div class="timer-cell">
                    <input type="number" id="cr1-time" name="cr1-time" min="0" max="10" step="0.01" value="0.4">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr1-ru" name="cr1-ru" min="0" max="255" value="25">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr1-tl" name="cr1-tl" min="0" max="255" value="60">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr1-ww" name="cr1-ww" min="0" max="255" value="60">
                </div>

                <div class="timer-cell function-name" title="Cruise 2">Cr2</div>
                <div class="timer-cell">
                    <input type="number" id="cr2-time" name="cr2-time" min="0" max="10" step="0.01" value="0.7">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr2-ru" name="cr2-ru" min="0" max="255" value="25">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr2-tl" name="cr2-tl" min="0" max="255" value="65">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr2-ww" name="cr2-ww" min="0" max="255" value="60">
                </div>

                <div class="timer-cell function-name" title="Cruise 3">Cr3</div>
                <div class="timer-cell">
                    <input type="number" id="cr3-time" name="cr3-time" min="0" max="10" step="0.01" value="0.7">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr3-ru" name="cr3-ru" min="0" max="255" value="25">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr3-tl" name="cr3-tl" min="0" max="255" value="75">
                </div>
                <div class="timer-cell">
                    <input type="number" id="cr3-ww" name="cr3-ww" min="0" max="255" value="60">
                </div>

                <div class="timer-cell function-name" title="Bunt 1">Bu1</div>
                <div class="timer-cell">
                    <input type="number" id="bu1-time" name="bu1-time" min="0" max="10" step="0.01" value="0.5">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu1-ru" name="bu1-ru" min="0" max="255" value="25">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu1-tl" name="bu1-tl" min="0" max="255" value="200">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu1-ww" name="bu1-ww" min="0" max="255" value="60">
                </div>

                <div class="timer-cell function-name" title="Bunt 2">Bu2</div>
                <div class="timer-cell">
                    <input type="number" id="bu2-time" name="bu2-time" min="0" max="10" step="0.01" value="1.1">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu2-ru" name="bu2-ru" min="0" max="255" value="25">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu2-tl" name="bu2-tl" min="0" max="255" value="220">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu2-ww" name="bu2-ww" min="0" max="255" value="75">
                </div>

                <div class="timer-cell function-name" title="Bunt 3">Bu3</div>
                <div class="timer-cell">
                    <input type="number" id="bu3-time" name="bu3-time" min="0" max="10" step="0.01" value="1.7">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu3-ru" name="bu3-ru" min="0" max="255" value="55">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu3-tl" name="bu3-tl" min="0" max="255" value="240">
                </div>
                <div class="timer-cell">
                    <input type="number" id="bu3-ww" name="bu3-ww" min="0" max="255" value="85">
                </div>

                <div class="timer-cell function-name" title="Fast Glide">Fg</div>
                <div class="timer-cell">
                    <input type="number" id="fg-time" name="fg-time" min="0" max="999" step="0.1" value="7.1">
                </div>
                <div class="timer-cell">
                    <input type="number" id="fg-ru" name="fg-ru" min="0" max="255" value="57">
                </div>
                <div class="timer-cell">
                    <input type="number" id="fg-tl" name="fg-tl" min="0" max="255" value="35">
                </div>
                <div class="timer-cell">
                    <input type="number" id="fg-ww" name="fg-ww" min="0" max="255" value="15">
                </div>

                <div class="timer-cell function-name" title="Glide">GL</div>
                <div class="timer-cell">
                    <input type="number" id="gl-time" name="gl-time" min="0" max="999" step="0.1" value="180">
                </div>
                <div class="timer-cell">
                    <input type="number" id="gl-ru" name="gl-ru" min="0" max="255" value="52">
                </div>
                <div class="timer-cell">
                    <input type="number" id="gl-tl" name="gl-tl" min="0" max="255" value="32">
                </div>
                <div class="timer-cell">
                    <input type="number" id="gl-ww" name="gl-ww" min="0" max="255" value="5">
                </div>

                <div class="timer-cell function-name" title="De-Thermalised">DT</div>
                <div class="timer-cell"></div>
                <div class="timer-cell">
                    <input type="number" id="dt-ru" name="dt-ru" min="0" max="255" value="100">
                </div>
                <div class="timer-cell">
                    <input type="number" id="dt-tl" name="dt-tl" min="0" max="255" value="255">
                </div>
                <div class="timer-cell">
                    <input type="number" id="dt-ww" name="dt-ww" min="0" max="255" value="0">
                </div>

                <div class="timer-cell function-name" title="Park mode 10s after DT">Pk</div>
                <div class="timer-cell"></div>
                <div class="timer-cell">
                    <input type="number" id="pk-ru" name="pk-ru" min="0" max="255" value="100">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pk-tl" name="pk-tl" min="0" max="255" value="0">
                </div>
                <div class="timer-cell">
                    <input type="number" id="pk-ww" name="pk-ww" min="0" max="255" value="0">
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <input type="submit" value="SAVE">
    </form>

   <script>
  // Global değişken - cihazdan gelen tüm JSON
  var fullDeviceJson = null;

  // SAVE butonunu yeniden aktif et (Flutter'dan çağrılacak)
  function onSaveComplete(success) {
    var saveButton = document.querySelector('input[type="submit"]');
    saveButton.disabled = false;

    if (success) {
      saveButton.value = 'SAVED ✓';
      saveButton.style.backgroundColor = '#4CAF50'; // Yeşil
      console.log('✅ Settings saved successfully');

      // 2 saniye sonra butonu normal haline getir
      setTimeout(function() {
        saveButton.value = 'SAVE';
        saveButton.style.backgroundColor = '#FFD700'; // Sarı
      }, 2000);
    } else {
      saveButton.value = 'SAVE FAILED ✗';
      saveButton.style.backgroundColor = '#f44336'; // Kırmızı
      console.log('❌ Save failed');

      // 3 saniye sonra butonu normal haline getir
      setTimeout(function() {
        saveButton.value = 'SAVE';
        saveButton.style.backgroundColor = '#FFD700'; // Sarı
      }, 3000);
    }
  }

  // Flutter'dan tüm JSON'u al ve preset selector'ı doldur
  function initializeWithFullJson(jsonString) {
    try {
      fullDeviceJson = JSON.parse(jsonString);
      console.log('✅ Full JSON received:', fullDeviceJson);

      // Preset selector'ı doldur
      var selector = document.getElementById('preset-selector');
      selector.innerHTML = ''; // Mevcut options'ları temizle

      if (fullDeviceJson.presets && fullDeviceJson.presets.length > 0) {
        fullDeviceJson.presets.forEach(function(preset, index) {
          var option = document.createElement('option');
          option.value = preset['preset-index']; // preset-index kullan
          option.text = preset['preset-name'] || ('Preset ' + preset['preset-index']);
          selector.appendChild(option);
        });

        // selected-preset-index değerine göre seç
        var selectedIndex = fullDeviceJson['selected-preset-index'] || 1;
        selector.value = selectedIndex;

        console.log('📋 Preset selector dolduruldu, selected-preset-index:', selectedIndex);

        // İlk preset'i yükle
        onPresetChanged();

        // Delete butonunu güncelle
        updateDeleteButton();
      } else {
        console.error('❌ No presets found in JSON');
      }

    } catch (e) {
      console.error('❌ Error parsing full JSON:', e);
    }
  }

  // Preset değiştiğinde çağrılır
  function onPresetChanged() {
    var selector = document.getElementById('preset-selector');
    var selectedPresetIndex = parseInt(selector.value);

    console.log('🔄 Preset changed to index:', selectedPresetIndex);

    if (!fullDeviceJson || !fullDeviceJson.presets) {
      console.error('❌ Full JSON not loaded yet');
      return;
    }

    // Seçilen preset'i bul
    var selectedPreset = fullDeviceJson.presets.find(function(preset) {
      return preset['preset-index'] === selectedPresetIndex;
    });

    if (selectedPreset) {
      // model-name'i JSON root seviyesinden ekle
      var presetWithModel = {
        'model-name': fullDeviceJson['model-name'] || 'Unknown',
        ...selectedPreset
      };

      console.log('✅ Loading preset:', presetWithModel['preset-name']);

      // Mevcut loadPresetDataFromJSON fonksiyonunu kullan
      var jsonString = JSON.stringify(presetWithModel);
      loadPresetDataFromJSON(jsonString);
    } else {
      console.error('❌ Preset not found with index:', selectedPresetIndex);
    }

    // Delete butonunu güncelle (default preset korumalı)
    updateDeleteButton();
  }

  // Delete butonunu güncelle
  function updateDeleteButton() {
    var selector = document.getElementById('preset-selector');
    var deleteBtn = document.querySelector('.delete-btn');
    var selectedIndex = parseInt(selector.value);

    // Index 1 (default) veya tek preset varsa delete disable
    if (selectedIndex === 1 || fullDeviceJson.presets.length <= 1) {
      deleteBtn.disabled = true;
    } else {
      deleteBtn.disabled = false;
    }
  }

  // Add preset modal göster
  function addNewPreset() {
    if (!fullDeviceJson) {
      alert('Device JSON not loaded yet');
      return;
    }

    // Input'u temizle ve modal'ı göster
    var input = document.getElementById('addPresetInput');
    input.value = '';
    validateAddPresetInput(); // Butonu disable et
    document.getElementById('addModal').classList.add('show');

    // Input'a focus ver (küçük gecikme ile)
    setTimeout(function() {
      input.focus();
    }, 300);
  }

  // Add preset input validasyonu
  function validateAddPresetInput() {
    var input = document.getElementById('addPresetInput');
    var confirmBtn = document.getElementById('addPresetConfirmBtn');
    var presetName = input.value.trim();

    // Boş değilse butonu aktif et
    if (presetName.length > 0) {
      confirmBtn.disabled = false;
    } else {
      confirmBtn.disabled = true;
    }
  }

  // Add preset modal kapat
  function closeAddModal() {
    document.getElementById('addModal').classList.remove('show');
  }

  // Add preset onayla
  function confirmAddPreset() {
    var input = document.getElementById('addPresetInput');
    var presetName = input.value.trim();

    if (presetName.length === 0) {
      return;
    }

    // İsmi 8 karaktere kısıtla
    presetName = presetName.substring(0, 8);

    console.log('➕ Adding new preset:', presetName);

    // Yeni preset index'i bul (en yüksek index + 1)
    var maxIndex = Math.max(...fullDeviceJson.presets.map(p => p['preset-index']));
    var newIndex = maxIndex + 1;

    // Mevcut seçili preset'in verilerini kopyala
    var selector = document.getElementById('preset-selector');
    var currentIndex = parseInt(selector.value);
    var currentPreset = fullDeviceJson.presets.find(p => p['preset-index'] === currentIndex);

    // Yeni preset objesi oluştur (mevcut preset'in kopyası)
    var newPreset = JSON.parse(JSON.stringify(currentPreset)); // Deep copy
    newPreset['preset-name'] = presetName;
    newPreset['preset-index'] = newIndex;

    // fullDeviceJson'a ekle
    fullDeviceJson.presets.push(newPreset);

    // Selector'ı güncelle
    var option = document.createElement('option');
    option.value = newIndex;
    option.text = presetName;
    selector.appendChild(option);

    // Yeni preset'i seç
    selector.value = newIndex;
    onPresetChanged();

    console.log('✅ Preset added locally, click SAVE to apply changes');

    // Delete butonunu güncelle
    updateDeleteButton();

    // Modal'ı kapat
    closeAddModal();
  }

  // Global değişken - modal onay için
  var pendingDeleteIndex = null;

  // Modal confirmation dialog göster
  function showConfirmModal(presetName, presetIndex) {
    document.getElementById('modalPresetName').textContent = '"' + presetName + '"';
    pendingDeleteIndex = presetIndex;
    document.getElementById('confirmModal').classList.add('show');
  }

  // Modal'ı kapat ve sonucu işle
  function closeConfirmModal(confirmed) {
    document.getElementById('confirmModal').classList.remove('show');

    if (confirmed && pendingDeleteIndex !== null) {
      performDelete(pendingDeleteIndex);

      // Silme işleminden sonra info modal göster
      setTimeout(function() {
        showInfoModal();
      }, 300); // Confirm modal kapanma animasyonu için bekle
    }

    pendingDeleteIndex = null;
  }

  // Info modal göster
  function showInfoModal() {
    document.getElementById('infoModal').classList.add('show');
  }

  // Info modal kapat
  function closeInfoModal() {
    document.getElementById('infoModal').classList.remove('show');
  }

  // Gerçek silme işlemi
  function performDelete(selectedIndex) {
    var selector = document.getElementById('preset-selector');

    console.log('🗑️ Deleting preset index:', selectedIndex);

    // fullDeviceJson'dan sil
    fullDeviceJson.presets = fullDeviceJson.presets.filter(p => p['preset-index'] !== selectedIndex);

    // Selector'dan sil
    selector.remove(selector.selectedIndex);

    // İlk preset'i seç
    if (fullDeviceJson.presets.length > 0) {
      selector.value = fullDeviceJson.presets[0]['preset-index'];
      onPresetChanged();
    }

    console.log('✅ Preset deleted locally, click SAVE to apply changes');

    // Delete butonunu güncelle
    updateDeleteButton();
  }

  // Mevcut preset'i sil (HTML içinde, SAVE'e kadar lokal)
  function deleteCurrentPreset() {
    var selector = document.getElementById('preset-selector');
    var selectedIndex = parseInt(selector.value);

    if (!fullDeviceJson) {
      alert('Device JSON not loaded yet');
      return;
    }

    // Index 1 (default) korumalı
    if (selectedIndex === 1) {
      alert('Cannot delete default preset');
      return;
    }

    // Tek preset kaldıysa silme
    if (fullDeviceJson.presets.length <= 1) {
      alert('Cannot delete the last preset');
      return;
    }

    // Preset ismini bul ve modal göster
    var presetName = fullDeviceJson.presets.find(p => p['preset-index'] === selectedIndex)['preset-name'];
    showConfirmModal(presetName, selectedIndex);
  }

  // Form gönderildiğinde bu fonksiyon çalışacaktır
  // Mevcut form değerlerini alıp selected preset'e kaydet, sonra tüm JSON'u gönder
  function submitForm(event) {
    event.preventDefault(); // Formun normal submit işlemini durdur

    if (!fullDeviceJson) {
      alert('Device JSON not loaded yet');
      return false;
    }

    // SAVE butonunu disable et ve "SAVING..." yap
    var saveButton = document.querySelector('input[type="submit"]');
    saveButton.disabled = true;
    saveButton.value = 'SAVING...';
    saveButton.style.backgroundColor = '#CCA000'; // Koyu sarı

    console.log('💾 SAVE button clicked, updating current preset with form values...');

    // Mevcut seçili preset'i bul
    var selector = document.getElementById('preset-selector');
    var selectedIndex = parseInt(selector.value);
    var currentPreset = fullDeviceJson.presets.find(p => p['preset-index'] === selectedIndex);

    if (!currentPreset) {
      alert('Current preset not found');
      return false;
    }

    // Form değerlerini currentPreset'e kaydet
    // Strobe value
    currentPreset['strobe-value'] = parseInt(document.getElementById('strobe-value').value);

    // Servo pins
    currentPreset['ru-servo-pin'] = parseInt(document.getElementById('ru-servo-pin').value);
    currentPreset['tl-servo-pin'] = parseInt(document.getElementById('tl-servo-pin').value);
    currentPreset['ww-servo-pin'] = parseInt(document.getElementById('ww-servo-pin').value);

    // Hook settings
    currentPreset['hook-type'] = document.getElementById('hook-type').value;

    // Hook sw1 ve sw2 (2switch ve 2switch_servo için)
    var hookSw1Elem = document.getElementById('hook-sw1-pin');
    if (hookSw1Elem) {
      currentPreset['hook-sw1-pin'] = parseInt(hookSw1Elem.value);
    } else {
      currentPreset['hook-sw1-pin'] = -1; // Kullanılmıyor
    }

    var hookSw2Elem = document.getElementById('hook-sw2-pin');
    if (hookSw2Elem) {
      currentPreset['hook-sw2-pin'] = parseInt(hookSw2Elem.value);
    } else {
      currentPreset['hook-sw2-pin'] = -1; // Kullanılmıyor
    }

    // Hook servo (2switch_servo ve rotary_servo için)
    var hookServoElem = document.getElementById('hook-servo-pin');
    if (hookServoElem) {
      currentPreset['hook-servo-pin'] = parseInt(hookServoElem.value);
    } else {
      currentPreset['hook-servo-pin'] = -1; // Kullanılmıyor
    }

    // Encoder pin (rotary_servo için)
    var encoderPinElem = document.getElementById('encoder-pin');
    if (encoderPinElem) {
      currentPreset['encoder-pin'] = parseInt(encoderPinElem.value);
    } else {
      currentPreset['encoder-pin'] = -1; // Kullanılmıyor
    }

    // Auto DT settings
    currentPreset['max-sink-value'] = parseFloat(document.getElementById('max-sink-value').value);
    currentPreset['max-altitude-value'] = parseFloat(document.getElementById('max-altitude-value').value);
    currentPreset['flip-loop-detection'] = document.getElementById('flip-loop-detection').checked ? 1 : 0;

    // Timers - nested structure
    if (!currentPreset.timers) {
      currentPreset.timers = {};
    }

    // Helper function to update timer
    function updateTimer(key) {
      if (!currentPreset.timers[key]) {
        currentPreset.timers[key] = {};
      }
      var timer = currentPreset.timers[key];

      // Time field (if exists)
      var timeElem = document.getElementById(key + '-time');
      if (timeElem) {
        timer.time = parseFloat(timeElem.value);
      }

      // Servo positions
      timer.ru = parseInt(document.getElementById(key + '-ru').value);
      timer.tl = parseInt(document.getElementById(key + '-tl').value);
      timer.ww = parseInt(document.getElementById(key + '-ww').value);
    }

    // Update all timers
    updateTimer('on');
    updateTimer('str');
    updateTimer('cir');
    updateTimer('ola');
    updateTimer('pu1');
    updateTimer('pu2');
    updateTimer('cr1');
    updateTimer('cr2');
    updateTimer('cr3');
    updateTimer('bu1');
    updateTimer('bu2');
    updateTimer('bu3');
    updateTimer('fg');
    updateTimer('gl');
    updateTimer('dt');
    updateTimer('pk');

    console.log('✅ Current preset updated with form values');

    // Model name'i güncelle (JSON root seviyesinde)
    var modelNameElem = document.getElementById('model-name');
    if (modelNameElem && modelNameElem.value) {
      fullDeviceJson['model-name'] = modelNameElem.value;
    }

    // selected-preset-index'i güncelle
    fullDeviceJson['selected-preset-index'] = selectedIndex;

    // Tüm JSON'u string'e çevir ve FormChannel'a gönder
    var jsonString = JSON.stringify(fullDeviceJson);

    console.log('📤 Sending full JSON to Flutter (' + jsonString.length + ' chars)');
    FormChannel.postMessage(jsonString);

    return false; // Formun normal submit işlemini engelle
}

    document.querySelectorAll('input[name="strobe-bit"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            let value = 0;
            document.querySelectorAll('input[name="strobe-bit"]').forEach(cb => {
                if (cb.checked) {
                    value += parseInt(cb.value);
                }
            });
            document.getElementById('strobe-value').value = value;
            updateStrobeAnimation(); // LED animasyonunu güncelle
        });
    });

    // Strobe LED animasyonu için değişkenler
    let strobeInterval;
    let strobeStep = 0;
    const STROBE_PERIOD = 125; // 1 saniye / 8 adım = 125ms

    function updateStrobeAnimation() {
        if (strobeInterval) {
            clearInterval(strobeInterval);
        }

        const strobeValue = parseInt(document.getElementById('strobe-value').value);
        const led = document.getElementById('strobeLed');
        let isBreak = false;
        let breakCounter = 0;

        strobeInterval = setInterval(() => {
            if (isBreak) {
                led.style.backgroundColor = '#300'; // Koyu kırmızı (kapalı)
                breakCounter++;
                if (breakCounter >= 8) { // 1 saniye bekleme (8 * 125ms)
                    isBreak = false;
                    breakCounter = 0;
                }
            } else {
                const bitMask = 1 << (7 - strobeStep);
                led.style.backgroundColor = (strobeValue & bitMask) ? '#f00' : '#300';
                strobeStep = (strobeStep + 1) % 8;
                if (strobeStep === 0) {
                    isBreak = true;
                }
            }
        }, STROBE_PERIOD);
    }

    // Sayfa yüklendiğinde animasyonu başlat
    document.addEventListener('DOMContentLoaded', function() {
        updateStrobeAnimation();
    });

    // Time inputları için virgülden sonra iki basamak formatı
    document.querySelectorAll('input[id$="-time"]').forEach(input => {
        input.addEventListener('change', function() {
            this.value = parseFloat(this.value).toFixed(2);
        });
        input.addEventListener('blur', function() {
            this.value = parseFloat(this.value).toFixed(2);
        });
    });

    // Pin diyagramını güncelleyen fonksiyon
    function updatePinDiagram() {
        // Servo pinlerini al
        const ruServoPin = document.getElementById('ru-servo-pin').value;
        const tlServoPin = document.getElementById('tl-servo-pin').value;
        const wwServoPin = document.getElementById('ww-servo-pin').value;
        
        // Hook tipini al
        const hookType = document.getElementById('hook-type').value;
        
        // Etiketleri temizle
        for (let i = 1; i <= 6; i++) {
            document.getElementById(`s${i}-label`).textContent = "";
        }
        
        // Servo pinlerini etiketlere yerleştir
        document.getElementById(`s${wwServoPin}-label`).textContent = "WW Servo";
        document.getElementById(`s${tlServoPin}-label`).textContent = "TL Servo";
        document.getElementById(`s${ruServoPin}-label`).textContent = "RU Servo";
        
        // Hook tipine göre diğer pinleri yerleştir
        if (hookType === "2switch") {
            // Hook switch pinlerini al
            const hookSw1 = document.getElementById('hook-sw1-pin') ? 
                            document.getElementById('hook-sw1-pin').value : "4";
            const hookSw2 = document.getElementById('hook-sw2-pin') ? 
                            document.getElementById('hook-sw2-pin').value : "5";
            
            document.getElementById(`s${hookSw1}-label`).textContent = "Hook SW1";
            document.getElementById(`s${hookSw2}-label`).textContent = "Hook SW2";
        } 
        else if (hookType === "2switch_servo") {
            // Hook switch ve servo pinlerini al
            const hookSw1 = document.getElementById('hook-sw1-pin') ? 
                            document.getElementById('hook-sw1-pin').value : "4";
            const hookSw2 = document.getElementById('hook-sw2-pin') ? 
                            document.getElementById('hook-sw2-pin').value : "5";
            const hookServo = document.getElementById('hook-servo-pin') ? 
                              document.getElementById('hook-servo-pin').value : "6";
            
            document.getElementById(`s${hookSw1}-label`).textContent = "Hook SW1";
            document.getElementById(`s${hookSw2}-label`).textContent = "Hook SW2";
            document.getElementById(`s${hookServo}-label`).textContent = "Hook Servo";
        }
        else if (hookType === "rotary_servo") {
            // Encoder ve servo pinlerini al
            const encoderPin = document.getElementById('encoder-pin') ? 
                               document.getElementById('encoder-pin').value : "4";
            const hookServo = document.getElementById('hook-servo-pin') ? 
                              document.getElementById('hook-servo-pin').value : "5";
            
            document.getElementById(`s${encoderPin}-label`).textContent = "Encoder";
            document.getElementById(`s${hookServo}-label`).textContent = "Hook Servo";
        }
    }
    
    // Sayfa yüklendiğinde çalışacak kod
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle butonu için olay dinleyicisi ekle
        const toggleBtn = document.getElementById('toggleSettingsBtn');
        const advancedSettings = document.getElementById('advancedSettings');
        
        toggleBtn.addEventListener('click', function() {
            // Ayarları göster/gizle
            if (advancedSettings.style.display === 'none') {
                advancedSettings.style.display = 'block';
                toggleBtn.textContent = 'Hide Settings';
            } else {
                advancedSettings.style.display = 'none';
                toggleBtn.textContent = 'Show Settings';
            }
        });
        
        // Hook seçeneklerini başlangıçta güncelle
        updateHookOptions();
        
        // Servo pin seçimlerini dinle
        document.getElementById('ru-servo-pin').addEventListener('change', updatePinDiagram);
        document.getElementById('tl-servo-pin').addEventListener('change', updatePinDiagram);
        document.getElementById('ww-servo-pin').addEventListener('change', updatePinDiagram);
        
        // Hook tipi değiştiğinde diyagramı güncelle
        document.getElementById('hook-type').addEventListener('change', function() {
            updateHookOptions();
            updatePinDiagram();
        });
        
        // Sayfa yüklendiğinde diyagramı güncelle
        updatePinDiagram();
    });
    
    // Hook seçeneklerini güncelleyen fonksiyon
    function updateHookOptions() {
        const hookType = document.getElementById('hook-type').value;
        const hookOptionsContainer = document.getElementById('hook-options');
        
        // Mevcut içeriği temizle
        hookOptionsContainer.innerHTML = '';
        
        // Hook tipine göre uygun seçenekleri ekle
        if (hookType === '2switch') {
            hookOptionsContainer.innerHTML = `
                <div class="hook-options-container">
                    <h3>2 Switch Hook Options</h3>
                    <div class="option-row">
                        <label for="hook-sw1-pin">Switch 1 Pin:</label>
                        <select id="hook-sw1-pin" name="hook-sw1-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-sw2-pin">Switch 2 Pin:</label>
                        <select id="hook-sw2-pin" name="hook-sw2-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (hookType === '2switch_servo') {
            hookOptionsContainer.innerHTML = `
                <div class="hook-options-container">
                    <h3>2 Switch + Servo Hook Options</h3>
                    <div class="option-row">
                        <label for="hook-sw1-pin">Switch 1 Pin:</label>
                        <select id="hook-sw1-pin" name="hook-sw1-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-sw2-pin">Switch 2 Pin:</label>
                        <select id="hook-sw2-pin" name="hook-sw2-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-servo-pin">Servo Pin:</label>
                        <select id="hook-servo-pin" name="hook-servo-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6" selected>6</option>
                        </select>
                    </div>
                </div>
            `;
        } else if (hookType === 'rotary_servo') {
            hookOptionsContainer.innerHTML = `
                <div class="hook-options-container">
                    <h3>Rotary Encoder + Servo Hook Options</h3>
                    <div class="option-row">
                        <label for="encoder-pin">Enc. Pin:</label>
                        <select id="encoder-pin" name="encoder-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    <div class="option-row">
                        <label for="hook-servo-pin">Servo Pin:</label>
                        <select id="hook-servo-pin" name="hook-servo-pin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5" selected>5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                </div>
            `;
        }
        
        // Yeni eklenen seçeneklerdeki değişiklikleri dinle
        const inputs = hookOptionsContainer.querySelectorAll('select, input');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                // Pin diyagramını güncelle (eğer tanımlıysa)
                if (typeof updatePinDiagram === 'function') {
                    updatePinDiagram();
                }
            });
        });
    }

    // Flutter'dan gelen JSON verilerini forma yükle (F1A-specific)
    function loadPresetDataFromJSON(jsonString) {
        try {
            var presetData = JSON.parse(jsonString);
            console.log('Preset data loaded:', presetData);

            // Düz alanları doldur (preset-name, preset-index, vb.)
            for (var key in presetData) {
                if (key === 'timers') continue; // timers'ı ayrı işle

                var element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = presetData[key] === 1 || presetData[key] === '1';
                    } else {
                        element.value = presetData[key];
                    }
                }
            }

            // Strobe bits'i genişlet (8 bit)
            if (presetData['strobe-value'] !== undefined) {
                var strobeValue = parseInt(presetData['strobe-value']);
                console.log('Loading strobe-value:', strobeValue);

                // Her bir biti kontrol et ve checkbox'ı işaretle
                for (var i = 7; i >= 0; i--) {
                    var bit = (strobeValue >> i) & 1;
                    var checkbox = document.getElementById('bit' + i);
                    if (checkbox) {
                        checkbox.checked = (bit === 1);
                        console.log('Bit ' + i + ':', bit === 1 ? 'checked' : 'unchecked');
                    }
                }

                // Strobe LED animasyonunu güncelle
                if (typeof updateStrobeAnimation === 'function') {
                    updateStrobeAnimation();
                }
            }

            // Timers nested yapısını işle
            if (presetData.timers) {
                for (var timerKey in presetData.timers) {
                    var timer = presetData.timers[timerKey];

                    // time değeri varsa
                    if (timer.time !== undefined) {
                        var timeElement = document.getElementById(timerKey + '-time');
                        if (timeElement) timeElement.value = timer.time;
                    }

                    // ru, tl, ww pozisyonları
                    ['ru', 'tl', 'ww'].forEach(function(servo) {
                        if (timer[servo] !== undefined) {
                            var servoElement = document.getElementById(timerKey + '-' + servo);
                            if (servoElement) servoElement.value = timer[servo];
                        }
                    });
                }
            }

            // Hook tipini güncelle ve seçenekleri göster
            var hookTypeElement = document.getElementById('hook-type');
            if (hookTypeElement && typeof updateHookOptions === 'function') {
                updateHookOptions();
            }

            // Pin diyagramını güncelle
            if (typeof updatePinDiagram === 'function') {
                updatePinDiagram();
            }

            console.log('✅ Form successfully populated from JSON');
        } catch (e) {
            console.error('❌ Error loading preset data:', e);
        }
    }
</script>

</body>
</html>
