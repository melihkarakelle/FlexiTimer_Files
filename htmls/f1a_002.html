import 'dart:async';
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'package:webview_flutter/webview_flutter.dart';
import 'package:bmk_flexitimer_configurator/variables.dart';
//import 'package:http/http.dart' as http;
import 'package:audioplayers/audioplayers.dart';
import 'functions.dart';
import 'ble_screen.dart';
import 'device_settings_screen.dart';
import 'sensor_data_screen.dart';
import 'servo_tester_screen.dart';
import 'export_settings_screen.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  // EkranÄ± dikey konumda kilitle
  SystemChrome.setPreferredOrientations([
    DeviceOrientation.portraitUp,
    DeviceOrientation.portraitDown,
  ]).then((_) {
    runApp(MyApp());
  });
}

const String targetServiceUuid = "b5f90001-aa8d-11e3-9046-0002a5d5c51b";
//const String writeCharacteristicUuid = "b5f90002-aa8d-11e3-9046-0002a5d5c51b";
//const String readCharacteristicUuid = "b5f90003-aa8d-11e3-9046-0002a5d5c51b";

const String bleuart_tx_characteristic = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
const String bleuart_rx_characteristic = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

const String firmwareListUrl =
    "https://raw.githubusercontent.com/melihkarakelle/FlexiTimer_Files/refs/heads/main/ftlist.json";

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: BLEFormApp(),
    );
  }
}

class BLEFormApp extends StatefulWidget {
  const BLEFormApp({super.key});

  @override
  _BLEFormAppState createState() => _BLEFormAppState();
}

class _BLEFormAppState extends State<BLEFormApp> with WidgetsBindingObserver {
  // FlutterBluePlus instance'Ä±nÄ± kaldÄ±r
  BluetoothCharacteristic? writeCharacteristic;
  BluetoothCharacteristic? readCharacteristic;
  String? localHtmlPath;
  late WebViewController webViewController;
  List<Map<String, dynamic>> firmwares = [];
  String? selectedHtmlUrl;
  String receivedData = '';
  String _incomingData = ''; // Gelen parÃ§alarÄ± birleÅŸtirmek iÃ§in buffer

  // BaÄŸlantÄ± durumu izleme
  bool isConnected = false;
  bool isReconnecting = false;
  bool isManualDisconnect = false; // Manuel disconnect durumu
  bool isManualConnecting = false; // Manuel baÄŸlanma sÄ±rasÄ±nda true
  DateTime? lastManualConnectionTime; // Son manuel baÄŸlantÄ± zamanÄ±
  StreamSubscription<BluetoothConnectionState>? _connectionStateSubscription; // Connection monitoring subscription

  // BLE device name
  String deviceBLEName = "FlexiTimer-Default";

  // HTML download race condition prevention
  bool _isDownloadingHtml = false;

  // Audio player instance
  final AudioPlayer _audioPlayer = AudioPlayer();

  // Ses Ã§alma fonksiyonu
  Future<void> _playConnectionSound() async {
    try {
      await _audioPlayer.stop(); // Ã–nce mevcut sesi durdur
      await _audioPlayer.play(AssetSource('connected.wav'));
      print("BaÄŸlantÄ± sesi Ã§alÄ±ndÄ±");
    } catch (e) {
      print("Ses Ã§alma hatasÄ±: $e");
    }
  }

  // BaÄŸlantÄ± kopma sesi Ã§alma fonksiyonu
  Future<void> _playDisconnectionSound() async {
    try {
      await _audioPlayer.stop(); // Ã–nce mevcut sesi durdur
      await _audioPlayer.play(AssetSource('disconnected.wav'));
      print("BaÄŸlantÄ± kopma sesi Ã§alÄ±ndÄ±");
    } catch (e) {
      print("Ses Ã§alma hatasÄ±: $e");
    }
  }

  // Son baÄŸlanan cihazÄ±n MAC adresini kaydet
  Future<void> _saveLastDeviceId(String deviceId) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('last_device_id', deviceId);
    print("Son baÄŸlanan cihaz kaydedildi: $deviceId");
  }

  // Son baÄŸlanan cihazÄ±n MAC adresini yÃ¼kle
  Future<String?> _loadLastDeviceId() async {
    final prefs = await SharedPreferences.getInstance();
    final deviceId = prefs.getString('last_device_id');
    print("KaydedilmiÅŸ cihaz ID: $deviceId");
    return deviceId;
  }

  // KaydedilmiÅŸ cihaz ID'sini sil
  Future<void> _clearLastDeviceId() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('last_device_id');
    print("KaydedilmiÅŸ cihaz ID silindi");
  }


  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);

    // WebViewController'Ä± sadece bir kez initialize et
    webViewController = WebViewController();
    webViewController.setJavaScriptMode(JavaScriptMode.unrestricted);
    webViewController.setBackgroundColor(const Color(0xFF000000));

    // JavaScript channel'Ä± sadece bir kez ekle
    try {
      // Form data channel - artÄ±k tÃ¼m JSON gelecek
      webViewController.addJavaScriptChannel(
        'FormChannel',
        onMessageReceived: (JavaScriptMessage message) {
          print("ğŸ“¥ Full JSON received from HTML");
          sendFullJsonToBLE(message.message);
        },
      );
    } catch (e) {
      print('JavaScript channel initialization error: $e');
    }

    // HTML gÃ¼ncellendiÄŸinde WebView'Ä± yenileme callback'i
    onHtmlUpdated = () {
      if (mounted) {
        setState(() {
          // WebView'Ä± yeniden yÃ¼kle
          webViewController.loadHtmlString(initialHTML);
        });

        // HTML yÃ¼klendikten sonra TÃœM JSON'u gÃ¶nder (preset seÃ§imi HTML iÃ§inde yapÄ±lacak)
        Future.delayed(Duration(milliseconds: 500), () {
          if (mounted && deviceJsonConfig != null) {
            print("ğŸ“¤ HTML yÃ¼klendi, tÃ¼m JSON gÃ¶nderiliyor...");
            loadFullJsonToHtml();
            print("âœ… TÃ¼m JSON HTML'e gÃ¶nderildi");
          }
        });
      }
    };

    // BaÅŸlatma iÅŸlemlerini sÄ±ralÄ± olarak yap
    _initializeApp();
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    readCharacteristic?.lastValueStream.listen(null); // Dinleyiciyi temizle
    _connectionStateSubscription?.cancel(); // Connection state subscription'Ä± temizle
    isReconnecting = false; // Yeniden baÄŸlanma iÅŸlemini durdur
    _audioPlayer.dispose(); // Audio player'Ä± temizle
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);
    print("App lifecycle changed: $state");

    // Otomatik reconnect devre dÄ±ÅŸÄ± - sadece manuel baÄŸlantÄ±
    switch (state) {
      case AppLifecycleState.resumed:
        print("App resumed - otomatik baÄŸlantÄ± yok, sadece manuel");
        break;
      case AppLifecycleState.paused:
        print("App paused");
        break;
      case AppLifecycleState.inactive:
        print("App inactive");
        break;
      case AppLifecycleState.detached:
        print("App detached");
        break;
      default:
        break;
    }
  }

  void _checkAndReconnect() async {
    print("=== CHECKING CONNECTION AFTER APP RESUME ===");

    // Manuel baÄŸlantÄ± devam ediyorsa veya yeni bitmiÅŸ ise, otomatik kontrolÃ¼ atla
    if (isManualConnecting) {
      print("ğŸ”µ Manuel baÄŸlantÄ± devam ediyor, _checkAndReconnect iptal edildi");
      return;
    }

    if (lastManualConnectionTime != null) {
      final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
      if (timeSinceManual.inSeconds < 10) {
        print("ğŸ”µ Manuel baÄŸlantÄ±dan ${timeSinceManual.inSeconds} saniye geÃ§ti, _checkAndReconnect iptal edildi");
        return;
      }
    }

    if (connectedDevice != null) {
      try {
        // BaÄŸlantÄ± durumunu kontrol et
        bool isDeviceConnected = connectedDevice!.isConnected;
        print("Device connected status: $isDeviceConnected");

        if (isDeviceConnected) {
          // BaÄŸlantÄ± var ama karakteristikler kaybolmuÅŸ olabilir
          print("Device connected but checking characteristics...");

          if (readCharacteristic == null || writeCharacteristic == null) {
            print("Characteristics lost, rediscovering...");
            _rediscoverServices(connectedDevice!);
          } else {
            // Karakteristikler var, GET komutunu tekrar gÃ¶nder
            print("Characteristics OK, sending GET command...");
            Future.delayed(Duration(seconds: 1), () {
              sendGetCommand();
            });
          }
        } else {
          // BaÄŸlantÄ± kopmuÅŸ, yeniden baÄŸlan
          print("Device disconnected, attempting reconnection...");
          setState(() {
            isConnected = false;
            isReconnecting = true;
          });

          connectToDevice(connectedDevice!);
        }
      } catch (e) {
        print("Error checking connection: $e");
        // Hata durumunda otomatik reconnect baÅŸlat
        setState(() {
          isConnected = false;
          connectedDevice = null;
        });
        startReconnect();
      }
    } else {
      print("No connected device, starting scan...");
      startReconnect();
    }
  }

  Future<void> _initializeApp() async {
    try {
      // Sadece firmware listesini yÃ¼kle
      await _loadFirmwareList();

      print("âœ… Uygulama baÅŸlatÄ±ldÄ± - otomatik baÄŸlantÄ± YOK, sadece manuel baÄŸlantÄ±");
    } catch (e) {
      print("Uygulama baÅŸlatma hatasÄ±: $e");
    }
  }

  Future<void> _loadFirmwareList() async {
    try {
      await fetchFirmwareList(firmwareListUrl, (jsonString) {
        try {
          final jsonData = jsonDecode(jsonString);
          if (mounted) {
            setState(() {
              firmwares = (jsonData['firmwares'] as List).map((item) {
                return {
                  "firmware_name": item['firmware_name'],
                  "html_link": item['html_link']
                };
              }).toList();
            });
          }
          print(
              "Firmware listesi baÅŸarÄ±yla yÃ¼klendi: ${firmwares.length} firmware");
        } catch (e) {
          print("Firmware listesi parse hatasÄ±: $e");
        }
      });
    } catch (e) {
      print("Firmware listesi yÃ¼kleme hatasÄ±: $e");
    }
  }

  void _startBLEConnection() async {
    // Manuel disconnect durumunda otomatik baÄŸlanma yapma
    if (isManualDisconnect) {
      print(
          "Manuel disconnect durumunda olduÄŸu iÃ§in _startBLEConnection iptal edildi");
      return;
    }

    // Manuel baÄŸlantÄ± devam ediyorsa veya yeni bitmiÅŸ ise, otomatik baÄŸlanmayÄ± atla
    if (isManualConnecting) {
      print("ğŸ”µ Manuel baÄŸlantÄ± devam ediyor, _startBLEConnection iptal edildi");
      return;
    }

    if (lastManualConnectionTime != null) {
      final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
      if (timeSinceManual.inSeconds < 10) {
        print("ğŸ”µ Manuel baÄŸlantÄ±dan ${timeSinceManual.inSeconds} saniye geÃ§ti, _startBLEConnection iptal edildi");
        return;
      }
    }

    // KaydedilmiÅŸ cihaz ID'sini yÃ¼kle
    final savedDeviceId = await _loadLastDeviceId();

    if (savedDeviceId != null) {
      print("KaydedilmiÅŸ cihaz ID bulundu: $savedDeviceId");
      print("KaydedilmiÅŸ cihaza otomatik baÄŸlanma baÅŸlatÄ±lÄ±yor...");
      _reconnectToSavedDevice(savedDeviceId);
    } else if (connectedDevice != null) {
      print("Son baÄŸlanÄ±lan cihaza baÄŸlanÄ±lÄ±yor: ${connectedDevice!.name}");
      connectToDevice(connectedDevice!);
    } else {
      // Son baÄŸlanÄ±lan cihaz yoksa, otomatik baÄŸlanma yapma
      print("KaydedilmiÅŸ cihaz bulunamadÄ±, otomatik baÄŸlanma yapÄ±lmÄ±yor");
    }
  }

  // KaydedilmiÅŸ cihaza yeniden baÄŸlanma
  void _reconnectToSavedDevice(String deviceId) async {
    try {
      if (await FlutterBluePlus.isOn) {
        print("Bluetooth aÃ§Ä±k, kaydedilmiÅŸ cihaz aranÄ±yor...");
        await FlutterBluePlus.stopScan();
        await FlutterBluePlus.startScan(timeout: Duration(seconds: 8));

        FlutterBluePlus.scanResults.listen((results) async {
          // Manuel disconnect durumunda baÄŸlanma
          if (isManualDisconnect) {
            print(
                "ğŸš« _reconnectToSavedDevice: Manuel disconnect durumunda - baÄŸlanma iptal edildi");
            return;
          }

          // Manuel baÄŸlantÄ± kontrolÃ¼
          if (isManualConnecting) {
            print("ğŸ”µ Manuel baÄŸlantÄ± devam ediyor, _reconnectToSavedDevice iptal edildi");
            return;
          }

          if (lastManualConnectionTime != null) {
            final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
            if (timeSinceManual.inSeconds < 10) {
              print("ğŸ”µ Manuel baÄŸlantÄ±dan ${timeSinceManual.inSeconds} saniye geÃ§ti, _reconnectToSavedDevice iptal edildi");
              return;
            }
          }

          for (ScanResult r in results) {
            if (r.device.remoteId.toString() == deviceId) {
              print(
                  "KaydedilmiÅŸ cihaz bulundu: ${r.device.platformName} ($deviceId)");
              await FlutterBluePlus.stopScan();
              connectToDevice(r.device);
              break;
            }
          }
        });
      }
    } catch (e) {
      print("KaydedilmiÅŸ cihaza baÄŸlanma hatasÄ±: $e");
    }
  }

  void parseFirmwareList(String jsonString) {
    final jsonData = jsonDecode(jsonString);
    setState(() {
      firmwares = (jsonData['firmwares'] as List).map((item) {
        return {
          "firmware_name": item['firmware_name'],
          "html_link": item['html_link']
        };
      }).toList();
      // HTML'i otomatik aÃ§ma kÄ±smÄ±nÄ± kaldÄ±rdÄ±k
      // if (firmwares.isNotEmpty) {
      //   selectedHtmlUrl = firmwares[0]['html_link'];
      //   downloadHtmlForm(selectedHtmlUrl);
      // }
    });
  }

  void startReconnect() async {
    try {
      // Manuel disconnect durumunda otomatik yeniden baÄŸlanma yapma
      if (isManualDisconnect) {
        print(
            "Manuel disconnect durumunda olduÄŸu iÃ§in startReconnect iptal edildi");
        return;
      }

      // Manuel baÄŸlantÄ± devam ediyorsa, otomatik reconnect'i iptal et
      if (isManualConnecting) {
        print("ğŸ”µ Manuel baÄŸlantÄ± devam ediyor, otomatik reconnect iptal edildi");
        return;
      }

      // Son manuel baÄŸlantÄ±dan 10 saniye geÃ§memiÅŸse, otomatik reconnect'i ertele
      if (lastManualConnectionTime != null) {
        final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
        if (timeSinceManual.inSeconds < 10) {
          print("ğŸ”µ Manuel baÄŸlantÄ±dan ${timeSinceManual.inSeconds} saniye geÃ§ti, otomatik reconnect 10 saniyeye ertelendi");
          Future.delayed(Duration(seconds: 10 - timeSinceManual.inSeconds), () {
            startReconnect();
          });
          return;
        }
      }

      // Bluetooth'un aÃ§Ä±k olup olmadÄ±ÄŸÄ±nÄ± kontrol et
      if (await FlutterBluePlus.isOn) {
        print("Bluetooth aÃ§Ä±k, cihazlar taranÄ±yor...");

        // Ã–nceki taramalarÄ± durdur
        await FlutterBluePlus.stopScan();

        // YakÄ±ndaki cihazlarÄ± tara (timeout artÄ±rÄ±ldÄ±)
        await FlutterBluePlus.startScan(timeout: Duration(seconds: 8));

        // Tarama sonuÃ§larÄ±nÄ± dinle
        FlutterBluePlus.scanResults.listen((results) async {
          for (ScanResult r in results) {
            // Manuel disconnect durumunda baÄŸlanma
            if (isManualDisconnect) {
              print(
                  "Manuel disconnect durumunda olduÄŸu iÃ§in otomatik baÄŸlanma iptal edildi");
              await FlutterBluePlus.stopScan();
              return;
            }

            // Sadece son baÄŸlanan cihazÄ±n MAC adresine baÄŸlan
            if (connectedDevice != null &&
                r.device.remoteId == connectedDevice!.remoteId) {
              print(
                  "Son baÄŸlÄ± cihaz bulundu: ${r.device.platformName} (${r.device.remoteId})");
              await FlutterBluePlus.stopScan();
              connectToDevice(r.device);
              break;
            }
          }
        });

        // 10 saniye sonra taramayÄ± durdurup yeniden dene
        Future.delayed(Duration(seconds: 10), () async {
          if (connectedDevice == null) {
            print("Cihaz bulunamadÄ±, yeniden deneniyor...");
            startReconnect();
          }
        });
      } else {
        print("Bluetooth kapalÄ±!");
        // Bluetooth aÃ§Ä±lmasÄ±nÄ± bekle
        Future.delayed(Duration(seconds: 2), () {
          startReconnect();
        });
      }
    } catch (e) {
      print("BaÄŸlantÄ± hatasÄ±: $e");
      // Hata durumunda 3 saniye bekleyip yeniden dene
      Future.delayed(Duration(seconds: 3), () {
        startReconnect();
      });
    }
  }

  void connectToDevice(BluetoothDevice device, {bool isManual = false}) async {
    try {
      // Manuel baÄŸlantÄ± baÅŸlÄ±yorsa, flag'i set et ve manuel disconnect flag'ini temizle
      if (isManual) {
        print("ğŸ”µ MANUEL BAÄLANTI BAÅLIYOR");
        isManualConnecting = true;
        isManualDisconnect = false; // Manuel baÄŸlantÄ±ya baÅŸlarken temizle
        lastManualConnectionTime = DateTime.now();
      }

      // EÄŸer baÅŸka bir cihaza baÄŸlÄ±ysa, Ã¶nce ondan disconnect ol
      if (connectedDevice != null &&
          connectedDevice!.remoteId != device.remoteId) {
        print(
            'âš ï¸ FarklÄ± cihaza geÃ§iÅŸ yapÄ±lÄ±yor: ${connectedDevice!.platformName} -> ${device.platformName}');
        print('âš ï¸ Ã–nce mevcut cihazdan disconnect olunuyor...');
        try {
          await connectedDevice!.disconnect();
          print('âœ“ Eski cihazdan disconnect baÅŸarÄ±lÄ±');
          await Future.delayed(Duration(milliseconds: 500));
        } catch (e) {
          print("âš ï¸ Eski cihazdan disconnect hatasÄ±: $e");
        }
      }

      // Yeni cihazÄ± disconnect et (emin olmak iÃ§in)
      try {
        await device.disconnect();
      } catch (e) {
        print("Disconnect hatasÄ± (normal): $e");
      }

      // Yeni baÄŸlantÄ± kur
      await device.connect(autoConnect: false, timeout: Duration(seconds: 10));
      setState(() {
        connectedDevice = device;
        isConnected = true;
        isReconnecting = false;
        isManualDisconnect = false; // Otomatik baÄŸlantÄ±da da sÄ±fÄ±rla
      });

      // Cihaz ID'sini kaydet
      await _saveLastDeviceId(device.remoteId.toString());

      print("Manuel baÄŸlantÄ± kuruldu, isManualDisconnect sÄ±fÄ±rlandÄ±");

      // BaÄŸlantÄ± durumunu izle
      _startConnectionMonitoring(device);

      // Servisleri keÅŸfet
      List<BluetoothService> services = await device.discoverServices();
      bool txFound = false, rxFound = false;

      for (BluetoothService service in services) {
        for (BluetoothCharacteristic characteristic
            in service.characteristics) {
          if (characteristic.uuid == Guid(bleuart_tx_characteristic)) {
            writeCharacteristic = characteristic;
            txFound = true;
            print("TX karakteristiÄŸi bulundu");
          } else if (characteristic.uuid == Guid(bleuart_rx_characteristic)) {
            readCharacteristic = characteristic;
            rxFound = true;
            print("RX karakteristiÄŸi bulundu");
          }
        }
      }

      if (!txFound || !rxFound) {
        print(
            "Gerekli karakteristikler bulunamadÄ±! TX: $txFound, RX: $rxFound");
        throw Exception("BLE karakteristikleri bulunamadÄ±");
      }

      // RX notification'Ä± hemen aktif et (firmware veri gÃ¶ndermeden Ã¶nce)
      print("ğŸ”” RX notification aktif ediliyor...");
      listenToBLEData();

      print("BLE baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!");

      // Otomatik baÄŸlantÄ±da da ses Ã§al (manuel baÄŸlantÄ± gibi)
      _playConnectionSound();

      // Manuel baÄŸlantÄ± tamamlandÄ±, flag'i sÄ±fÄ±rla
      if (isManualConnecting) {
        print("ğŸ”µ MANUEL BAÄLANTI TAMAMLANDI");
        isManualConnecting = false;
      }

      // NOT: GET komutu GÃ–NDERMÄ°YORUZ
      // Firmware zaten connect_callback() iÃ§inde otomatik olarak JSON gÃ¶nderiyor:
      // 1. DEVICE_INFO (delay 1000ms sonra)
      // 2. JSON_START + JSON data + JSON_END (delay 100ms sonra)
      // 3. LOAD_HTML (delay 100ms sonra)
      // Bu otomatik gÃ¶nderim yeterli, GET komutu gereksiz ve Ã§ift gÃ¶nderime yol aÃ§ar
      print("âœ… BaÄŸlantÄ± tamamlandÄ± - firmware otomatik veri gÃ¶nderecek");
    } catch (e) {
      print("âŒ BaÄŸlantÄ± hatasÄ±: $e");

      // Manuel baÄŸlantÄ± baÅŸarÄ±sÄ±z oldu, flag'i sÄ±fÄ±rla
      if (isManualConnecting) {
        print("ğŸ”µ MANUEL BAÄLANTI BAÅARISIZ");
        isManualConnecting = false;
      }

      // Otomatik reconnect KALDIRILDI - kullanÄ±cÄ± manuel olarak tekrar denemeli
      print("âŒ BaÄŸlantÄ± baÅŸarÄ±sÄ±z - otomatik reconnect YOK");
    }
  }

  // Genel BLE komut gÃ¶nderme fonksiyonu (prefix olmadan, chunking destekli)
  void sendBleCommand(String command, {bool useChunking = false}) async {
    if (writeCharacteristic != null) {
      try {
        // Komutun sonunda \n yoksa ekle
        String cmd = command.endsWith('\n') ? command : command + '\n';
        List<int> bytes = utf8.encode(cmd);

        if (useChunking && bytes.length > 244) {
          // BÃ¼yÃ¼k veriler iÃ§in chunking kullan (SET_PRESET gibi)
          print("ğŸ“¤ BLE komutu gÃ¶nderiliyor (chunked): ${cmd.substring(0, 50)}... (${bytes.length} bytes)");
          int chunkSize = 244;
          for (var i = 0; i < bytes.length; i += chunkSize) {
            var end = (i + chunkSize < bytes.length) ? i + chunkSize : bytes.length;
            var chunk = bytes.sublist(i, end);
            await writeCharacteristic!.write(chunk, withoutResponse: true);
            // ParÃ§alar arasÄ± kÄ±sa bir bekleme ekle
            await Future.delayed(Duration(milliseconds: 100));
          }
          print("âœ… Chunked veri gÃ¶nderildi");
        } else {
          // KÃ¼Ã§Ã¼k komutlar iÃ§in tek seferde gÃ¶nder
          await writeCharacteristic!.write(bytes, withoutResponse: false);
          print("ğŸ“¤ BLE komutu gÃ¶nderildi: ${cmd.length < 100 ? cmd.trim() : '${cmd.substring(0, 50)}... (${bytes.length} bytes)'}");
        }
      } catch (e) {
        print("âŒ BLE komutu gÃ¶nderme hatasÄ±: $e");
      }
    } else {
      print("âŒ HATA: Write karakteristiÄŸi bulunamadÄ±!");
    }
  }

  void sendGetCommand() async {
    sendBleCommand("GET");
  }

  // BaÄŸlantÄ± durumunu izleyen fonksiyon
  void _startConnectionMonitoring(BluetoothDevice device) {
    // Eski subscription varsa iptal et (birden fazla listener Ã¶nleme)
    _connectionStateSubscription?.cancel();
    print("ğŸ”„ Connection monitoring baÅŸlatÄ±lÄ±yor (eski listener iptal edildi)");

    // CihazÄ±n baÄŸlantÄ± durumunu izle
    _connectionStateSubscription = device.connectionState.listen((BluetoothConnectionState state) {
      print("BaÄŸlantÄ± durumu deÄŸiÅŸti: $state");

      if (state == BluetoothConnectionState.disconnected) {
        // Manuel disconnect durumunu kontrol et
        print(
            "Disconnect oldu! isManualDisconnectRequested: $isManualDisconnectRequested, isManualDisconnect: $isManualDisconnect");

        if (isManualDisconnectRequested) {
          isManualDisconnect = true;
          isManualDisconnectRequested = false; // Durumu sÄ±fÄ±rla
          print("Manuel disconnect olarak iÅŸaretlendi");
          // NOT: _clearLastDeviceId zaten BLE ekranÄ±ndan callback ile Ã§aÄŸrÄ±lÄ±yor
        }

        print("Cihaz baÄŸlantÄ±sÄ± koptu! Manuel disconnect: $isManualDisconnect");

        // BaÄŸlantÄ± kopma sesi Ã§al
        _playDisconnectionSound();

        setState(() {
          isConnected = false;
          connectedDevice = null;
          writeCharacteristic = null;
          readCharacteristic = null;
        });

        // Otomatik yeniden baÄŸlanma KALDIRILDI - sadece manuel baÄŸlantÄ±
        print("âŒ Cihaz baÄŸlantÄ±sÄ± koptu - otomatik reconnect YOK");
      } else if (state == BluetoothConnectionState.connected) {
        print("âœ… Cihaz baÄŸlandÄ±!");
        setState(() {
          isConnected = true;
          connectedDevice = device;
        });
      }
    });
  }

  // Otomatik yeniden baÄŸlanma fonksiyonu
  void _startAutoReconnect(BluetoothDevice device) {
    setState(() {
      isReconnecting = true;
    });

    print("Otomatik yeniden baÄŸlanma baÅŸlatÄ±ldÄ±...");

    // 2 saniye bekle ve yeniden baÄŸlanmayÄ± dene
    Future.delayed(Duration(seconds: 2), () {
      if (!isConnected && isReconnecting) {
        _attemptReconnect(device);
      }
    });
  }

  // Yeniden baÄŸlanma denemesi
  void _attemptReconnect(BluetoothDevice device) async {
    if (isConnected) return; // Zaten baÄŸlÄ±ysa Ã§Ä±k

    try {
      print("Yeniden baÄŸlanma deneniyor: ${device.name}");
      await device.connect(autoConnect: false, timeout: Duration(seconds: 5));

      // BaÄŸlantÄ± baÅŸarÄ±lÄ±
      setState(() {
        connectedDevice = device;
        isConnected = true;
        isReconnecting = false;
        // isManualDisconnect durumunu otomatik yeniden baÄŸlanmada sÄ±fÄ±rlamÄ±yoruz
        // Sadece manuel baÄŸlanmada sÄ±fÄ±rlanacak
      });

      print(
          "Otomatik yeniden baÄŸlanma baÅŸarÄ±lÄ±, isManualDisconnect: $isManualDisconnect");

      // Otomatik yeniden baÄŸlanmada da ses Ã§al
      _playConnectionSound();

      // Servisleri yeniden keÅŸfet
      _rediscoverServices(device);
    } catch (e) {
      print("Yeniden baÄŸlanma baÅŸarÄ±sÄ±z: $e");

      // 5 saniye bekle ve tekrar dene
      Future.delayed(Duration(seconds: 5), () {
        if (!isConnected && isReconnecting) {
          _attemptReconnect(device);
        }
      });
    }
  }

  // Servisleri yeniden keÅŸfetme fonksiyonu
  void _rediscoverServices(BluetoothDevice device) async {
    try {
      List<BluetoothService> services = await device.discoverServices();
      bool txFound = false, rxFound = false;

      for (BluetoothService service in services) {
        for (BluetoothCharacteristic characteristic
            in service.characteristics) {
          if (characteristic.uuid == Guid(bleuart_tx_characteristic)) {
            writeCharacteristic = characteristic;
            txFound = true;
            print("TX karakteristiÄŸi yeniden bulundu");
          } else if (characteristic.uuid == Guid(bleuart_rx_characteristic)) {
            readCharacteristic = characteristic;
            rxFound = true;
            print("RX karakteristiÄŸi yeniden bulundu");
            listenToBLEData();
          }
        }
      }

      if (txFound && rxFound) {
        print("Servisler yeniden keÅŸfedildi, GET komutu gÃ¶nderiliyor...");
        Future.delayed(Duration(seconds: 1), () {
          sendGetCommand();
        });
      }
    } catch (e) {
      print("Servis keÅŸfetme hatasÄ±: $e");
    }
  }

  void listenToBLEData() async {
    if (readCharacteristic != null) {
      try {
        // BLE notification kurulumunu bekle ve doÄŸrula
        bool success = await readCharacteristic!.setNotifyValue(true);
        if (!success) {
          print("âŒ BLE notification kurulamadÄ±!");
          return;
        }
        print("âœ… BLE notification baÅŸarÄ±yla aktifleÅŸtirildi");

        // Notification'larÄ±n Bluetooth stack'te tamamen hazÄ±r olmasÄ± iÃ§in bekle
        // Firmware 2+ saniye sonra veri gÃ¶ndermeye baÅŸlayacaÄŸÄ± iÃ§in bu sÃ¼re yeterli
        await Future.delayed(Duration(milliseconds: 200));
        print("âœ… BLE notifications hazÄ±r - veri dinleme baÅŸlÄ±yor");

        readCharacteristic!.lastValueStream.listen((value) {
          try {
            // BoÅŸ veri gelirse ignore et
            if (value.isEmpty) {
              print("BoÅŸ BLE verisi alÄ±ndÄ±, ignore ediliyor");
              return;
            }

            String bleData = String.fromCharCodes(value);
            print("=== BLE VERI ALINDI ===");
            print("Raw bytes: $value");
            print("Decoded string: '$bleData'");
            print("Data length: ${bleData.length}");

            setState(() {
              receivedData = receivedData + bleData;

              // Gelen veriyi buffer'a ekle
              _incomingData += bleData;

              // EÄŸer veri \n iÃ§eriyorsa, satÄ±r satÄ±r iÅŸle
              if (_incomingData.contains("\n")) {
                List<String> lines = _incomingData.split("\n");

                // Son satÄ±r tam deÄŸilse buffer'da tut
                if (!_incomingData.endsWith("\n")) {
                  _incomingData = lines.removeLast();
                } else {
                  _incomingData = "";
                }

                // Tam olan satÄ±rlarÄ± iÅŸle
                for (String line in lines) {
                  if (line.isEmpty) continue;

                  try {
                    // DEVICE_INFO: komutu gelirse cihaz bilgilerini parse et
                    if (line.startsWith("DEVICE_INFO:")) {
                      String info =
                          line.substring(12); // "DEVICE_INFO:" uzunluÄŸu 12
                      List<String> infoParts = info.split(',');

                      for (String part in infoParts) {
                        List<String> keyValue = part.split('=');
                        if (keyValue.length == 2) {
                          String key = keyValue[0].trim();
                          String value = keyValue[1].trim();

                          if (key == 'model') {
                            deviceModel = value;
                          } else if (key == 'firmware') {
                            deviceFirmware = value;
                          } else if (key == 'hardware') {
                            deviceHardware = value;
                          } else if (key == 'serial') {
                            deviceSerial = value;
                          }
                        }
                      }
                      print(
                          "Device Info - Model: $deviceModel, Firmware: $deviceFirmware, Hardware: $deviceHardware, Serial: $deviceSerial");
                    }
                    // NOT: LOAD_HTML komutu artÄ±k kullanÄ±lmÄ±yor - HTML bilgisi JSON iÃ§inde "load-html" field'Ä±nda geliyor
                    // JSON alma baÅŸlangÄ±cÄ±
                    else if (line == "JSON_START") {
                      print("ğŸ“¦ JSON alÄ±mÄ± baÅŸlÄ±yor...");
                      isReceivingJson = true;
                      receivedJsonBuffer = '';
                    }
                    // JSON alma bitiÅŸi
                    else if (line == "JSON_END") {
                      print("âœ… JSON alÄ±mÄ± tamamlandÄ±");
                      isReceivingJson = false;
                      parseDeviceJson();
                    }
                    // JSON verisi geliyor
                    else if (isReceivingJson) {
                      receivedJsonBuffer += line;
                    }
                    // TELEMETRY: ile baÅŸlÄ±yorsa sensor verilerini parse et (sadece sensor ekranÄ± aÃ§Ä±kken)
                    else if (line.startsWith("TELEMETRY:") &&
                        isSensorScreenActive) {
                      String values =
                          line.substring(10); // "TELEMETRY:" uzunluÄŸu 10
                      List<String> parts = values.split(',');

                      // Format: TELEMETRY:gx,gy,gz,ax,ay,az,press,alt,mx,my,mz,batt,sw1,sw2,sw3,roll,pitch,heading
                      if (parts.length >= 18) {
                        sensorGyroX = double.tryParse(parts[0]) ?? 0.0;
                        sensorGyroY = double.tryParse(parts[1]) ?? 0.0;
                        sensorGyroZ = double.tryParse(parts[2]) ?? 0.0;
                        sensorAccelX = double.tryParse(parts[3]) ?? 0.0;
                        sensorAccelY = double.tryParse(parts[4]) ?? 0.0;
                        sensorAccelZ = double.tryParse(parts[5]) ?? 0.0;
                        // Pressure comes in Pa, convert to mbar (hPa) by dividing by 100
                        sensorPressure =
                            (double.tryParse(parts[6]) ?? 0.0) / 100.0;
                        sensorAltitude = double.tryParse(parts[7]) ?? 0.0;
                        sensorMagX = double.tryParse(parts[8]) ?? 0.0;
                        sensorMagY = double.tryParse(parts[9]) ?? 0.0;
                        sensorMagZ = double.tryParse(parts[10]) ?? 0.0;
                        sensorBatteryVoltage =
                            double.tryParse(parts[11]) ?? 0.0;
                        sensorSwitch1 = parts[12] == "1";
                        sensorSwitch2 = parts[13] == "1";
                        sensorSwitch3 = parts[14] == "1";
                        sensorAHRSRoll = double.tryParse(parts[15]) ?? 0.0;
                        sensorAHRSPitch = double.tryParse(parts[16]) ?? 0.0;
                        sensorAHRSHeading = double.tryParse(parts[17]) ?? 0.0;
                        sensorLastUpdate =
                            DateTime.now().toString().substring(11, 19);
                        lastTelemetryReceived =
                            DateTime.now(); // Update last received time
                        print("ğŸ“Š Telemetry data updated: $sensorLastUpdate");
                      }
                    }
                    // JSON kaydetme baÅŸarÄ±lÄ±
                    else if (line == "JSON_SAVED_OK") {
                      print("âœ… Firmware JSON'u baÅŸarÄ±yla kaydetti");
                      // HTML'e baÅŸarÄ± bildirimini gÃ¶nder
                      webViewController.runJavaScript('''
                        if (typeof onSaveComplete === 'function') {
                          onSaveComplete(true);
                        }
                      ''');
                    }
                    // JSON kaydetme hatasÄ±
                    else if (line.startsWith("JSON_ERROR")) {
                      print("âŒ Firmware JSON kaydetme hatasÄ±: $line");
                      // HTML'e hata bildirimini gÃ¶nder
                      webViewController.runJavaScript('''
                        if (typeof onSaveComplete === 'function') {
                          onSaveComplete(false);
                        }
                      ''');
                    }
                  } catch (e) {
                    print("SatÄ±r iÅŸleme hatasÄ±: $e, SatÄ±r: $line");
                  }
                }
              }
            });
          } catch (e) {
            print("BLE veri iÅŸleme hatasÄ±: $e");
          }
        }, onError: (error) {
          print("BLE veri dinleme hatasÄ±: $error");
          // Hata durumunda baÄŸlantÄ±yÄ± yeniden kur
          Future.delayed(Duration(seconds: 2), () {
            if (connectedDevice != null) {
              connectToDevice(connectedDevice!);
            }
          });
        });
      } catch (e) {
        print("BLE notification ayarlama hatasÄ±: $e");
      }
    } else {
      print("readCharacteristic null!");
    }
  }

  // JSON'Ä± parse et ve preset listesini oluÅŸtur
  void parseDeviceJson() async {
    try {
      print("ğŸ“ JSON parsing baÅŸlÄ±yor...");
      print("Buffer boyutu: ${receivedJsonBuffer.length}");

      deviceJsonConfig = json.decode(receivedJsonBuffer);

      // JSON'dan load-html field'Ä±nÄ± oku ve HTML'i yÃ¼kle
      if (deviceJsonConfig != null && deviceJsonConfig!['load-html'] != null) {
        String htmlFileName = deviceJsonConfig!['load-html'];
        print("ğŸ“„ JSON'dan HTML dosya adÄ± alÄ±ndÄ±: $htmlFileName");

        // HTML'i indir (eÄŸer zaten indirme devam etmiyorsa)
        if (!_isDownloadingHtml) {
          _isDownloadingHtml = true;
          String htmlUrl = "https://raw.githubusercontent.com/melihkarakelle/FlexiTimer_Files/main/htmls/$htmlFileName";
          print("ğŸ“¥ HTML indiriliyor: $htmlUrl");

          downloadHtmlForm(htmlUrl).then((_) {
            _isDownloadingHtml = false;
            print("âœ… HTML indirildi ve yÃ¼klendi");
          }).catchError((error) {
            print("âŒ HTML download hatasÄ±: $error");
            _isDownloadingHtml = false;
          });
        }
      }

      if (deviceJsonConfig != null && deviceJsonConfig!['presets'] != null) {
        presetsList = List<Map<String, dynamic>>.from(deviceJsonConfig!['presets']);
        print("âœ… ${presetsList.length} preset bulundu");
        setState(() {}); // UI gÃ¼ncelle
      }
    } catch (e) {
      print("âŒ JSON parse hatasÄ±: $e");
      print("Buffer iÃ§eriÄŸi: $receivedJsonBuffer");
    }
  }

  // TÃ¼m JSON'u HTML'e gÃ¶nder (preset seÃ§imi HTML iÃ§inde yapÄ±lacak)
  void processBLEDataAndSendToForm(Map<String, dynamic> presetData) {
    // DEPRECATED: ArtÄ±k kullanÄ±lmÄ±yor, loadFullJsonToHtml() kullanÄ±lÄ±yor
    // Bu fonksiyon geriye dÃ¶nÃ¼k uyumluluk iÃ§in bÄ±rakÄ±ldÄ±
    if (presetData.isEmpty) return;

    // Eski mantÄ±k: tek preset gÃ¶nder
    Map<String, dynamic> dataWithModel = {
      'model-name': deviceJsonConfig?['model-name'] ?? 'Unknown',
      ...presetData,
    };

    String jsonString = jsonEncode(dataWithModel)
        .replaceAll('\\', '\\\\')
        .replaceAll("'", "\\'")
        .replaceAll('\n', '\\n')
        .replaceAll('\r', '\\r');

    final script = '''
      if (typeof loadPresetDataFromJSON === 'function') {
        loadPresetDataFromJSON('$jsonString');
      } else {
        console.error('âŒ loadPresetDataFromJSON function not found in HTML');
      }
    ''';

    webViewController.runJavaScript(script);
  }

  // TÃ¼m cihaz JSON'unu HTML'e yÃ¼kle (yeni metod)
  void loadFullJsonToHtml() {
    if (deviceJsonConfig == null) {
      print("âŒ Device JSON config yok, HTML'e gÃ¶nderilemiyor");
      return;
    }

    // TÃ¼m JSON'u escape et ve gÃ¶nder
    String jsonString = jsonEncode(deviceJsonConfig)
        .replaceAll('\\', '\\\\')
        .replaceAll("'", "\\'")
        .replaceAll('\n', '\\n')
        .replaceAll('\r', '\\r');

    print("ğŸ“¤ TÃ¼m JSON HTML'e gÃ¶nderiliyor (${jsonString.length} chars)");

    // HTML iÃ§indeki initializeWithFullJson fonksiyonunu Ã§aÄŸÄ±r
    final script = '''
      if (typeof initializeWithFullJson === 'function') {
        console.log('ğŸ“¥ Full JSON received from Flutter');
        initializeWithFullJson('$jsonString');
      } else {
        console.error('âŒ initializeWithFullJson function not found in HTML');
      }
    ''';

    webViewController.runJavaScript(script);
  }

  // Preset ismini gÃ¼ncelleyen fonksiyon
  void sendFormDataToBLE(String formData) async {
    //receivedData = receivedData + formData;
    if (writeCharacteristic != null) {
      //print("GÃ¶nderilen Form Verisi: $formData");
      // SET_PRESET komutu bÃ¼yÃ¼k olduÄŸu iÃ§in chunking kullan
      sendBleCommand("SET_PRESET:$formData,", useChunking: true);
    }
  }

  // HTML'den gelen tÃ¼m JSON'u BLE ile firmware'e gÃ¶nder
  void sendFullJsonToBLE(String jsonString) async {
    if (writeCharacteristic == null) {
      print("âŒ Write characteristic null, cannot send JSON");
      return;
    }

    try {
      // JSON'u parse edelim (validation iÃ§in)
      var jsonData = json.decode(jsonString);
      print("âœ… Valid JSON received from HTML");
      print("   - Presets count: ${jsonData['presets']?.length ?? 0}");
      print("   - Selected index: ${jsonData['selected-preset-index']}");

      // TÃ¼m JSON'u firmware'e yaz
      print("ğŸ“¤ Sending WRITE_JSON command with full configuration...");

      String command = "WRITE_JSON:$jsonString\n";
      sendBleCommand(command, useChunking: true);

      print("âœ… Full JSON command sent");

      // Local deviceJsonConfig'i de gÃ¼ncelle
      setState(() {
        deviceJsonConfig = jsonData;
      });

    } catch (e) {
      print("âŒ Error processing JSON: $e");
    }
  }

  void openBLEScreen() async {
    // EÄŸer cihaz baÄŸlÄ±ysa Ã¶nce disconnect onayÄ± iste
    if (isConnected && connectedDevice != null) {
      if (!mounted) return;

      bool? shouldDisconnect = await showDialog<bool>(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return AlertDialog(
            backgroundColor: Color(0xFF1E1E1E),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
              side: BorderSide(color: Color(0xFF444444), width: 1),
            ),
            title: Row(
              children: [
                Icon(Icons.bluetooth_disabled, color: Color(0xFFFF5252), size: 24),
                SizedBox(width: 10),
                Expanded(
                  child: Text(
                    'Disconnect Device?',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Currently connected to:',
                  style: TextStyle(
                    color: Color(0xFF999999),
                    fontSize: 14,
                  ),
                ),
                SizedBox(height: 8),
                Container(
                  width: double.infinity,
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Color(0xFF2D2D2D),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Color(0xFF2196F3), width: 2),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.bluetooth_connected, color: Color(0xFF2196F3), size: 24),
                      SizedBox(width: 10),
                      Expanded(
                        child: Text(
                          connectedDevice!.platformName,
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                            fontFamily: 'monospace',
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(height: 16),
                Text(
                  'Do you want to disconnect and scan for other devices?',
                  style: TextStyle(
                    color: Color(0xFFCCCCCC),
                    fontSize: 14,
                  ),
                ),
              ],
            ),
            actionsPadding: EdgeInsets.fromLTRB(16, 8, 16, 12),
            actionsAlignment: MainAxisAlignment.end,
            actions: [
              // Cancel button
              OutlinedButton(
                style: OutlinedButton.styleFrom(
                  foregroundColor: Color(0xFF999999),
                  side: BorderSide(color: Color(0xFF555555), width: 1),
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                onPressed: () => Navigator.pop(context, false),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.close, size: 18),
                    SizedBox(width: 6),
                    Text(
                      'CANCEL',
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(width: 12),
              // Disconnect button
              ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xFFFF5252),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  elevation: 3,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                onPressed: () => Navigator.pop(context, true),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.bluetooth_disabled, size: 18),
                    SizedBox(width: 6),
                    Text(
                      'DISCONNECT',
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          );
        },
      );

      // KullanÄ±cÄ± iptal ettiyse Ã§Ä±k
      if (shouldDisconnect != true) return;

      // Disconnect ve saved device'Ä± temizle
      isManualDisconnect = true;
      await connectedDevice!.disconnect();
      await _clearLastDeviceId();

      if (!mounted) return;
      setState(() {
        connectedDevice = null;
        isConnected = false;
      });
    }

    // BLE ekranÄ±nÄ± aÃ§
    if (!mounted) return;
    final wasConnected = connectedDevice != null;
    final result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => BLEDevicesScreen(
          onDeviceSelected: (device) {
            connectToDevice(device, isManual: true); // Manuel baÄŸlantÄ±
          },
          lastConnectedDevice: connectedDevice,
          onManualDisconnect: () async {
            // Manuel disconnect flag'ini hemen ayarla
            isManualDisconnect = true;
            isManualDisconnectRequested = true;
            print("ğŸš« Manuel disconnect flag'leri ayarlandÄ±");

            // Devam eden taramalarÄ± durdur
            try {
              await FlutterBluePlus.stopScan();
              print("ğŸš« BLE taramasÄ± durduruldu");
            } catch (e) {
              print("Tarama durdurma hatasÄ±: $e");
            }

            // SharedPreferences'Ä± temizle (await ile bekle)
            await _clearLastDeviceId();
            print("ğŸš« SharedPreferences temizlendi");
          },
        ),
      ),
    );

    if (!mounted) return;
    if (result != null && result is BluetoothDevice) {
      setState(() {
        connectedDevice = result;
      });
    } else if (wasConnected && connectedDevice == null) {
      setState(() {}); // Force a rebuild if disconnected
    }
  }

  void openDeviceSettings() async {
    // EÄŸer cihaz baÄŸlÄ±ysa gerÃ§ek BLE adÄ±nÄ± kullan, yoksa varsayÄ±lanÄ±
    String currentName = deviceBLEName;
    if (connectedDevice != null && connectedDevice!.platformName.isNotEmpty) {
      currentName = connectedDevice!.platformName;
      print("ğŸ”§ Using connected device name: '$currentName'");
    } else {
      print("ğŸ”§ Using default device name: '$currentName'");
      print("ğŸ”§ connectedDevice: ${connectedDevice != null ? 'exists' : 'null'}");
      if (connectedDevice != null) {
        print("ğŸ”§ platformName: '${connectedDevice!.platformName}'");
      }
    }

    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => DeviceSettingsScreen(
          currentBLEName: currentName,
          connectedDevice: connectedDevice,
          onBLENameChanged: (newName) {
            setState(() {
              deviceBLEName = "FlexiTimer-$newName";
            });
            _sendBLENameToDevice(newName);
          },
          onFactoryReset: isConnected ? factoryReset : null,
        ),
      ),
    );
  }

  void factoryReset() async {
    if (!isConnected || writeCharacteristic == null) {
      print("âŒ Factory reset Ã§aÄŸrÄ±ldÄ± ama baÄŸlantÄ± yok!");
      return;
    }

    print("ğŸ­ Factory reset komutu gÃ¶nderiliyor...");
    sendBleCommand("FACTORY_RESET");

    // Cihaz reset olacak, baÄŸlantÄ± kopacak
    // UI'Ä± gÃ¼ncellemek iÃ§in kÄ±sa bir gecikme sonra disconnect durumunu ayarla
    Future.delayed(Duration(seconds: 2), () {
      if (mounted) {
        setState(() {
          isConnected = false;
          connectedDevice = null;
        });
      }
    });
  }

  void openServoTesterScreen() async {
    if (connectedDevice == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Ã–nce bir cihaza baÄŸlanÄ±n!")),
      );
      return;
    }

    // UyarÄ± dialogu gÃ¶ster
    bool? confirm = await showDialog<bool>(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: Text('Servo Tester Mode'),
          content: Text(
            'When you exit Servo Tester mode, FlexiTimer will restart.\n\n'
            'Any unsaved configuration changes will be lost.\n\n'
            'Do you want to continue?',
            style: TextStyle(fontSize: 14),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(false),
              child: Text('Cancel', style: TextStyle(color: Colors.grey)),
            ),
            TextButton(
              onPressed: () => Navigator.of(context).pop(true),
              child: Text('Continue', style: TextStyle(color: Colors.blue)),
            ),
          ],
        );
      },
    );

    // KullanÄ±cÄ± onayladÄ±ysa servo tester'Ä± aÃ§
    if (confirm == true) {
      await Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => ServoTesterScreen(device: connectedDevice!),
        ),
      );
    }
  }

  void openSensorDataScreen() async {
    if (connectedDevice == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Ã–nce bir cihaza baÄŸlanÄ±n!")),
      );
      return;
    }

    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => SensorDataScreen(
          device: connectedDevice!,
        ),
      ),
    );
  }

  void exportSettings() async {
    // JSON verisini kontrol et
    if (receivedJsonBuffer.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text("No configuration data available. Connect to a device first."),
          backgroundColor: Color(0xFFFF5252),
        ),
      );
      return;
    }

    // Export Settings ekranÄ±nÄ± aÃ§
    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ExportSettingsScreen(
          jsonConfig: receivedJsonBuffer,
        ),
      ),
    );
  }

  void _sendBLENameToDevice(String newName) async {
    if (writeCharacteristic != null) {
      // BLE cihazÄ±na yeni device name'i gÃ¶nder
      String command = "SET_BLE_NAME:$newName\n";
      List<int> bytes = utf8.encode(command);
      await writeCharacteristic!.write(bytes, withoutResponse: true);
      print("BLE device name sent: $newName");
    }
  }

  // dispose fonksiyonu zaten yukarda tanÄ±mlÄ±

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Color(0xFF1A1A1A), // Koyu gri arkaplan
      body: Column(
        children: [
          // Timer Connected ve SCAN butonu
          Container(
            padding: EdgeInsets.fromLTRB(16, 45, 16, 4),
            decoration: BoxDecoration(
              color: Color(0xFF000000),
              boxShadow: [
                BoxShadow(
                  color: Colors.black26,
                  blurRadius: 2,
                  offset: Offset(0, 1),
                ),
              ],
            ),
            child: Row(
              children: [
                // Menu butonu
                GestureDetector(
                  onTap: () {
                    showMenu(
                      context: context,
                      position: RelativeRect.fromLTRB(0, 80, 0, 0),
                      items: [
                        PopupMenuItem(
                          child: Row(
                            children: [
                              Icon(Icons.settings, size: 18),
                              SizedBox(width: 8),
                              Text('Settings'),
                            ],
                          ),
                          onTap: () {
                            Future.delayed(Duration.zero, openDeviceSettings);
                          },
                        ),
                        PopupMenuItem(
                          enabled: isConnected,
                          child: Row(
                            children: [
                              Icon(
                                Icons.sensors,
                                size: 18,
                                color: isConnected ? null : Colors.grey,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Sensor Data',
                                style: TextStyle(
                                  color: isConnected ? null : Colors.grey,
                                ),
                              ),
                            ],
                          ),
                          onTap: isConnected
                              ? () {
                                  Future.delayed(
                                      Duration.zero, openSensorDataScreen);
                                }
                              : null,
                        ),
                        PopupMenuItem(
                          enabled: isConnected,
                          child: Row(
                            children: [
                              Icon(
                                Icons.tune,
                                size: 18,
                                color: isConnected ? null : Colors.grey,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Servo Tester',
                                style: TextStyle(
                                  color: isConnected ? null : Colors.grey,
                                ),
                              ),
                            ],
                          ),
                          onTap: isConnected
                              ? () {
                                  Future.delayed(
                                      Duration.zero, openServoTesterScreen);
                                }
                              : null,
                        ),
                        PopupMenuItem(
                          enabled: isConnected,
                          child: Row(
                            children: [
                              Icon(
                                Icons.file_download,
                                size: 18,
                                color: isConnected ? null : Colors.grey,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Export Settings',
                                style: TextStyle(
                                  color: isConnected ? null : Colors.grey,
                                ),
                              ),
                            ],
                          ),
                          onTap: isConnected
                              ? () {
                                  Future.delayed(Duration.zero, exportSettings);
                                }
                              : null,
                        ),
                      ],
                    );
                  },
                  child: Container(
                    padding: EdgeInsets.all(6),
                    child: Icon(
                      Icons.menu,
                      color: Colors.white,
                      size: 40,
                    ),
                  ),
                ),
                // BaÄŸlÄ± cihaz adÄ± (responsive text)
                Expanded(
                  child: Center(
                    child: Text(
                      isConnected && connectedDevice != null
                          ? connectedDevice!.platformName
                          : '',
                      style: TextStyle(
                        color: Color(0xFFFFFFFF),
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        fontFamily: 'monospace',
                        letterSpacing: 0.5,
                      ),
                      overflow: TextOverflow.ellipsis,
                      maxLines: 1,
                      textAlign: TextAlign.center,
                    ),
                  ),
                ),
                // BLE butonu (renk baÄŸlantÄ± durumuna gÃ¶re)
                GestureDetector(
                  onTap: openBLEScreen,
                  child: Container(
                    padding: EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: isConnected
                          ? Color(0xFF66BB6A)  // YeÅŸil (baÄŸlÄ±) - renk kÃ¶rÃ¼ dostu
                          : Color(0xFFEF5350), // KÄ±rmÄ±zÄ± (baÄŸlÄ± deÄŸil) - renk kÃ¶rÃ¼ dostu
                      borderRadius: BorderRadius.circular(8),
                      boxShadow: [
                        BoxShadow(
                          color: (isConnected ? Color(0xFF66BB6A) : Color(0xFFEF5350))
                              .withValues(alpha: 0.3),
                          blurRadius: 8,
                          spreadRadius: 1,
                        ),
                      ],
                    ),
                    child: Icon(
                      isConnected
                          ? Icons.bluetooth_connected
                          : Icons.bluetooth_searching,
                      color: isConnected ? Colors.black : Colors.white,
                      size: 20,
                    ),
                  ),
                ),
              ],
            ),
          ),
          // Ana Ä°Ã§erik - HTML WebView
          Expanded(
            child: Container(
              decoration: BoxDecoration(
                color: Color(0xFF000000), // Siyah arka plan
              ),
              child: !isConnected ? _buildConnectionPrompt() : _buildWebView(),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildConnectionPrompt() {
    return Center(
      child: Container(
        margin: EdgeInsets.all(32),
        padding: EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Color(0xFF2D2D2D),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Color(0xFF444444), width: 2),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 8,
              offset: Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Ä°kon duruma gÃ¶re deÄŸiÅŸir
            Icon(
              isReconnecting
                  ? Icons.bluetooth_searching
                  : Icons.bluetooth_disabled,
              size: 64,
              color: isReconnecting ? Color(0xFFFFAA00) : Color(0xFFFF5252),
            ),
            SizedBox(height: 16),
            // BaÅŸlÄ±k duruma gÃ¶re deÄŸiÅŸir
            Text(
              isReconnecting ? "Reconnecting..." : "FlexiTimer Not Connected",
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 8),
            // AÃ§Ä±klama duruma gÃ¶re deÄŸiÅŸir
            Text(
              isReconnecting
                  ? "Trying to reconnect to your FlexiTimer device..."
                  : "Please connect to your FlexiTimer device to configure settings",
              style: TextStyle(
                fontSize: 16,
                color: Color(0xFFCCCCCC),
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 24),
            // Buton sadece yeniden baÄŸlanmÄ±yorsa gÃ¶sterilir
            if (!isReconnecting)
              ElevatedButton.icon(
                onPressed: openBLEScreen,
                icon: Icon(Icons.bluetooth_searching, size: 24),
                label: Text(
                  "SCAN FOR DEVICES",
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xFFFFD700),
                  foregroundColor: Color(0xFF000000),
                  padding: EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  elevation: 4,
                ),
              ),
            // Yeniden baÄŸlanma durumunda progress indicator
            if (isReconnecting)
              CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFFFAA00)),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildWebView() {
    return Container(
      margin: EdgeInsets.zero,
      decoration: BoxDecoration(
        color: Color(0xFF000000),
        borderRadius: BorderRadius.zero,
      ),
      child: WebViewWidget(
        controller: webViewController,
      ),
    );
  }
}
