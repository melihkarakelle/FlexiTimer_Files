import 'dart:async';
import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'package:webview_flutter/webview_flutter.dart';
import 'package:bmk_flexitimer_configurator/variables.dart';
//import 'package:http/http.dart' as http;
import 'package:audioplayers/audioplayers.dart';
import 'functions.dart';
import 'ble_screen.dart';
import 'device_settings_screen.dart';
import 'sensor_data_screen.dart';
import 'servo_tester_screen.dart';
import 'export_settings_screen.dart';
import 'package:flutter/services.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  // Ekranı dikey konumda kilitle
  SystemChrome.setPreferredOrientations([
    DeviceOrientation.portraitUp,
    DeviceOrientation.portraitDown,
  ]).then((_) {
    runApp(MyApp());
  });
}

const String targetServiceUuid = "b5f90001-aa8d-11e3-9046-0002a5d5c51b";
//const String writeCharacteristicUuid = "b5f90002-aa8d-11e3-9046-0002a5d5c51b";
//const String readCharacteristicUuid = "b5f90003-aa8d-11e3-9046-0002a5d5c51b";

const String bleuart_tx_characteristic = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
const String bleuart_rx_characteristic = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";

const String firmwareListUrl =
    "https://raw.githubusercontent.com/melihkarakelle/FlexiTimer_Files/refs/heads/main/ftlist.json";

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: BLEFormApp(),
    );
  }
}

class BLEFormApp extends StatefulWidget {
  const BLEFormApp({super.key});

  @override
  _BLEFormAppState createState() => _BLEFormAppState();
}

class _BLEFormAppState extends State<BLEFormApp> with WidgetsBindingObserver {
  // FlutterBluePlus instance'ını kaldır
  BluetoothCharacteristic? writeCharacteristic;
  BluetoothCharacteristic? readCharacteristic;
  String? localHtmlPath;
  late WebViewController webViewController;
  List<Map<String, dynamic>> firmwares = [];
  String? selectedHtmlUrl;
  String receivedData = '';
  String _incomingData = ''; // Gelen parçaları birleştirmek için buffer

  // Bağlantı durumu izleme
  bool isConnected = false;
  bool isReconnecting = false;
  bool isManualDisconnect = false; // Manuel disconnect durumu
  bool isManualConnecting = false; // Manuel bağlanma sırasında true
  DateTime? lastManualConnectionTime; // Son manuel bağlantı zamanı
  StreamSubscription<BluetoothConnectionState>? _connectionStateSubscription; // Connection monitoring subscription

  // BLE device name
  String deviceBLEName = "FlexiTimer-Default";

  // HTML download race condition prevention
  bool _isDownloadingHtml = false;

  // Audio player instance
  final AudioPlayer _audioPlayer = AudioPlayer();

  // Ses çalma fonksiyonu
  Future<void> _playConnectionSound() async {
    try {
      await _audioPlayer.stop(); // Önce mevcut sesi durdur
      await _audioPlayer.play(AssetSource('connected.wav'));
      print("Bağlantı sesi çalındı");
    } catch (e) {
      print("Ses çalma hatası: $e");
    }
  }

  // Bağlantı kopma sesi çalma fonksiyonu
  Future<void> _playDisconnectionSound() async {
    try {
      await _audioPlayer.stop(); // Önce mevcut sesi durdur
      await _audioPlayer.play(AssetSource('disconnected.wav'));
      print("Bağlantı kopma sesi çalındı");
    } catch (e) {
      print("Ses çalma hatası: $e");
    }
  }

  // Son bağlanan cihazın MAC adresini kaydet
  Future<void> _saveLastDeviceId(String deviceId) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('last_device_id', deviceId);
    print("Son bağlanan cihaz kaydedildi: $deviceId");
  }

  // Son bağlanan cihazın MAC adresini yükle
  Future<String?> _loadLastDeviceId() async {
    final prefs = await SharedPreferences.getInstance();
    final deviceId = prefs.getString('last_device_id');
    print("Kaydedilmiş cihaz ID: $deviceId");
    return deviceId;
  }

  // Kaydedilmiş cihaz ID'sini sil
  Future<void> _clearLastDeviceId() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('last_device_id');
    print("Kaydedilmiş cihaz ID silindi");
  }


  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);

    // WebViewController'ı sadece bir kez initialize et
    webViewController = WebViewController();
    webViewController.setJavaScriptMode(JavaScriptMode.unrestricted);
    webViewController.setBackgroundColor(const Color(0xFF000000));

    // JavaScript channel'ı sadece bir kez ekle
    try {
      // Form data channel - artık tüm JSON gelecek
      webViewController.addJavaScriptChannel(
        'FormChannel',
        onMessageReceived: (JavaScriptMessage message) {
          print("📥 Full JSON received from HTML");
          sendFullJsonToBLE(message.message);
        },
      );
    } catch (e) {
      print('JavaScript channel initialization error: $e');
    }

    // HTML güncellendiğinde WebView'ı yenileme callback'i
    onHtmlUpdated = () {
      if (mounted) {
        setState(() {
          // WebView'ı yeniden yükle
          webViewController.loadHtmlString(initialHTML);
        });

        // HTML yüklendikten sonra TÜM JSON'u gönder (preset seçimi HTML içinde yapılacak)
        Future.delayed(Duration(milliseconds: 500), () {
          if (mounted && deviceJsonConfig != null) {
            print("📤 HTML yüklendi, tüm JSON gönderiliyor...");
            loadFullJsonToHtml();
            print("✅ Tüm JSON HTML'e gönderildi");
          }
        });
      }
    };

    // Başlatma işlemlerini sıralı olarak yap
    _initializeApp();
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    readCharacteristic?.lastValueStream.listen(null); // Dinleyiciyi temizle
    _connectionStateSubscription?.cancel(); // Connection state subscription'ı temizle
    isReconnecting = false; // Yeniden bağlanma işlemini durdur
    _audioPlayer.dispose(); // Audio player'ı temizle
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    super.didChangeAppLifecycleState(state);
    print("App lifecycle changed: $state");

    // Otomatik reconnect devre dışı - sadece manuel bağlantı
    switch (state) {
      case AppLifecycleState.resumed:
        print("App resumed - otomatik bağlantı yok, sadece manuel");
        break;
      case AppLifecycleState.paused:
        print("App paused");
        break;
      case AppLifecycleState.inactive:
        print("App inactive");
        break;
      case AppLifecycleState.detached:
        print("App detached");
        break;
      default:
        break;
    }
  }

  void _checkAndReconnect() async {
    print("=== CHECKING CONNECTION AFTER APP RESUME ===");

    // Manuel bağlantı devam ediyorsa veya yeni bitmiş ise, otomatik kontrolü atla
    if (isManualConnecting) {
      print("🔵 Manuel bağlantı devam ediyor, _checkAndReconnect iptal edildi");
      return;
    }

    if (lastManualConnectionTime != null) {
      final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
      if (timeSinceManual.inSeconds < 10) {
        print("🔵 Manuel bağlantıdan ${timeSinceManual.inSeconds} saniye geçti, _checkAndReconnect iptal edildi");
        return;
      }
    }

    if (connectedDevice != null) {
      try {
        // Bağlantı durumunu kontrol et
        bool isDeviceConnected = connectedDevice!.isConnected;
        print("Device connected status: $isDeviceConnected");

        if (isDeviceConnected) {
          // Bağlantı var ama karakteristikler kaybolmuş olabilir
          print("Device connected but checking characteristics...");

          if (readCharacteristic == null || writeCharacteristic == null) {
            print("Characteristics lost, rediscovering...");
            _rediscoverServices(connectedDevice!);
          } else {
            // Karakteristikler var, GET komutunu tekrar gönder
            print("Characteristics OK, sending GET command...");
            Future.delayed(Duration(seconds: 1), () {
              sendGetCommand();
            });
          }
        } else {
          // Bağlantı kopmuş, yeniden bağlan
          print("Device disconnected, attempting reconnection...");
          setState(() {
            isConnected = false;
            isReconnecting = true;
          });

          connectToDevice(connectedDevice!);
        }
      } catch (e) {
        print("Error checking connection: $e");
        // Hata durumunda otomatik reconnect başlat
        setState(() {
          isConnected = false;
          connectedDevice = null;
        });
        startReconnect();
      }
    } else {
      print("No connected device, starting scan...");
      startReconnect();
    }
  }

  Future<void> _initializeApp() async {
    try {
      // Sadece firmware listesini yükle
      await _loadFirmwareList();

      print("✅ Uygulama başlatıldı - otomatik bağlantı YOK, sadece manuel bağlantı");
    } catch (e) {
      print("Uygulama başlatma hatası: $e");
    }
  }

  Future<void> _loadFirmwareList() async {
    try {
      await fetchFirmwareList(firmwareListUrl, (jsonString) {
        try {
          final jsonData = jsonDecode(jsonString);
          if (mounted) {
            setState(() {
              firmwares = (jsonData['firmwares'] as List).map((item) {
                return {
                  "firmware_name": item['firmware_name'],
                  "html_link": item['html_link']
                };
              }).toList();
            });
          }
          print(
              "Firmware listesi başarıyla yüklendi: ${firmwares.length} firmware");
        } catch (e) {
          print("Firmware listesi parse hatası: $e");
        }
      });
    } catch (e) {
      print("Firmware listesi yükleme hatası: $e");
    }
  }

  void _startBLEConnection() async {
    // Manuel disconnect durumunda otomatik bağlanma yapma
    if (isManualDisconnect) {
      print(
          "Manuel disconnect durumunda olduğu için _startBLEConnection iptal edildi");
      return;
    }

    // Manuel bağlantı devam ediyorsa veya yeni bitmiş ise, otomatik bağlanmayı atla
    if (isManualConnecting) {
      print("🔵 Manuel bağlantı devam ediyor, _startBLEConnection iptal edildi");
      return;
    }

    if (lastManualConnectionTime != null) {
      final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
      if (timeSinceManual.inSeconds < 10) {
        print("🔵 Manuel bağlantıdan ${timeSinceManual.inSeconds} saniye geçti, _startBLEConnection iptal edildi");
        return;
      }
    }

    // Kaydedilmiş cihaz ID'sini yükle
    final savedDeviceId = await _loadLastDeviceId();

    if (savedDeviceId != null) {
      print("Kaydedilmiş cihaz ID bulundu: $savedDeviceId");
      print("Kaydedilmiş cihaza otomatik bağlanma başlatılıyor...");
      _reconnectToSavedDevice(savedDeviceId);
    } else if (connectedDevice != null) {
      print("Son bağlanılan cihaza bağlanılıyor: ${connectedDevice!.name}");
      connectToDevice(connectedDevice!);
    } else {
      // Son bağlanılan cihaz yoksa, otomatik bağlanma yapma
      print("Kaydedilmiş cihaz bulunamadı, otomatik bağlanma yapılmıyor");
    }
  }

  // Kaydedilmiş cihaza yeniden bağlanma
  void _reconnectToSavedDevice(String deviceId) async {
    try {
      if (await FlutterBluePlus.isOn) {
        print("Bluetooth açık, kaydedilmiş cihaz aranıyor...");
        await FlutterBluePlus.stopScan();
        await FlutterBluePlus.startScan(timeout: Duration(seconds: 8));

        FlutterBluePlus.scanResults.listen((results) async {
          // Manuel disconnect durumunda bağlanma
          if (isManualDisconnect) {
            print(
                "🚫 _reconnectToSavedDevice: Manuel disconnect durumunda - bağlanma iptal edildi");
            return;
          }

          // Manuel bağlantı kontrolü
          if (isManualConnecting) {
            print("🔵 Manuel bağlantı devam ediyor, _reconnectToSavedDevice iptal edildi");
            return;
          }

          if (lastManualConnectionTime != null) {
            final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
            if (timeSinceManual.inSeconds < 10) {
              print("🔵 Manuel bağlantıdan ${timeSinceManual.inSeconds} saniye geçti, _reconnectToSavedDevice iptal edildi");
              return;
            }
          }

          for (ScanResult r in results) {
            if (r.device.remoteId.toString() == deviceId) {
              print(
                  "Kaydedilmiş cihaz bulundu: ${r.device.platformName} ($deviceId)");
              await FlutterBluePlus.stopScan();
              connectToDevice(r.device);
              break;
            }
          }
        });
      }
    } catch (e) {
      print("Kaydedilmiş cihaza bağlanma hatası: $e");
    }
  }

  void parseFirmwareList(String jsonString) {
    final jsonData = jsonDecode(jsonString);
    setState(() {
      firmwares = (jsonData['firmwares'] as List).map((item) {
        return {
          "firmware_name": item['firmware_name'],
          "html_link": item['html_link']
        };
      }).toList();
      // HTML'i otomatik açma kısmını kaldırdık
      // if (firmwares.isNotEmpty) {
      //   selectedHtmlUrl = firmwares[0]['html_link'];
      //   downloadHtmlForm(selectedHtmlUrl);
      // }
    });
  }

  void startReconnect() async {
    try {
      // Manuel disconnect durumunda otomatik yeniden bağlanma yapma
      if (isManualDisconnect) {
        print(
            "Manuel disconnect durumunda olduğu için startReconnect iptal edildi");
        return;
      }

      // Manuel bağlantı devam ediyorsa, otomatik reconnect'i iptal et
      if (isManualConnecting) {
        print("🔵 Manuel bağlantı devam ediyor, otomatik reconnect iptal edildi");
        return;
      }

      // Son manuel bağlantıdan 10 saniye geçmemişse, otomatik reconnect'i ertele
      if (lastManualConnectionTime != null) {
        final timeSinceManual = DateTime.now().difference(lastManualConnectionTime!);
        if (timeSinceManual.inSeconds < 10) {
          print("🔵 Manuel bağlantıdan ${timeSinceManual.inSeconds} saniye geçti, otomatik reconnect 10 saniyeye ertelendi");
          Future.delayed(Duration(seconds: 10 - timeSinceManual.inSeconds), () {
            startReconnect();
          });
          return;
        }
      }

      // Bluetooth'un açık olup olmadığını kontrol et
      if (await FlutterBluePlus.isOn) {
        print("Bluetooth açık, cihazlar taranıyor...");

        // Önceki taramaları durdur
        await FlutterBluePlus.stopScan();

        // Yakındaki cihazları tara (timeout artırıldı)
        await FlutterBluePlus.startScan(timeout: Duration(seconds: 8));

        // Tarama sonuçlarını dinle
        FlutterBluePlus.scanResults.listen((results) async {
          for (ScanResult r in results) {
            // Manuel disconnect durumunda bağlanma
            if (isManualDisconnect) {
              print(
                  "Manuel disconnect durumunda olduğu için otomatik bağlanma iptal edildi");
              await FlutterBluePlus.stopScan();
              return;
            }

            // Sadece son bağlanan cihazın MAC adresine bağlan
            if (connectedDevice != null &&
                r.device.remoteId == connectedDevice!.remoteId) {
              print(
                  "Son bağlı cihaz bulundu: ${r.device.platformName} (${r.device.remoteId})");
              await FlutterBluePlus.stopScan();
              connectToDevice(r.device);
              break;
            }
          }
        });

        // 10 saniye sonra taramayı durdurup yeniden dene
        Future.delayed(Duration(seconds: 10), () async {
          if (connectedDevice == null) {
            print("Cihaz bulunamadı, yeniden deneniyor...");
            startReconnect();
          }
        });
      } else {
        print("Bluetooth kapalı!");
        // Bluetooth açılmasını bekle
        Future.delayed(Duration(seconds: 2), () {
          startReconnect();
        });
      }
    } catch (e) {
      print("Bağlantı hatası: $e");
      // Hata durumunda 3 saniye bekleyip yeniden dene
      Future.delayed(Duration(seconds: 3), () {
        startReconnect();
      });
    }
  }

  void connectToDevice(BluetoothDevice device, {bool isManual = false}) async {
    try {
      // Manuel bağlantı başlıyorsa, flag'i set et ve manuel disconnect flag'ini temizle
      if (isManual) {
        print("🔵 MANUEL BAĞLANTI BAŞLIYOR");
        isManualConnecting = true;
        isManualDisconnect = false; // Manuel bağlantıya başlarken temizle
        lastManualConnectionTime = DateTime.now();
      }

      // Eğer başka bir cihaza bağlıysa, önce ondan disconnect ol
      if (connectedDevice != null &&
          connectedDevice!.remoteId != device.remoteId) {
        print(
            '⚠️ Farklı cihaza geçiş yapılıyor: ${connectedDevice!.platformName} -> ${device.platformName}');
        print('⚠️ Önce mevcut cihazdan disconnect olunuyor...');
        try {
          await connectedDevice!.disconnect();
          print('✓ Eski cihazdan disconnect başarılı');
          await Future.delayed(Duration(milliseconds: 500));
        } catch (e) {
          print("⚠️ Eski cihazdan disconnect hatası: $e");
        }
      }

      // Yeni cihazı disconnect et (emin olmak için)
      try {
        await device.disconnect();
      } catch (e) {
        print("Disconnect hatası (normal): $e");
      }

      // Yeni bağlantı kur
      await device.connect(autoConnect: false, timeout: Duration(seconds: 10));
      setState(() {
        connectedDevice = device;
        isConnected = true;
        isReconnecting = false;
        isManualDisconnect = false; // Otomatik bağlantıda da sıfırla
      });

      // Cihaz ID'sini kaydet
      await _saveLastDeviceId(device.remoteId.toString());

      print("Manuel bağlantı kuruldu, isManualDisconnect sıfırlandı");

      // Bağlantı durumunu izle
      _startConnectionMonitoring(device);

      // Servisleri keşfet
      List<BluetoothService> services = await device.discoverServices();
      bool txFound = false, rxFound = false;

      for (BluetoothService service in services) {
        for (BluetoothCharacteristic characteristic
            in service.characteristics) {
          if (characteristic.uuid == Guid(bleuart_tx_characteristic)) {
            writeCharacteristic = characteristic;
            txFound = true;
            print("TX karakteristiği bulundu");
          } else if (characteristic.uuid == Guid(bleuart_rx_characteristic)) {
            readCharacteristic = characteristic;
            rxFound = true;
            print("RX karakteristiği bulundu");
          }
        }
      }

      if (!txFound || !rxFound) {
        print(
            "Gerekli karakteristikler bulunamadı! TX: $txFound, RX: $rxFound");
        throw Exception("BLE karakteristikleri bulunamadı");
      }

      // RX notification'ı hemen aktif et (firmware veri göndermeden önce)
      print("🔔 RX notification aktif ediliyor...");
      listenToBLEData();

      print("BLE bağlantısı başarılı!");

      // Otomatik bağlantıda da ses çal (manuel bağlantı gibi)
      _playConnectionSound();

      // Manuel bağlantı tamamlandı, flag'i sıfırla
      if (isManualConnecting) {
        print("🔵 MANUEL BAĞLANTI TAMAMLANDI");
        isManualConnecting = false;
      }

      // NOT: GET komutu GÖNDERMİYORUZ
      // Firmware zaten connect_callback() içinde otomatik olarak JSON gönderiyor:
      // 1. DEVICE_INFO (delay 1000ms sonra)
      // 2. JSON_START + JSON data + JSON_END (delay 100ms sonra)
      // 3. LOAD_HTML (delay 100ms sonra)
      // Bu otomatik gönderim yeterli, GET komutu gereksiz ve çift gönderime yol açar
      print("✅ Bağlantı tamamlandı - firmware otomatik veri gönderecek");
    } catch (e) {
      print("❌ Bağlantı hatası: $e");

      // Manuel bağlantı başarısız oldu, flag'i sıfırla
      if (isManualConnecting) {
        print("🔵 MANUEL BAĞLANTI BAŞARISIZ");
        isManualConnecting = false;
      }

      // Otomatik reconnect KALDIRILDI - kullanıcı manuel olarak tekrar denemeli
      print("❌ Bağlantı başarısız - otomatik reconnect YOK");
    }
  }

  // Genel BLE komut gönderme fonksiyonu (prefix olmadan, chunking destekli)
  void sendBleCommand(String command, {bool useChunking = false}) async {
    if (writeCharacteristic != null) {
      try {
        // Komutun sonunda \n yoksa ekle
        String cmd = command.endsWith('\n') ? command : command + '\n';
        List<int> bytes = utf8.encode(cmd);

        if (useChunking && bytes.length > 244) {
          // Büyük veriler için chunking kullan (SET_PRESET gibi)
          print("📤 BLE komutu gönderiliyor (chunked): ${cmd.substring(0, 50)}... (${bytes.length} bytes)");
          int chunkSize = 244;
          for (var i = 0; i < bytes.length; i += chunkSize) {
            var end = (i + chunkSize < bytes.length) ? i + chunkSize : bytes.length;
            var chunk = bytes.sublist(i, end);
            await writeCharacteristic!.write(chunk, withoutResponse: true);
            // Parçalar arası kısa bir bekleme ekle
            await Future.delayed(Duration(milliseconds: 100));
          }
          print("✅ Chunked veri gönderildi");
        } else {
          // Küçük komutlar için tek seferde gönder
          await writeCharacteristic!.write(bytes, withoutResponse: false);
          print("📤 BLE komutu gönderildi: ${cmd.length < 100 ? cmd.trim() : '${cmd.substring(0, 50)}... (${bytes.length} bytes)'}");
        }
      } catch (e) {
        print("❌ BLE komutu gönderme hatası: $e");
      }
    } else {
      print("❌ HATA: Write karakteristiği bulunamadı!");
    }
  }

  void sendGetCommand() async {
    sendBleCommand("GET");
  }

  // Bağlantı durumunu izleyen fonksiyon
  void _startConnectionMonitoring(BluetoothDevice device) {
    // Eski subscription varsa iptal et (birden fazla listener önleme)
    _connectionStateSubscription?.cancel();
    print("🔄 Connection monitoring başlatılıyor (eski listener iptal edildi)");

    // Cihazın bağlantı durumunu izle
    _connectionStateSubscription = device.connectionState.listen((BluetoothConnectionState state) {
      print("Bağlantı durumu değişti: $state");

      if (state == BluetoothConnectionState.disconnected) {
        // Manuel disconnect durumunu kontrol et
        print(
            "Disconnect oldu! isManualDisconnectRequested: $isManualDisconnectRequested, isManualDisconnect: $isManualDisconnect");

        if (isManualDisconnectRequested) {
          isManualDisconnect = true;
          isManualDisconnectRequested = false; // Durumu sıfırla
          print("Manuel disconnect olarak işaretlendi");
          // NOT: _clearLastDeviceId zaten BLE ekranından callback ile çağrılıyor
        }

        print("Cihaz bağlantısı koptu! Manuel disconnect: $isManualDisconnect");

        // Bağlantı kopma sesi çal
        _playDisconnectionSound();

        setState(() {
          isConnected = false;
          connectedDevice = null;
          writeCharacteristic = null;
          readCharacteristic = null;
        });

        // Otomatik yeniden bağlanma KALDIRILDI - sadece manuel bağlantı
        print("❌ Cihaz bağlantısı koptu - otomatik reconnect YOK");
      } else if (state == BluetoothConnectionState.connected) {
        print("✅ Cihaz bağlandı!");
        setState(() {
          isConnected = true;
          connectedDevice = device;
        });
      }
    });
  }

  // Otomatik yeniden bağlanma fonksiyonu
  void _startAutoReconnect(BluetoothDevice device) {
    setState(() {
      isReconnecting = true;
    });

    print("Otomatik yeniden bağlanma başlatıldı...");

    // 2 saniye bekle ve yeniden bağlanmayı dene
    Future.delayed(Duration(seconds: 2), () {
      if (!isConnected && isReconnecting) {
        _attemptReconnect(device);
      }
    });
  }

  // Yeniden bağlanma denemesi
  void _attemptReconnect(BluetoothDevice device) async {
    if (isConnected) return; // Zaten bağlıysa çık

    try {
      print("Yeniden bağlanma deneniyor: ${device.name}");
      await device.connect(autoConnect: false, timeout: Duration(seconds: 5));

      // Bağlantı başarılı
      setState(() {
        connectedDevice = device;
        isConnected = true;
        isReconnecting = false;
        // isManualDisconnect durumunu otomatik yeniden bağlanmada sıfırlamıyoruz
        // Sadece manuel bağlanmada sıfırlanacak
      });

      print(
          "Otomatik yeniden bağlanma başarılı, isManualDisconnect: $isManualDisconnect");

      // Otomatik yeniden bağlanmada da ses çal
      _playConnectionSound();

      // Servisleri yeniden keşfet
      _rediscoverServices(device);
    } catch (e) {
      print("Yeniden bağlanma başarısız: $e");

      // 5 saniye bekle ve tekrar dene
      Future.delayed(Duration(seconds: 5), () {
        if (!isConnected && isReconnecting) {
          _attemptReconnect(device);
        }
      });
    }
  }

  // Servisleri yeniden keşfetme fonksiyonu
  void _rediscoverServices(BluetoothDevice device) async {
    try {
      List<BluetoothService> services = await device.discoverServices();
      bool txFound = false, rxFound = false;

      for (BluetoothService service in services) {
        for (BluetoothCharacteristic characteristic
            in service.characteristics) {
          if (characteristic.uuid == Guid(bleuart_tx_characteristic)) {
            writeCharacteristic = characteristic;
            txFound = true;
            print("TX karakteristiği yeniden bulundu");
          } else if (characteristic.uuid == Guid(bleuart_rx_characteristic)) {
            readCharacteristic = characteristic;
            rxFound = true;
            print("RX karakteristiği yeniden bulundu");
            listenToBLEData();
          }
        }
      }

      if (txFound && rxFound) {
        print("Servisler yeniden keşfedildi, GET komutu gönderiliyor...");
        Future.delayed(Duration(seconds: 1), () {
          sendGetCommand();
        });
      }
    } catch (e) {
      print("Servis keşfetme hatası: $e");
    }
  }

  void listenToBLEData() async {
    if (readCharacteristic != null) {
      try {
        // BLE notification kurulumunu bekle ve doğrula
        bool success = await readCharacteristic!.setNotifyValue(true);
        if (!success) {
          print("❌ BLE notification kurulamadı!");
          return;
        }
        print("✅ BLE notification başarıyla aktifleştirildi");

        // Notification'ların Bluetooth stack'te tamamen hazır olması için bekle
        // Firmware 2+ saniye sonra veri göndermeye başlayacağı için bu süre yeterli
        await Future.delayed(Duration(milliseconds: 200));
        print("✅ BLE notifications hazır - veri dinleme başlıyor");

        readCharacteristic!.lastValueStream.listen((value) {
          try {
            // Boş veri gelirse ignore et
            if (value.isEmpty) {
              print("Boş BLE verisi alındı, ignore ediliyor");
              return;
            }

            String bleData = String.fromCharCodes(value);
            print("=== BLE VERI ALINDI ===");
            print("Raw bytes: $value");
            print("Decoded string: '$bleData'");
            print("Data length: ${bleData.length}");

            setState(() {
              receivedData = receivedData + bleData;

              // Gelen veriyi buffer'a ekle
              _incomingData += bleData;

              // Eğer veri \n içeriyorsa, satır satır işle
              if (_incomingData.contains("\n")) {
                List<String> lines = _incomingData.split("\n");

                // Son satır tam değilse buffer'da tut
                if (!_incomingData.endsWith("\n")) {
                  _incomingData = lines.removeLast();
                } else {
                  _incomingData = "";
                }

                // Tam olan satırları işle
                for (String line in lines) {
                  if (line.isEmpty) continue;

                  try {
                    // DEVICE_INFO: komutu gelirse cihaz bilgilerini parse et
                    if (line.startsWith("DEVICE_INFO:")) {
                      String info =
                          line.substring(12); // "DEVICE_INFO:" uzunluğu 12
                      List<String> infoParts = info.split(',');

                      for (String part in infoParts) {
                        List<String> keyValue = part.split('=');
                        if (keyValue.length == 2) {
                          String key = keyValue[0].trim();
                          String value = keyValue[1].trim();

                          if (key == 'model') {
                            deviceModel = value;
                          } else if (key == 'firmware') {
                            deviceFirmware = value;
                          } else if (key == 'hardware') {
                            deviceHardware = value;
                          } else if (key == 'serial') {
                            deviceSerial = value;
                          }
                        }
                      }
                      print(
                          "Device Info - Model: $deviceModel, Firmware: $deviceFirmware, Hardware: $deviceHardware, Serial: $deviceSerial");
                    }
                    // NOT: LOAD_HTML komutu artık kullanılmıyor - HTML bilgisi JSON içinde "load-html" field'ında geliyor
                    // JSON alma başlangıcı
                    else if (line == "JSON_START") {
                      print("📦 JSON alımı başlıyor...");
                      isReceivingJson = true;
                      receivedJsonBuffer = '';
                    }
                    // JSON alma bitişi
                    else if (line == "JSON_END") {
                      print("✅ JSON alımı tamamlandı");
                      isReceivingJson = false;
                      parseDeviceJson();
                    }
                    // JSON verisi geliyor
                    else if (isReceivingJson) {
                      receivedJsonBuffer += line;
                    }
                    // TELEMETRY: ile başlıyorsa sensor verilerini parse et (sadece sensor ekranı açıkken)
                    else if (line.startsWith("TELEMETRY:") &&
                        isSensorScreenActive) {
                      String values =
                          line.substring(10); // "TELEMETRY:" uzunluğu 10
                      List<String> parts = values.split(',');

                      // Format: TELEMETRY:gx,gy,gz,ax,ay,az,press,alt,mx,my,mz,batt,sw1,sw2,sw3,roll,pitch,heading
                      if (parts.length >= 18) {
                        sensorGyroX = double.tryParse(parts[0]) ?? 0.0;
                        sensorGyroY = double.tryParse(parts[1]) ?? 0.0;
                        sensorGyroZ = double.tryParse(parts[2]) ?? 0.0;
                        sensorAccelX = double.tryParse(parts[3]) ?? 0.0;
                        sensorAccelY = double.tryParse(parts[4]) ?? 0.0;
                        sensorAccelZ = double.tryParse(parts[5]) ?? 0.0;
                        // Pressure comes in Pa, convert to mbar (hPa) by dividing by 100
                        sensorPressure =
                            (double.tryParse(parts[6]) ?? 0.0) / 100.0;
                        sensorAltitude = double.tryParse(parts[7]) ?? 0.0;
                        sensorMagX = double.tryParse(parts[8]) ?? 0.0;
                        sensorMagY = double.tryParse(parts[9]) ?? 0.0;
                        sensorMagZ = double.tryParse(parts[10]) ?? 0.0;
                        sensorBatteryVoltage =
                            double.tryParse(parts[11]) ?? 0.0;
                        sensorSwitch1 = parts[12] == "1";
                        sensorSwitch2 = parts[13] == "1";
                        sensorSwitch3 = parts[14] == "1";
                        sensorAHRSRoll = double.tryParse(parts[15]) ?? 0.0;
                        sensorAHRSPitch = double.tryParse(parts[16]) ?? 0.0;
                        sensorAHRSHeading = double.tryParse(parts[17]) ?? 0.0;
                        sensorLastUpdate =
                            DateTime.now().toString().substring(11, 19);
                        lastTelemetryReceived =
                            DateTime.now(); // Update last received time
                        print("📊 Telemetry data updated: $sensorLastUpdate");
                      }
                    }
                    // JSON kaydetme başarılı
                    else if (line == "JSON_SAVED_OK") {
                      print("✅ Firmware JSON'u başarıyla kaydetti");
                      // HTML'e başarı bildirimini gönder
                      webViewController.runJavaScript('''
                        if (typeof onSaveComplete === 'function') {
                          onSaveComplete(true);
                        }
                      ''');
                    }
                    // JSON kaydetme hatası
                    else if (line.startsWith("JSON_ERROR")) {
                      print("❌ Firmware JSON kaydetme hatası: $line");
                      // HTML'e hata bildirimini gönder
                      webViewController.runJavaScript('''
                        if (typeof onSaveComplete === 'function') {
                          onSaveComplete(false);
                        }
                      ''');
                    }
                  } catch (e) {
                    print("Satır işleme hatası: $e, Satır: $line");
                  }
                }
              }
            });
          } catch (e) {
            print("BLE veri işleme hatası: $e");
          }
        }, onError: (error) {
          print("BLE veri dinleme hatası: $error");
          // Hata durumunda bağlantıyı yeniden kur
          Future.delayed(Duration(seconds: 2), () {
            if (connectedDevice != null) {
              connectToDevice(connectedDevice!);
            }
          });
        });
      } catch (e) {
        print("BLE notification ayarlama hatası: $e");
      }
    } else {
      print("readCharacteristic null!");
    }
  }

  // JSON'ı parse et ve preset listesini oluştur
  void parseDeviceJson() async {
    try {
      print("📝 JSON parsing başlıyor...");
      print("Buffer boyutu: ${receivedJsonBuffer.length}");

      deviceJsonConfig = json.decode(receivedJsonBuffer);

      // JSON'dan load-html field'ını oku ve HTML'i yükle
      if (deviceJsonConfig != null && deviceJsonConfig!['load-html'] != null) {
        String htmlFileName = deviceJsonConfig!['load-html'];
        print("📄 JSON'dan HTML dosya adı alındı: $htmlFileName");

        // HTML'i indir (eğer zaten indirme devam etmiyorsa)
        if (!_isDownloadingHtml) {
          _isDownloadingHtml = true;
          String htmlUrl = "https://raw.githubusercontent.com/melihkarakelle/FlexiTimer_Files/main/htmls/$htmlFileName";
          print("📥 HTML indiriliyor: $htmlUrl");

          downloadHtmlForm(htmlUrl).then((_) {
            _isDownloadingHtml = false;
            print("✅ HTML indirildi ve yüklendi");
          }).catchError((error) {
            print("❌ HTML download hatası: $error");
            _isDownloadingHtml = false;
          });
        }
      }

      if (deviceJsonConfig != null && deviceJsonConfig!['presets'] != null) {
        presetsList = List<Map<String, dynamic>>.from(deviceJsonConfig!['presets']);
        print("✅ ${presetsList.length} preset bulundu");
        setState(() {}); // UI güncelle
      }
    } catch (e) {
      print("❌ JSON parse hatası: $e");
      print("Buffer içeriği: $receivedJsonBuffer");
    }
  }

  // Tüm JSON'u HTML'e gönder (preset seçimi HTML içinde yapılacak)
  void processBLEDataAndSendToForm(Map<String, dynamic> presetData) {
    // DEPRECATED: Artık kullanılmıyor, loadFullJsonToHtml() kullanılıyor
    // Bu fonksiyon geriye dönük uyumluluk için bırakıldı
    if (presetData.isEmpty) return;

    // Eski mantık: tek preset gönder
    Map<String, dynamic> dataWithModel = {
      'model-name': deviceJsonConfig?['model-name'] ?? 'Unknown',
      ...presetData,
    };

    String jsonString = jsonEncode(dataWithModel)
        .replaceAll('\\', '\\\\')
        .replaceAll("'", "\\'")
        .replaceAll('\n', '\\n')
        .replaceAll('\r', '\\r');

    final script = '''
      if (typeof loadPresetDataFromJSON === 'function') {
        loadPresetDataFromJSON('$jsonString');
      } else {
        console.error('❌ loadPresetDataFromJSON function not found in HTML');
      }
    ''';

    webViewController.runJavaScript(script);
  }

  // Tüm cihaz JSON'unu HTML'e yükle (yeni metod)
  void loadFullJsonToHtml() {
    if (deviceJsonConfig == null) {
      print("❌ Device JSON config yok, HTML'e gönderilemiyor");
      return;
    }

    // Tüm JSON'u escape et ve gönder
    String jsonString = jsonEncode(deviceJsonConfig)
        .replaceAll('\\', '\\\\')
        .replaceAll("'", "\\'")
        .replaceAll('\n', '\\n')
        .replaceAll('\r', '\\r');

    print("📤 Tüm JSON HTML'e gönderiliyor (${jsonString.length} chars)");

    // HTML içindeki initializeWithFullJson fonksiyonunu çağır
    final script = '''
      if (typeof initializeWithFullJson === 'function') {
        console.log('📥 Full JSON received from Flutter');
        initializeWithFullJson('$jsonString');
      } else {
        console.error('❌ initializeWithFullJson function not found in HTML');
      }
    ''';

    webViewController.runJavaScript(script);
  }

  // Preset ismini güncelleyen fonksiyon
  void sendFormDataToBLE(String formData) async {
    //receivedData = receivedData + formData;
    if (writeCharacteristic != null) {
      //print("Gönderilen Form Verisi: $formData");
      // SET_PRESET komutu büyük olduğu için chunking kullan
      sendBleCommand("SET_PRESET:$formData,", useChunking: true);
    }
  }

  // HTML'den gelen tüm JSON'u BLE ile firmware'e gönder
  void sendFullJsonToBLE(String jsonString) async {
    if (writeCharacteristic == null) {
      print("❌ Write characteristic null, cannot send JSON");
      return;
    }

    try {
      // JSON'u parse edelim (validation için)
      var jsonData = json.decode(jsonString);
      print("✅ Valid JSON received from HTML");
      print("   - Presets count: ${jsonData['presets']?.length ?? 0}");
      print("   - Selected index: ${jsonData['selected-preset-index']}");

      // Tüm JSON'u firmware'e yaz
      print("📤 Sending WRITE_JSON command with full configuration...");

      String command = "WRITE_JSON:$jsonString\n";
      sendBleCommand(command, useChunking: true);

      print("✅ Full JSON command sent");

      // Local deviceJsonConfig'i de güncelle
      setState(() {
        deviceJsonConfig = jsonData;
      });

    } catch (e) {
      print("❌ Error processing JSON: $e");
    }
  }

  void openBLEScreen() async {
    // Eğer cihaz bağlıysa önce disconnect onayı iste
    if (isConnected && connectedDevice != null) {
      if (!mounted) return;

      bool? shouldDisconnect = await showDialog<bool>(
        context: context,
        barrierDismissible: false,
        builder: (BuildContext context) {
          return AlertDialog(
            backgroundColor: Color(0xFF1E1E1E),
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
              side: BorderSide(color: Color(0xFF444444), width: 1),
            ),
            title: Row(
              children: [
                Icon(Icons.bluetooth_disabled, color: Color(0xFFFF5252), size: 24),
                SizedBox(width: 10),
                Expanded(
                  child: Text(
                    'Disconnect Device?',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
            content: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  'Currently connected to:',
                  style: TextStyle(
                    color: Color(0xFF999999),
                    fontSize: 14,
                  ),
                ),
                SizedBox(height: 8),
                Container(
                  width: double.infinity,
                  padding: EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Color(0xFF2D2D2D),
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: Color(0xFF2196F3), width: 2),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.bluetooth_connected, color: Color(0xFF2196F3), size: 24),
                      SizedBox(width: 10),
                      Expanded(
                        child: Text(
                          connectedDevice!.platformName,
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                            fontFamily: 'monospace',
                          ),
                        ),
                      ),
                    ],
                  ),
                ),
                SizedBox(height: 16),
                Text(
                  'Do you want to disconnect and scan for other devices?',
                  style: TextStyle(
                    color: Color(0xFFCCCCCC),
                    fontSize: 14,
                  ),
                ),
              ],
            ),
            actionsPadding: EdgeInsets.fromLTRB(16, 8, 16, 12),
            actionsAlignment: MainAxisAlignment.end,
            actions: [
              // Cancel button
              OutlinedButton(
                style: OutlinedButton.styleFrom(
                  foregroundColor: Color(0xFF999999),
                  side: BorderSide(color: Color(0xFF555555), width: 1),
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                onPressed: () => Navigator.pop(context, false),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.close, size: 18),
                    SizedBox(width: 6),
                    Text(
                      'CANCEL',
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
              SizedBox(width: 12),
              // Disconnect button
              ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xFFFF5252),
                  foregroundColor: Colors.white,
                  padding: EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                  elevation: 3,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8),
                  ),
                ),
                onPressed: () => Navigator.pop(context, true),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.bluetooth_disabled, size: 18),
                    SizedBox(width: 6),
                    Text(
                      'DISCONNECT',
                      style: TextStyle(
                        fontSize: 13,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          );
        },
      );

      // Kullanıcı iptal ettiyse çık
      if (shouldDisconnect != true) return;

      // Disconnect ve saved device'ı temizle
      isManualDisconnect = true;
      await connectedDevice!.disconnect();
      await _clearLastDeviceId();

      if (!mounted) return;
      setState(() {
        connectedDevice = null;
        isConnected = false;
      });
    }

    // BLE ekranını aç
    if (!mounted) return;
    final wasConnected = connectedDevice != null;
    final result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => BLEDevicesScreen(
          onDeviceSelected: (device) {
            connectToDevice(device, isManual: true); // Manuel bağlantı
          },
          lastConnectedDevice: connectedDevice,
          onManualDisconnect: () async {
            // Manuel disconnect flag'ini hemen ayarla
            isManualDisconnect = true;
            isManualDisconnectRequested = true;
            print("🚫 Manuel disconnect flag'leri ayarlandı");

            // Devam eden taramaları durdur
            try {
              await FlutterBluePlus.stopScan();
              print("🚫 BLE taraması durduruldu");
            } catch (e) {
              print("Tarama durdurma hatası: $e");
            }

            // SharedPreferences'ı temizle (await ile bekle)
            await _clearLastDeviceId();
            print("🚫 SharedPreferences temizlendi");
          },
        ),
      ),
    );

    if (!mounted) return;
    if (result != null && result is BluetoothDevice) {
      setState(() {
        connectedDevice = result;
      });
    } else if (wasConnected && connectedDevice == null) {
      setState(() {}); // Force a rebuild if disconnected
    }
  }

  void openDeviceSettings() async {
    // Eğer cihaz bağlıysa gerçek BLE adını kullan, yoksa varsayılanı
    String currentName = deviceBLEName;
    if (connectedDevice != null && connectedDevice!.platformName.isNotEmpty) {
      currentName = connectedDevice!.platformName;
      print("🔧 Using connected device name: '$currentName'");
    } else {
      print("🔧 Using default device name: '$currentName'");
      print("🔧 connectedDevice: ${connectedDevice != null ? 'exists' : 'null'}");
      if (connectedDevice != null) {
        print("🔧 platformName: '${connectedDevice!.platformName}'");
      }
    }

    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => DeviceSettingsScreen(
          currentBLEName: currentName,
          connectedDevice: connectedDevice,
          onBLENameChanged: (newName) {
            setState(() {
              deviceBLEName = "FlexiTimer-$newName";
            });
            _sendBLENameToDevice(newName);
          },
          onFactoryReset: isConnected ? factoryReset : null,
        ),
      ),
    );
  }

  void factoryReset() async {
    if (!isConnected || writeCharacteristic == null) {
      print("❌ Factory reset çağrıldı ama bağlantı yok!");
      return;
    }

    print("🏭 Factory reset komutu gönderiliyor...");
    sendBleCommand("FACTORY_RESET");

    // Cihaz reset olacak, bağlantı kopacak
    // UI'ı güncellemek için kısa bir gecikme sonra disconnect durumunu ayarla
    Future.delayed(Duration(seconds: 2), () {
      if (mounted) {
        setState(() {
          isConnected = false;
          connectedDevice = null;
        });
      }
    });
  }

  void openServoTesterScreen() async {
    if (connectedDevice == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Önce bir cihaza bağlanın!")),
      );
      return;
    }

    // Uyarı dialogu göster
    bool? confirm = await showDialog<bool>(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          title: Text('Servo Tester Mode'),
          content: Text(
            'When you exit Servo Tester mode, FlexiTimer will restart.\n\n'
            'Any unsaved configuration changes will be lost.\n\n'
            'Do you want to continue?',
            style: TextStyle(fontSize: 14),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(false),
              child: Text('Cancel', style: TextStyle(color: Colors.grey)),
            ),
            TextButton(
              onPressed: () => Navigator.of(context).pop(true),
              child: Text('Continue', style: TextStyle(color: Colors.blue)),
            ),
          ],
        );
      },
    );

    // Kullanıcı onayladıysa servo tester'ı aç
    if (confirm == true) {
      await Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => ServoTesterScreen(device: connectedDevice!),
        ),
      );
    }
  }

  void openSensorDataScreen() async {
    if (connectedDevice == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Önce bir cihaza bağlanın!")),
      );
      return;
    }

    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => SensorDataScreen(
          device: connectedDevice!,
        ),
      ),
    );
  }

  void exportSettings() async {
    // JSON verisini kontrol et
    if (receivedJsonBuffer.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text("No configuration data available. Connect to a device first."),
          backgroundColor: Color(0xFFFF5252),
        ),
      );
      return;
    }

    // Export Settings ekranını aç
    await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ExportSettingsScreen(
          jsonConfig: receivedJsonBuffer,
        ),
      ),
    );
  }

  void _sendBLENameToDevice(String newName) async {
    if (writeCharacteristic != null) {
      // BLE cihazına yeni device name'i gönder
      String command = "SET_BLE_NAME:$newName\n";
      List<int> bytes = utf8.encode(command);
      await writeCharacteristic!.write(bytes, withoutResponse: true);
      print("BLE device name sent: $newName");
    }
  }

  // dispose fonksiyonu zaten yukarda tanımlı

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Color(0xFF1A1A1A), // Koyu gri arkaplan
      body: Column(
        children: [
          // Timer Connected ve SCAN butonu
          Container(
            padding: EdgeInsets.fromLTRB(16, 45, 16, 4),
            decoration: BoxDecoration(
              color: Color(0xFF000000),
              boxShadow: [
                BoxShadow(
                  color: Colors.black26,
                  blurRadius: 2,
                  offset: Offset(0, 1),
                ),
              ],
            ),
            child: Row(
              children: [
                // Menu butonu
                GestureDetector(
                  onTap: () {
                    showMenu(
                      context: context,
                      position: RelativeRect.fromLTRB(0, 80, 0, 0),
                      items: [
                        PopupMenuItem(
                          child: Row(
                            children: [
                              Icon(Icons.settings, size: 18),
                              SizedBox(width: 8),
                              Text('Settings'),
                            ],
                          ),
                          onTap: () {
                            Future.delayed(Duration.zero, openDeviceSettings);
                          },
                        ),
                        PopupMenuItem(
                          enabled: isConnected,
                          child: Row(
                            children: [
                              Icon(
                                Icons.sensors,
                                size: 18,
                                color: isConnected ? null : Colors.grey,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Sensor Data',
                                style: TextStyle(
                                  color: isConnected ? null : Colors.grey,
                                ),
                              ),
                            ],
                          ),
                          onTap: isConnected
                              ? () {
                                  Future.delayed(
                                      Duration.zero, openSensorDataScreen);
                                }
                              : null,
                        ),
                        PopupMenuItem(
                          enabled: isConnected,
                          child: Row(
                            children: [
                              Icon(
                                Icons.tune,
                                size: 18,
                                color: isConnected ? null : Colors.grey,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Servo Tester',
                                style: TextStyle(
                                  color: isConnected ? null : Colors.grey,
                                ),
                              ),
                            ],
                          ),
                          onTap: isConnected
                              ? () {
                                  Future.delayed(
                                      Duration.zero, openServoTesterScreen);
                                }
                              : null,
                        ),
                        PopupMenuItem(
                          enabled: isConnected,
                          child: Row(
                            children: [
                              Icon(
                                Icons.file_download,
                                size: 18,
                                color: isConnected ? null : Colors.grey,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Export Settings',
                                style: TextStyle(
                                  color: isConnected ? null : Colors.grey,
                                ),
                              ),
                            ],
                          ),
                          onTap: isConnected
                              ? () {
                                  Future.delayed(Duration.zero, exportSettings);
                                }
                              : null,
                        ),
                      ],
                    );
                  },
                  child: Container(
                    padding: EdgeInsets.all(6),
                    child: Icon(
                      Icons.menu,
                      color: Colors.white,
                      size: 40,
                    ),
                  ),
                ),
                // Bağlı cihaz adı (responsive text)
                Expanded(
                  child: Center(
                    child: Text(
                      isConnected && connectedDevice != null
                          ? connectedDevice!.platformName
                          : '',
                      style: TextStyle(
                        color: Color(0xFFFFFFFF),
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        fontFamily: 'monospace',
                        letterSpacing: 0.5,
                      ),
                      overflow: TextOverflow.ellipsis,
                      maxLines: 1,
                      textAlign: TextAlign.center,
                    ),
                  ),
                ),
                // BLE butonu (renk bağlantı durumuna göre)
                GestureDetector(
                  onTap: openBLEScreen,
                  child: Container(
                    padding: EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: isConnected
                          ? Color(0xFF66BB6A)  // Yeşil (bağlı) - renk körü dostu
                          : Color(0xFFEF5350), // Kırmızı (bağlı değil) - renk körü dostu
                      borderRadius: BorderRadius.circular(8),
                      boxShadow: [
                        BoxShadow(
                          color: (isConnected ? Color(0xFF66BB6A) : Color(0xFFEF5350))
                              .withValues(alpha: 0.3),
                          blurRadius: 8,
                          spreadRadius: 1,
                        ),
                      ],
                    ),
                    child: Icon(
                      isConnected
                          ? Icons.bluetooth_connected
                          : Icons.bluetooth_searching,
                      color: isConnected ? Colors.black : Colors.white,
                      size: 20,
                    ),
                  ),
                ),
              ],
            ),
          ),
          // Ana İçerik - HTML WebView
          Expanded(
            child: Container(
              decoration: BoxDecoration(
                color: Color(0xFF000000), // Siyah arka plan
              ),
              child: !isConnected ? _buildConnectionPrompt() : _buildWebView(),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildConnectionPrompt() {
    return Center(
      child: Container(
        margin: EdgeInsets.all(32),
        padding: EdgeInsets.all(24),
        decoration: BoxDecoration(
          color: Color(0xFF2D2D2D),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(color: Color(0xFF444444), width: 2),
          boxShadow: [
            BoxShadow(
              color: Colors.black26,
              blurRadius: 8,
              offset: Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // İkon duruma göre değişir
            Icon(
              isReconnecting
                  ? Icons.bluetooth_searching
                  : Icons.bluetooth_disabled,
              size: 64,
              color: isReconnecting ? Color(0xFFFFAA00) : Color(0xFFFF5252),
            ),
            SizedBox(height: 16),
            // Başlık duruma göre değişir
            Text(
              isReconnecting ? "Reconnecting..." : "FlexiTimer Not Connected",
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: Colors.white,
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 8),
            // Açıklama duruma göre değişir
            Text(
              isReconnecting
                  ? "Trying to reconnect to your FlexiTimer device..."
                  : "Please connect to your FlexiTimer device to configure settings",
              style: TextStyle(
                fontSize: 16,
                color: Color(0xFFCCCCCC),
              ),
              textAlign: TextAlign.center,
            ),
            SizedBox(height: 24),
            // Buton sadece yeniden bağlanmıyorsa gösterilir
            if (!isReconnecting)
              ElevatedButton.icon(
                onPressed: openBLEScreen,
                icon: Icon(Icons.bluetooth_searching, size: 24),
                label: Text(
                  "SCAN FOR DEVICES",
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Color(0xFFFFD700),
                  foregroundColor: Color(0xFF000000),
                  padding: EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                  elevation: 4,
                ),
              ),
            // Yeniden bağlanma durumunda progress indicator
            if (isReconnecting)
              CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Color(0xFFFFAA00)),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildWebView() {
    return Container(
      margin: EdgeInsets.zero,
      decoration: BoxDecoration(
        color: Color(0xFF000000),
        borderRadius: BorderRadius.zero,
      ),
      child: WebViewWidget(
        controller: webViewController,
      ),
    );
  }
}
